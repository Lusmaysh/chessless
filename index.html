<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kingdom Chess</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Chess Logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Medieval Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --wood-dark: #2b1d0e;
        --wood-light: #5d4037;
        --gold: #c5a059;
        --gold-dim: #8a6e3e;
        --parchment: #e6d2b5;
      }
      body {
        font-family: "Cinzel", serif;
        background-color: #1a120b;
        background-image: radial-gradient(
          circle at center,
          #2c1e14 0%,
          #0f0a06 100%
        );
        color: var(--parchment);
        overflow: hidden;
        touch-action: none;
      }

      .medieval-panel {
        background: var(--wood-dark);
        border: 2px solid var(--gold-dim);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.8),
          inset 0 0 20px rgba(0, 0, 0, 0.5);
        position: relative;
      }
      .medieval-btn {
        background: linear-gradient(to bottom, #5d4037, #3e2723);
        border: 2px solid var(--gold-dim);
        color: var(--parchment);
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
        box-shadow: 0 4px 0 #271914;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .medieval-btn:active {
        transform: translateY(4px);
        box-shadow: 0 0 0 #271914;
      }
      .medieval-btn.primary {
        background: linear-gradient(to bottom, #b8860b, #8b6508);
        color: #1a0f00;
        border-color: #ffd700;
      }
      .medieval-btn.danger {
        background: linear-gradient(to bottom, #8b0000, #500000);
        border-color: #ff4444;
      }
      .medieval-btn.selected {
        border-color: #ffd700;
        background: #8b6508;
        box-shadow: inset 0 0 10px #000;
        color: #fff;
      }
      .medieval-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .medieval-input {
        background: #1a120b;
        border: 2px solid var(--gold-dim);
        color: var(--gold);
        font-family: "MedievalSharp", cursive;
      }

      /* --- FIXED BOARD CONTAINER & BOARD (BULLETPROOF V2) --- */
      .board-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        flex-grow: 1; /* Mengisi sisa ruang vertikal */
        min-height: 0;
        padding: 0;
        overflow: hidden;
      }

      .chess-board {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(8, 1fr);

        aspect-ratio: 1/1;

        /* MAGIC FORMULA: Ambil nilai terkecil antara 95% lebar atau 55% tinggi viewport */
        width: min(95vw, 55vh);
        height: min(95vw, 55vh);

        margin: 0 auto;
        border: 4px solid #3e2723;
        border-image: linear-gradient(#5d4037, #2b1d0e) 1;
        background-color: #334155;
        user-select: none;
        position: relative;
        touch-action: none;
        box-shadow: none;
      }

      /* Desktop Adjustment */
      @media (min-width: 768px) {
        .board-container {
          height: 80vh;
          padding: 10px;
        }
        .chess-board {
          width: min(75vh, 600px);
          height: min(75vh, 600px);
          border-width: 8px;
          max-width: none;
          max-height: none;
        }
      }

      #arrow-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 20;
      }
      .square {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        width: 100%;
        height: 100%;
        z-index: 1;
      }
      .square.white {
        background-color: #e3c193;
      }
      .square.black {
        background-color: #8b5a2b;
      }
      .square.selected {
        box-shadow: inset 0 0 0 4px #ffd700;
      }
      .square.last-move {
        box-shadow: inset 0 0 0 4px rgba(100, 255, 100, 0.6);
      }
      .square.premove-source {
        background-color: rgba(220, 38, 38, 0.5) !important;
      }
      .square.premove-dest {
        background-color: rgba(220, 38, 38, 0.5) !important;
        box-shadow: inset 0 0 0 2px #ffaaaa;
      }
      .square.in-check {
        background: radial-gradient(
          ellipse at center,
          #8b0000 0%,
          transparent 70%
        ) !important;
      }
      .square.possible-move::after {
        content: "";
        width: 25%;
        height: 25%;
        background-color: rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        position: absolute;
        pointer-events: none;
        z-index: 2;
      }
      .piece {
        width: 100%;
        height: 100%;
        background-size: 90%;
        background-repeat: no-repeat;
        background-position: center;
        cursor: grab;
        z-index: 10;
        touch-action: none; /* Mencegah scroll/zoom native saat sentuh bidak */
        -webkit-tap-highlight-color: transparent; /* Hilangkan kedip biru saat tap */
      }
      .piece.dragging {
        opacity: 0.5;
      }
      #drag-ghost {
        position: fixed;
        width: 60px;
        height: 60px;
        background-size: contain;
        background-repeat: no-repeat;
        pointer-events: none;
        z-index: 9999;
        display: none;
        transform: translate(-50%, -50%);
      }
      .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(4px);
      }
      .timer-box {
        font-family: monospace;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        background: #1a0f00;
        border: 1px solid #5d4037;
        width: 70px;
        text-align: center;
      }
      .timer-active {
        background: #3e2723;
        border-color: #ffd700;
        color: #ffd700;
        box-shadow: 0 0 5px #ffd700;
      }
      .active-history {
        background-color: var(--gold-dim);
        color: #fff;
      }
      .lobby-tab {
        opacity: 0.5;
        border-bottom: 4px solid transparent;
        transition: all 0.3s;
      }
      .lobby-tab.active {
        opacity: 1;
        border-bottom: 4px solid var(--gold);
        background: rgba(197, 160, 89, 0.1);
      }
    </style>
  </head>
  <body class="h-screen w-screen flex flex-col" oncontextmenu="return false;">
    <div id="drag-ghost"></div>

    <!-- MODALS -->
    <div id="modal-create" class="modal-overlay hidden">
      <div
        class="medieval-panel p-6 max-w-md w-full text-center rounded-lg m-4"
      >
        <h2 class="text-xl mb-4 border-b border-yellow-900/50 pb-2">
          Buat Pertempuran
        </h2>
        <div class="grid grid-cols-2 gap-4 text-left">
          <div>
            <label class="block text-[10px] text-yellow-600 mb-1 font-bold"
              >PASUKAN</label
            >
            <div class="flex gap-1 mb-4">
              <button
                onclick="selectColor('white')"
                id="btn-color-white"
                class="flex-1 medieval-btn p-2"
              >
                <i class="fas fa-chess-king text-white"></i>
              </button>
              <button
                onclick="selectColor('random')"
                id="btn-color-random"
                class="flex-1 medieval-btn p-2 selected"
              >
                <i class="fas fa-random"></i>
              </button>
              <button
                onclick="selectColor('black')"
                id="btn-color-black"
                class="flex-1 medieval-btn p-2"
              >
                <i class="fas fa-chess-king text-black"></i>
              </button>
            </div>
            <div id="ai-settings" class="hidden">
              <label class="block text-[10px] text-yellow-600 mb-1 font-bold"
                >KEKUATAN MUSUH</label
              >
              <select
                id="ai-elo"
                class="w-full medieval-input p-2 rounded text-xs text-center mb-4"
              >
                <option value="0">Pemula</option>
                <option value="5">Menengah</option>
                <option value="10">Ahli</option>
                <option value="15">Master</option>
                <option value="20">Grandmaster</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-[10px] text-yellow-600 mb-1 font-bold"
              >WAKTU (MENIT)</label
            >
            <div class="grid grid-cols-2 gap-1 mb-2">
              <button
                onclick="selectTime(1)"
                id="btn-time-1"
                class="medieval-btn p-2 text-xs"
              >
                1
              </button>
              <button
                onclick="selectTime(3)"
                id="btn-time-3"
                class="medieval-btn p-2 text-xs"
              >
                3
              </button>
              <button
                onclick="selectTime(5)"
                id="btn-time-5"
                class="medieval-btn p-2 text-xs"
              >
                5
              </button>
              <button
                onclick="selectTime(10)"
                id="btn-time-10"
                class="medieval-btn p-2 text-xs selected"
              >
                10
              </button>
              <button
                onclick="selectTime(30)"
                id="btn-time-30"
                class="medieval-btn p-2 text-xs"
              >
                30
              </button>
              <button
                onclick="selectTime(-1)"
                id="btn-time--1"
                class="medieval-btn p-2 text-xs"
              >
                âˆž
              </button>
            </div>
          </div>
        </div>
        <div class="flex gap-2 mt-4">
          <button
            onclick="closeModal('modal-create')"
            class="flex-1 medieval-btn py-2"
          >
            Batal
          </button>
          <button
            id="btn-create-start"
            onclick="confirmCreateGame()"
            class="flex-1 medieval-btn primary py-2"
          >
            Mulai
          </button>
        </div>
      </div>
    </div>

    <div id="modal-gameover" class="modal-overlay hidden">
      <div class="medieval-panel p-8 max-w-sm w-full text-center rounded-lg">
        <h2 id="go-title" class="text-2xl mb-2">Selesai</h2>
        <p id="go-message" class="text-slate-300 mb-6 font-medieval">...</p>
        <div class="flex flex-col gap-3">
          <button
            onclick="startAnalysisFromModal()"
            class="medieval-btn primary py-3 rounded"
          >
            Analisis
          </button>
          <button
            onclick="closeModal('modal-gameover'); exitGame();"
            class="medieval-btn py-3 rounded"
          >
            Kembali
          </button>
        </div>
      </div>
    </div>

    <div id="modal-confirm" class="modal-overlay hidden">
      <div class="medieval-panel p-6 max-w-sm w-full text-center rounded-lg">
        <h3 id="modal-title" class="text-lg mb-2">Konfirmasi</h3>
        <p id="modal-message" class="text-slate-300 mb-6 font-medieval">...</p>
        <div class="flex gap-3 justify-center">
          <button id="modal-no-btn" class="medieval-btn px-4 py-2 rounded">
            Batal
          </button>
          <button
            id="modal-yes-btn"
            class="medieval-btn danger px-4 py-2 rounded"
          >
            Ya
          </button>
        </div>
      </div>
    </div>

    <div id="modal-request" class="modal-overlay hidden">
      <div class="medieval-panel p-6 max-w-sm w-full text-center rounded-lg">
        <h3 id="req-title" class="text-xl mb-2">Permintaan</h3>
        <p id="req-message" class="text-slate-300 mb-6 font-medieval">...</p>
        <div class="flex gap-3 justify-center">
          <button
            onclick="respondRequest(false)"
            class="medieval-btn danger px-4 py-2 rounded"
          >
            Tolak
          </button>
          <button
            onclick="respondRequest(true)"
            class="medieval-btn primary px-4 py-2 rounded"
          >
            Terima
          </button>
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <nav
      class="bg-[#1a0f00] px-3 py-2 shadow-lg flex justify-between items-center h-[50px] shrink-0 border-b-2 border-[#3e2723] z-50"
    >
      <div class="flex items-center gap-2">
        <i class="fas fa-chess-knight text-yellow-600 text-lg"></i>
        <h1 class="text-base tracking-widest text-[#c5a059] hidden sm:block">
          Kingdom Chess
        </h1>
      </div>
      <div class="flex items-center gap-2">
        <button
          id="sound-toggle"
          onclick="toggleSound()"
          class="text-[#8a6e3e] hover:text-[#c5a059] px-2"
        >
          <i class="fas fa-volume-up"></i>
        </button>
        <div
          id="connection-status"
          class="text-[9px] px-2 py-0.5 rounded bg-black/50 text-green-500 border border-green-900"
        >
          ...
        </div>
        <span
          id="user-display"
          class="text-xs text-[#e6d2b5] font-bold truncate max-w-[80px]"
        ></span>
        <button
          onclick="logout()"
          class="text-[10px] bg-[#3e2723] px-2 py-1 rounded text-[#e6d2b5] border border-[#5d4037]"
        >
          Keluar
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main
      class="flex-1 relative w-full h-full overflow-hidden flex flex-col md:flex-row"
    >
      <!-- LOGIN -->
      <div
        id="screen-login"
        class="absolute inset-0 z-[60] flex flex-col items-center justify-center p-4 bg-black/90"
      >
        <div class="medieval-panel p-8 max-w-xs w-full text-center rounded-lg">
          <i class="fas fa-shield-alt text-5xl text-yellow-600 mb-4"></i>
          <h2 class="text-2xl mb-1">Kingdom Chess</h2>
          <input
            type="text"
            id="username-input"
            class="w-full medieval-input rounded p-2 mb-4 text-center mt-4 outline-none"
            placeholder="Nama Anda..."
          />
          <button
            onclick="handleLogin()"
            class="w-full medieval-btn primary py-2 rounded font-bold shadow-lg"
          >
            Masuk
          </button>
        </div>
      </div>

      <!-- LOBBY -->
      <div
        id="screen-lobby"
        class="absolute inset-0 hidden flex flex-col z-[50] p-4"
      >
        <div class="w-full max-w-6xl mx-auto flex flex-col h-full">
          <div
            class="medieval-panel p-3 rounded-lg mb-4 flex justify-between items-center shrink-0"
          >
            <span class="text-yellow-600 font-bold text-sm">Aula Utama</span>
            <div class="flex gap-2">
              <button
                onclick="openCreateGameModal('ai')"
                class="medieval-btn px-3 py-1.5 rounded text-xs shadow"
              >
                <i class="fas fa-robot mr-1"></i>VS AI
              </button>
              <button
                onclick="openCreateGameModal('human')"
                class="medieval-btn primary px-3 py-1.5 rounded text-xs shadow"
              >
                <i class="fas fa-users mr-1"></i>Buat
              </button>
            </div>
          </div>
          <div class="flex mb-2 gap-2 shrink-0 md:hidden">
            <button
              onclick="switchLobbyTab('arena')"
              id="tab-btn-arena"
              class="lobby-tab active flex-1 medieval-btn p-2 rounded font-bold text-center text-xs"
            >
              <i class="fas fa-chess-board mr-1"></i> ARENA
            </button>
            <button
              onclick="switchLobbyTab('history')"
              id="tab-btn-history"
              class="lobby-tab flex-1 medieval-btn p-2 rounded font-bold text-center text-xs"
            >
              <i class="fas fa-history mr-1"></i> RIWAYAT
            </button>
          </div>
          <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
            <div
              id="lobby-panel-arena"
              class="flex-1 flex flex-col medieval-panel rounded-lg overflow-hidden"
            >
              <div
                class="p-3 bg-[#1a0f00] border-b border-[#5d4037] flex justify-between items-center"
              >
                <span class="text-yellow-600 font-bold text-sm"
                  >Daftar Room</span
                ><span class="text-[10px] text-stone-500">Auto-refresh</span>
              </div>
              <div
                id="room-list"
                class="flex-1 overflow-y-auto p-3 space-y-2 bg-[#23170f]"
              ></div>
            </div>
            <div
              id="lobby-panel-history"
              class="hidden md:flex flex-1 flex-col medieval-panel rounded-lg overflow-hidden"
            >
              <div
                class="p-3 bg-[#1a0f00] border-b border-[#5d4037] text-yellow-600 font-bold text-sm"
              >
                Jejak Pertempuran
              </div>
              <div
                id="history-list"
                class="flex-1 overflow-y-auto p-3 space-y-2 bg-[#23170f]"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <!-- GAME -->
      <div
        id="screen-game"
        class="absolute inset-0 hidden flex flex-col md:flex-row z-[40]"
      >
        <div
          class="flex-1 flex flex-col items-center justify-center relative min-h-0 bg-[#15100d]"
        >
          <div
            class="w-full max-w-[80vh] flex justify-between items-end mb-1 px-2 mt-2"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded bg-[#2b1d0e] border border-[#5d4037] flex items-center justify-center text-yellow-600"
              >
                <i class="fas fa-user"></i>
              </div>
              <div>
                <span
                  id="opponent-name"
                  class="font-bold text-xs block text-[#e6d2b5] truncate max-w-[100px]"
                  >Lawan</span
                ><span
                  id="game-status"
                  class="text-[10px] text-yellow-500 font-mono"
                ></span>
              </div>
            </div>
            <!-- FIXED ID: timer-opponent -->
            <div id="timer-opponent" class="timer-box text-white">--:--</div>
          </div>

          <div class="board-container">
            <div id="chess-board" class="chess-board rounded-sm"></div>
          </div>

          <div
            class="w-full max-w-[80vh] flex justify-between items-start mt-1 px-2 mb-2"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded bg-[#2b1d0e] border border-[#c5a059] flex items-center justify-center text-yellow-400"
              >
                <i class="fas fa-user"></i>
              </div>
              <div>
                <span
                  id="player-name-display"
                  class="font-bold text-xs block text-[#c5a059] truncate max-w-[100px]"
                  >Anda</span
                ><span id="turn-indicator" class="text-[10px] text-stone-400"
                  >...</span
                >
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="flipBoard()" class="text-[#8a6e3e]">
                <i class="fas fa-sync-alt"></i>
              </button>
              <!-- FIXED ID: timer-self -->
              <div id="timer-self" class="timer-box text-white">--:--</div>
            </div>
          </div>
          <div
            class="md:hidden w-full flex justify-around p-2 bg-[#2b1d0e] border-t border-[#5d4037]"
          >
            <button
              onclick="reqTakeback()"
              class="text-stone-400 hover:text-white"
            >
              <i class="fas fa-undo"></i>
            </button>
            <button onclick="reqDraw()" class="text-stone-400 hover:text-white">
              <i class="fas fa-handshake"></i>
            </button>
            <button
              onclick="confirmResign()"
              class="text-red-500 hover:text-red-400"
            >
              <i class="fas fa-flag"></i>
            </button>
          </div>
        </div>
        <div
          class="hidden md:flex w-[320px] medieval-panel border-l-4 border-[#2b1d0e] flex-col h-full shrink-0 z-20"
        >
          <div class="flex bg-[#1a0f00] border-b border-[#5d4037] shrink-0">
            <div
              class="flex-1 py-2 text-center text-xs font-bold text-[#c5a059] uppercase"
            >
              Langkah
            </div>
          </div>
          <div
            class="flex-1 overflow-y-auto bg-[#23170f] p-0 custom-scroll"
            id="pgn-container"
          >
            <table class="w-full text-sm text-left border-collapse">
              <tbody id="move-history" class="text-[#e6d2b5] font-mono"></tbody>
            </table>
          </div>
          <div class="bg-[#1a0f00] p-4 border-t border-[#5d4037] shrink-0">
            <div id="play-controls" class="grid grid-cols-2 gap-2">
              <button
                onclick="reqTakeback()"
                class="medieval-btn py-2 rounded text-xs"
              >
                Mundur
              </button>
              <button
                onclick="reqDraw()"
                class="medieval-btn py-2 rounded text-xs"
              >
                Remis
              </button>
              <button
                onclick="confirmResign()"
                class="medieval-btn danger col-span-2 py-2 rounded text-xs font-bold"
              >
                MENYERAH / BATAL
              </button>
            </div>
            <div id="analysis-controls" class="hidden flex-col gap-2">
              <div class="bg-[#2b1d0e] p-2 rounded border border-[#5d4037]">
                <div class="flex justify-between mb-1">
                  <span class="text-[10px] text-blue-400">EVAL</span
                  ><span id="eval-score" class="text-[10px]">0.0</span>
                </div>
                <div class="h-1 bg-black rounded-full overflow-hidden">
                  <div
                    id="eval-fill"
                    class="h-full bg-white"
                    style="width: 50%"
                  ></div>
                </div>
                <p
                  id="best-move-text"
                  class="text-[10px] text-center mt-1 text-[#c5a059]"
                >
                  ...
                </p>
              </div>
              <button
                onclick="exitGame()"
                class="w-full medieval-btn py-2 rounded text-xs"
              >
                KEMBALI
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // --- KONFIGURASI FIREBASE ---
      const firebaseConfig = {
        apiKey: "AIzaSyDmer19KTaijOz3bTdknEEs5dqwKNt6HQg",
        authDomain: "masjid-pekalongan.firebaseapp.com",
        projectId: "masjid-pekalongan",
        storageBucket: "masjid-pekalongan.firebasestorage.app",
        messagingSenderId: "619031365600",
        appId: "1:619031365600:web:35061354a11cf3f72e4d85",
        measurementId: "G-R511G99W8R",
      };
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {}
      const auth = firebase.auth(),
        db = firebase.firestore(),
        appId = "chess-v3-final";

      // --- VARIABEL GLOBAL ---
      let currentUser = null,
        currentGameId = null,
        gameData = null;
      let chess = new Chess(),
        boardOrientation = "white",
        playerColor = "white",
        stockfishWorker = null,
        gameUnsubscribe = null;
      let soundEnabled = true,
        selectedSquare = null,
        premoveQueue = [];

      // Variabel Drag & Drop
      let isDragging = false,
        dragStartSquare = null,
        draggedPieceElement = null;

      // Variabel Timer
      let whiteTime = 600,
        blackTime = 600,
        timerInterval = null,
        selectedTime = 10,
        lastTimestamp = null;

      // Variabel Lain
      let arrows = [],
        circleHighlights = [],
        isRightClicking = false,
        rightClickStart = null;
      let isAI = false,
        isAnalysisMode = false,
        viewHistoryIndex = -1,
        aiLevel = 5,
        aiTimeout = null;
      let windowPendingGameType = "human",
        selectedColor = "random";

      const isMobile =
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        );

      const audioFiles = {
        move: "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3",
        capture:
          "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3",
        check:
          "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/notify.mp3",
        start:
          "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-start.mp3",
        end: "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3",
      };
      function getPieceUrl(c, t) {
        return `https://images.chesscomfiles.com/chess-themes/pieces/neo/150/${c}${t}.png`;
      }

      // --- INISIALISASI ---
      async function initApp() {
        try {
          const b = await fetch(
            "https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js"
          ).then((r) => r.blob());
          stockfishWorker = new Worker(URL.createObjectURL(b));
          stockfishWorker.onmessage = handleStockfishMessage;
        } catch (e) {
          console.warn("Stockfish load failed");
        }

        const s = localStorage.getItem("chess_username");
        if (s) document.getElementById("username-input").value = s;

        auth.onAuthStateChanged((u) => {
          if (u) {
            currentUser = u;
            updateConnectionStatus(true);
            if (
              s &&
              !document
                .getElementById("screen-login")
                .classList.contains("hidden")
            )
              handleLogin();
          } else {
            updateConnectionStatus(false);
            auth.signInAnonymously();
          }
        });

        // Global Input Listeners (Untuk melepas Drag)
        document.addEventListener("mouseup", handleGlobalEnd);
        document.addEventListener("touchend", handleGlobalEnd);
        document.addEventListener("mousemove", handleGlobalMove);
        document.addEventListener("touchmove", handleGlobalMove, {
          passive: false,
        });
        document.addEventListener("contextmenu", (e) => e.preventDefault());
      }

      // --- INPUT SYSTEM (REVISI FINAL: MOBILE STABIL) ---

      // Variabel Input
      let startX = 0,
        startY = 0;
      let isClickCandidate = false; // Penanda apakah ini mungkin klik

      // 1. Start Input (Dipasang di elemen bidak)
      function attachInputListeners(element, square) {
        // Mouse Down
        element.addEventListener("mousedown", (e) => {
          if (e.button !== 0) return;
          e.preventDefault(); // Mencegah seleksi teks
          initInput(e.clientX, e.clientY, square, element);
        });

        // Touch Start (Pasif false agar bisa preventDefault scroling)
        element.addEventListener(
          "touchstart",
          (e) => {
            // JANGAN panggil e.preventDefault() di sini agar event click native mati
            // Kita handle "Click" manual nanti di Touchend
            const touch = e.touches[0];
            initInput(touch.clientX, touch.clientY, square, element);
          },
          { passive: false }
        );
      }

      function initInput(x, y, square, el) {
        if (!isAnalysisMode && viewHistoryIndex !== -1) return;

        // Reset Status
        isDragging = false;
        isClickCandidate = true; // Kita asumsikan ini klik dulu
        startX = x;
        startY = y;

        dragStartSquare = square;
        draggedPieceElement = el;

        // Siapkan Ghost tapi sembunyikan
        const ghost = document.getElementById("drag-ghost");
        if (ghost) {
          ghost.style.backgroundImage = el.style.backgroundImage;
          ghost.style.left = x + "px";
          ghost.style.top = y + "px";
          ghost.style.display = "none";
        }
      }

      // 2. Move Input (Global)
      function handleGlobalMove(e) {
        // Jika tidak ada potensi interaksi, abaikan
        if (!isClickCandidate && !isDragging) return;

        let clientX, clientY;
        if (e.type === "touchmove") {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }

        // Hitung jarak gerak dari titik awal
        const diffX = Math.abs(clientX - startX);
        const diffY = Math.abs(clientY - startY);

        // Ambang batas toleransi (5px). Jika gerak < 5px, masih dianggap "tahan jari diam"
        if (!isDragging && (diffX > 5 || diffY > 5)) {
          isDragging = true; // Resmi jadi DRAG
          isClickCandidate = false; // Batal jadi KLIK

          // Tampilkan Ghost
          const ghost = document.getElementById("drag-ghost");
          if (ghost) ghost.style.display = "block";
        }

        // Logika saat sedang Dragging
        if (isDragging) {
          if (e.cancelable && e.type === "touchmove") e.preventDefault(); // Matikan Scroll layar HP

          const ghost = document.getElementById("drag-ghost");
          if (ghost) {
            ghost.style.left = clientX + "px";
            ghost.style.top = clientY + "px";
          }
        }
      }

      // 3. End Input (Global)
      function handleGlobalEnd(e) {
        // Bersihkan UI Ghost
        const ghost = document.getElementById("drag-ghost");
        if (ghost) ghost.style.display = "none";

        // SKENARIO 1: KLIK MURNI (Jari diangkat tanpa geser jauh)
        if (isClickCandidate && !isDragging) {
          isClickCandidate = false;
          // Panggil logika klik manual
          if (dragStartSquare) {
            // Mainkan suara tap kecil opsional atau feedback visual
            onSquareClick(dragStartSquare);
          }
          dragStartSquare = null;
          return;
        }

        // SKENARIO 2: SELESAI DRAG (Drop)
        if (isDragging) {
          isDragging = false;
          isClickCandidate = false;

          // Cari koordinat drop
          let clientX, clientY;
          if (e.type === "touchend") {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }

          // Cari elemen kotak di bawah jari
          const elements = document.elementsFromPoint(clientX, clientY);
          const squareEl = elements.find((el) =>
            el.classList.contains("square")
          );

          if (squareEl) {
            const targetSquare = squareEl.dataset.square;
            if (targetSquare && targetSquare !== dragStartSquare) {
              handleMoveAttempt(dragStartSquare, targetSquare);
            } else {
              // Drop di kotak yang sama -> Anggap sebagai klik kedua (Deselect/Select)
              onSquareClick(targetSquare);
            }
          } else {
            // Drop di luar papan -> Deselect
            selectedSquare = null;
            renderBoard();
          }
        }

        // Reset Global
        dragStartSquare = null;
        draggedPieceElement = null;
      }

      // 4. Logika Interaksi Kotak (Logika Catur) - SAMA SEPERTI SEBELUMNYA
      function onSquareClick(square) {
        handleSquareInteraction(square);
      }

      function handleSquareInteraction(square, isStartPhase = false) {
        // Bersihkan highlight lama
        if (arrows.length > 0 || circleHighlights.length > 0)
          clearArrowsAndHighlights();

        const piece = chess.get(square);
        const myColor = playerColor.charAt(0);
        const isMyTurn = chess.turn() === myColor;

        // --- LOGIKA PREMOVE INPUT ---
        if (!isMyTurn && !isAnalysisMode) {
          // Jika sedang giliran lawan
          if (selectedSquare && selectedSquare !== square) {
            // Klik kedua (Tujuan Premove)
            handleMoveAttempt(selectedSquare, square);
            return;
          }
          // Klik pertama (Pilih bidak sendiri untuk dipremove)
          if (piece && piece.color === myColor) {
            selectedSquare = square;
            renderBoard();
          } else if (!isStartPhase) {
            // Klik kosong/musuh = Batalkan Premove
            premoveQueue = [];
            selectedSquare = null;
            renderBoard();
          }
          return;
        }

        // --- LOGIKA NORMAL INPUT ---
        if (selectedSquare && selectedSquare !== square) {
          // Coba gerak ke tujuan
          const pieceAtTarget = chess.get(square);
          // Jika klik bidak sendiri (Ganti seleksi), kecuali mode capture
          if (
            pieceAtTarget &&
            pieceAtTarget.color === myColor &&
            !isAnalysisMode
          ) {
            selectedSquare = square;
            renderBoard();
          } else {
            handleMoveAttempt(selectedSquare, square);
          }
        } else {
          // Seleksi awal
          if (piece && (piece.color === myColor || isAnalysisMode)) {
            selectedSquare = square;
            renderBoard();
          } else if (!isStartPhase) {
            selectedSquare = null;
            renderBoard();
          }
        }
      }

      // --- LOGIKA PERGERAKAN & PREMOVE ---
      function handleMoveAttempt(from, to) {
        if (isAnalysisMode) {
          if (chess.move({ from, to, promotion: "q" })) {
            renderBoard();
            updateMoveHistoryUI();
            playSound("move");
            if (stockfishWorker)
              stockfishWorker.postMessage("position fen " + chess.fen());
          }
          return;
        }

        const myColor = playerColor.charAt(0);

        // KONDISI 1: GILIRAN SAYA (Move Langsung)
        if (chess.turn() === myColor) {
          const move = chess.move({ from, to, promotion: "q" });
          selectedSquare = null;

          if (move) {
            clearArrowsAndHighlights();
            renderBoard();
            updateMoveHistoryUI();
            if (chess.in_check()) playSound("check");
            else if (move.flags.includes("c")) playSound("capture");
            else playSound("move");

            // --- FIX TIMER PENTING ---
            // Jangan reset waktu! Kirim whiteTime/blackTime saat ini ke DB
            if (isAI) {
              checkGameOver(true);
              setTimeout(makeAIMove, 500);
            } else {
              pushMoveToFirestore();
            }
          } else {
            // Illegal move
            renderBoard();
          }
        }
        // KONDISI 2: GILIRAN LAWAN (Premove)
        else {
          // Validasi Multi-Premove (Virtual Board)
          const tempChess = new Chess(chess.fen());

          // Replay antrian premove yang sudah ada
          for (let pm of premoveQueue) {
            forceTurn(tempChess, myColor);
            tempChess.move({ from: pm.from, to: pm.to, promotion: "q" });
          }

          // Cek langkah baru
          forceTurn(tempChess, myColor);
          const valid = tempChess.move({ from, to, promotion: "q" });

          if (valid) {
            premoveQueue.push({ from, to });
            selectedSquare = null;
            renderBoard();
          } else {
            selectedSquare = null;
            renderBoard();
          }
        }
      }

      function forceTurn(chessInstance, color) {
        const tokens = chessInstance.fen().split(" ");
        tokens[1] = color;
        chessInstance.load(tokens.join(" "));
      }

      function processPremoves() {
        if (premoveQueue.length === 0 || chess.game_over()) return;
        if (chess.turn() !== playerColor.charAt(0)) return;

        const moveData = premoveQueue[0];
        const move = chess.move({
          from: moveData.from,
          to: moveData.to,
          promotion: "q",
        });

        if (move) {
          premoveQueue.shift(); // Hapus dari antrian
          renderBoard();
          updateMoveHistoryUI();
          playSound("move");

          if (!isAI) {
            pushMoveToFirestore();
          } else {
            setTimeout(makeAIMove, 500);
          }
        } else {
          premoveQueue = []; // Batal jika illegal
          playSound("check");
          renderBoard();
        }
      }

      // --- TIMER & DATABASE ---

      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);

        // Jangan jalan jika analisis, atau online tapi status bukan playing
        if (
          isAnalysisMode ||
          (!isAI && gameData && gameData.status !== "playing") ||
          selectedTime === -1
        )
          return;

        // Set anchor lokal untuk AI
        lastTimestamp = Date.now();

        timerInterval = setInterval(
          () => {
            // --- JALUR 1: MODE AI (LOKAL) ---
            if (isAI) {
              const now = Date.now();
              const delta = Math.floor((now - lastTimestamp) / 1000);
              if (delta >= 1) {
                if (chess.turn() === "w") whiteTime -= 1;
                else blackTime -= 1;
                lastTimestamp = now;
                updateTimerDisplay();
              }
            }
            // --- JALUR 2: MODE ONLINE (DATABASE SYNC) ---
            else {
              // Pastikan data penting ada
              if (!gameData || !gameData.lastMove) return;

              // 1. Ambil Waktu 'Beku' dari Database
              // Jika undefined (awal game), gunakan batas waktu room
              const limit = (gameData.timeControl || 10) * 60;
              const dbWhiteTime =
                gameData.whiteTime !== undefined ? gameData.whiteTime : limit;
              const dbBlackTime =
                gameData.blackTime !== undefined ? gameData.blackTime : limit;

              // 2. Hitung berapa lama waktu berlalu sejak langkah TERAKHIR di DB
              const now = Date.now();
              const elapsedSeconds = Math.floor(
                (now - gameData.lastMove.t) / 1000
              );

              // 3. TERAPKAN LOGIKA GILIRAN (CRITICAL FIX)
              if (chess.turn() === "w") {
                // Putih sedang mikir: Waktu DB dikurangi waktu berjalan
                whiteTime = dbWhiteTime - elapsedSeconds;
                // Hitam menunggu: Waktu Hitam DIAM sesuai data DB terakhir
                blackTime = dbBlackTime;
              } else {
                // Hitam sedang mikir: Waktu DB dikurangi waktu berjalan
                blackTime = dbBlackTime - elapsedSeconds;
                // Putih menunggu: Waktu Putih DIAM sesuai data DB terakhir
                whiteTime = dbWhiteTime;
              }

              // Update UI
              updateTimerDisplay();
            }

            // Cek Game Over (Berlaku untuk keduanya)
            // Gunakan buffer -1 agar tidak kalah prematur karena lag koneksi
            if (whiteTime <= -1) handleFlagFall("white");
            if (blackTime <= -1) handleFlagFall("black");
          },
          isAI ? 1000 : 100
        ); // Online update sangat cepat (100ms) agar timer terlihat smooth
      }

      // GANTI FUNGSI INI
      async function handleFlagFall(colorWhoRanOutOfTime) {
        clearInterval(timerInterval);

        // Tentukan hasil dari sudut pandang SAYA
        // Jika yang habis waktu adalah warna SAYA, maka SAYA kalah ('loss')
        // Jika yang habis waktu adalah warna LAWAN, maka SAYA menang ('win')
        const myColor = playerColor.charAt(0) === "w" ? "white" : "black";
        const result = colorWhoRanOutOfTime === myColor ? "loss" : "win";

        handleGameOver(result);

        // Update ke Database agar lawan juga tahu game sudah selesai
        if (!isAI && currentGameId) {
          // Tentukan siapa pemenangnya (nama)
          const winnerColor =
            colorWhoRanOutOfTime === "white" ? "black" : "white";
          // Ambil nama dari data game yang ada
          const winnerName =
            winnerColor === "white"
              ? gameData.white
                ? gameData.white.name
                : "White"
              : gameData.black
              ? gameData.black.name
              : "Black";

          try {
            await db
              .collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                status: "finished",
                winner: winnerName,
                reason: "timeout", // Tambahkan alasan agar jelas
              });
          } catch (e) {
            console.error("Gagal update game over:", e);
          }
        }
      }

      // GANTI FUNGSI pushMoveToFirestore INI
      async function pushMoveToFirestore() {
        if (!currentGameId) return;

        // Saat mengirim langkah, kita kirim waktu LOKAL kita saat ini sebagai checkpoint.
        // Tapi kita kirim blackTime/whiteTime dari variable global yang sudah dihitung oleh startTimer

        await db
          .collection("artifacts")
          .doc(appId)
          .collection("public")
          .doc("data")
          .collection("games")
          .doc(currentGameId)
          .update({
            fen: chess.fen(),
            pgn: chess.pgn(),
            lastMove: { t: Date.now() }, // Waktu langkah ini dibuat

            // PENTING: Kirim sisa waktu TERBARU ke DB
            whiteTime: Math.ceil(whiteTime),
            blackTime: Math.ceil(blackTime),
          });

        checkGameOver(true);
      }

      // GANTI FUNGSI startGameFirestore INI
      function startGameFirestore(id, o) {
        setupGameCommon(id, o, "Menunggu...");
        if (gameUnsubscribe) gameUnsubscribe();

        gameUnsubscribe = db
          .collection("artifacts")
          .doc(appId)
          .collection("public")
          .doc("data")
          .collection("games")
          .doc(id)
          .onSnapshot((doc) => {
            if (!doc.exists) return;
            gameData = doc.data();

            const opp = o === "white" ? gameData.black : gameData.white;
            if (document.getElementById("opponent-name"))
              document.getElementById("opponent-name").innerText = opp
                ? opp.name
                : "Menunggu...";

            // --- SYNC WAKTU AWAL (Agar Guest tidak freeze/salah waktu) ---
            if (gameData.timeControl) selectedTime = gameData.timeControl;

            // Jika data waktu belum ada di DB (game baru), inisialisasi lokal
            const limit = selectedTime === -1 ? 999999 : selectedTime * 60;

            // Jangan timpa variable global jika sedang playing (biarkan startTimer yang handle)
            // Kecuali jika ini load pertama kali (status playing tapi timer lokal masih 0 atau error)
            if (!timerInterval || (whiteTime === 0 && blackTime === 0)) {
              whiteTime =
                gameData.whiteTime !== undefined ? gameData.whiteTime : limit;
              blackTime =
                gameData.blackTime !== undefined ? gameData.blackTime : limit;
              updateTimerDisplay();
            }
            // -------------------------------------------------------------

            if (gameData.status === "playing") {
              // Deteksi langkah baru dari lawan
              if (
                gameData.fen &&
                gameData.fen !== chess.fen() &&
                gameData.fen !== "start"
              ) {
                if (gameData.pgn) chess.load_pgn(gameData.pgn);
                else chess.load(gameData.fen);

                const last = chess.history({ verbose: true }).pop();
                if (chess.in_check()) playSound("check");
                else if (last && last.flags.includes("c")) playSound("capture");
                else playSound("move");

                renderBoard();
                updateMoveHistoryUI();

                // Cek Premove
                setTimeout(processPremoves, 100);
              }

              // Pastikan timer jalan
              if (!timerInterval) startTimer();
            }

            if (gameData.status === "finished" && !isAnalysisMode) {
              let r = "draw";
              if (gameData.winner !== "draw")
                r =
                  gameData.winner === localStorage.getItem("chess_username")
                    ? "win"
                    : "loss";
              handleGameOver(r);
            }
            if (
              gameData.requests?.status === "pending" &&
              gameData.requests.sender !== currentUser.uid
            )
              showRequestModal(gameData.requests.type);
          });
      }

      function setupGameCommon(id, o, n) {
        currentGameId = id;
        boardOrientation = o;
        playerColor = o;

        // Matikan timer lama
        if (timerInterval) clearInterval(timerInterval);

        // --- FIX: JANGAN SET WAKTU DISINI ---
        // Kita set 0 dulu, nanti akan di-update oleh startGameFirestore (dari DB)
        // atau startGameLocal (dari setting AI)
        whiteTime = 0;
        blackTime = 0;

        // Reset UI
        document.getElementById("timer-self").innerText = "--:--";
        document.getElementById("timer-opponent").innerText = "--:--";
        document.getElementById("timer-self").classList.remove("timer-active");
        document
          .getElementById("timer-opponent")
          .classList.remove("timer-active");

        // Reset Logic Game
        chess.reset();
        isAnalysisMode = false;
        premoveQueue = [];
        viewHistoryIndex = -1;
        selectedSquare = null;

        // Set Nama
        const elO = document.getElementById("opponent-name");
        const elM = document.getElementById("player-name-display");
        if (elO) elO.innerText = n;
        if (elM) elM.innerText = localStorage.getItem("chess_username");

        showScreen("game");
        document.getElementById("play-controls").classList.remove("hidden");
        document.getElementById("analysis-controls").classList.add("hidden");
        renderBoard();
        updateMoveHistoryUI();
      }

      // --- RENDER BOARD (DENGAN LISTENER BARU) ---
      function renderBoard() {
        const boardEl = document.getElementById("chess-board");
        if (!boardEl) return;
        boardEl.innerHTML =
          '<svg id="arrow-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>';

        let boardState = chess.board();
        // Visual Premove
        if (premoveQueue.length > 0) {
          premoveQueue.forEach((pm) => {
            const fC = pm.from.charCodeAt(0) - 97,
              fR = 8 - parseInt(pm.from[1]);
            const tC = pm.to.charCodeAt(0) - 97,
              tR = 8 - parseInt(pm.to[1]);
            if (boardState[fR][fC]) {
              boardState[tR][tC] = boardState[fR][fC];
              boardState[fR][fC] = null;
            }
          });
        }

        const rows =
          boardOrientation === "white"
            ? [0, 1, 2, 3, 4, 5, 6, 7]
            : [7, 6, 5, 4, 3, 2, 1, 0];
        const cols =
          boardOrientation === "white"
            ? [0, 1, 2, 3, 4, 5, 6, 7]
            : [7, 6, 5, 4, 3, 2, 1, 0];
        const lastMove = chess.history({ verbose: true }).pop();

        rows.forEach((r) => {
          cols.forEach((c) => {
            const square = String.fromCharCode(97 + c) + (8 - r);
            const piece = boardState[r][c];
            const div = document.createElement("div");
            div.className = `square ${(r + c) % 2 === 0 ? "white" : "black"}`;
            div.dataset.square = square;

            // Visual Classes
            if (selectedSquare === square) div.classList.add("selected");
            if (
              lastMove &&
              (lastMove.from === square || lastMove.to === square)
            )
              div.classList.add("last-move");
            const pmIndex = premoveQueue.findIndex(
              (pm) => pm.from === square || pm.to === square
            );
            if (pmIndex !== -1) {
              const pm = premoveQueue[pmIndex];
              if (pm.from === square) div.classList.add("premove-source");
              if (pm.to === square) div.classList.add("premove-dest");
            }
            if (
              piece &&
              piece.type === "k" &&
              chess.in_check() &&
              piece.color === chess.turn() &&
              premoveQueue.length === 0
            )
              div.classList.add("in-check");
            if (circleHighlights.includes(square))
              div.classList.add("circle-highlight");
            if (
              selectedSquare &&
              !premoveQueue.length &&
              chess.turn() === playerColor.charAt(0)
            ) {
              const moves = chess.moves({
                square: selectedSquare,
                verbose: true,
              });
              if (moves.find((m) => m.to === square))
                div.classList.add("possible-move");
            }

            if (piece) {
              const img = document.createElement("div");
              img.className = "piece";
              if (
                premoveQueue.length > 0 &&
                premoveQueue.some((pm) => pm.to === square)
              )
                img.classList.add("premove-piece");
              img.style.backgroundImage = `url('${getPieceUrl(
                piece.color,
                piece.type
              )}')`;

              // --- PASANG LISTENER UNTUK DRAG ---
              if (
                viewHistoryIndex === -1 &&
                (isAnalysisMode || piece.color === playerColor.charAt(0))
              ) {
                attachInputListeners(img, square);
              }
              div.appendChild(img);
            }

            // Fallback Click Listener (untuk kotak kosong/musuh)
            div.onclick = () => onSquareClick(square);

            // Right Click
            if (!isMobile) {
              div.addEventListener("mousedown", (e) => {
                if (e.button === 2) handleRightClickDown(e, square);
              });
              div.addEventListener("mouseup", (e) => {
                if (e.button === 2) handleRightClickUp(e, square);
              });
              div.addEventListener("mouseenter", (e) =>
                handleRightClickMove(e, square)
              );
            }
            boardEl.appendChild(div);
          });
        });
        drawArrows();
        updateStatusText();
      }

      // --- HELPER LAINNYA (SAMA SEPERTI SEBELUMNYA) ---
      function updateTimerDisplay() {
        const fmt = (t) => {
          if (t < 0) t = 0;
          const m = Math.floor(t / 60),
            s = t % 60;
          return `${m}:${s < 10 ? "0" + s : s}`;
        };
        if (selectedTime === -1) {
          document.getElementById("timer-self").innerText = "âˆž";
          document.getElementById("timer-opponent").innerText = "âˆž";
          return;
        }

        const elS = document.getElementById("timer-self"),
          elO = document.getElementById("timer-opponent");
        if (playerColor === "white") {
          elS.innerText = fmt(whiteTime);
          elO.innerText = fmt(blackTime);
        } else {
          elS.innerText = fmt(blackTime);
          elO.innerText = fmt(whiteTime);
        }

        const turn = chess.turn();
        const selfTurn =
          (playerColor === "white" && turn === "w") ||
          (playerColor === "black" && turn === "b");
        if (selfTurn) {
          elS.classList.add("timer-active");
          elO.classList.remove("timer-active");
        } else {
          elO.classList.add("timer-active");
          elS.classList.remove("timer-active");
        }
      }

      function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById("sound-toggle").innerHTML = soundEnabled
          ? '<i class="fas fa-volume-up"></i>'
          : '<i class="fas fa-volume-mute text-red-500"></i>';
      }
      function updateConnectionStatus(c) {
        document.getElementById("connection-status").innerText = c
          ? "Online"
          : "Offline";
      }
      async function handleLogin() {
        const n = document.getElementById("username-input").value.trim();
        if (n) {
          localStorage.setItem("chess_username", n);
          document.getElementById("user-display").innerText = n;
          showScreen("lobby");
          listenToLobby();
          loadHistory();
        }
      }
      function logout() {
        localStorage.removeItem("chess_username");
        location.reload();
      }
      function showScreen(id) {
        ["screen-login", "screen-lobby", "screen-game"].forEach((s) =>
          document.getElementById(s).classList.add("hidden")
        );
        document.getElementById("screen-" + id).classList.remove("hidden");
      }
      function flipBoard() {
        boardOrientation = boardOrientation === "white" ? "black" : "white";
        renderBoard();
      }
      function switchLobbyTab(tab) {
        const pa = document.getElementById("lobby-panel-arena"),
          ph = document.getElementById("lobby-panel-history"),
          ba = document.getElementById("tab-btn-arena"),
          bh = document.getElementById("tab-btn-history");
        if (tab === "arena") {
          pa.classList.remove("hidden");
          ph.classList.add("hidden");
          ba.classList.add("active");
          bh.classList.remove("active");
        } else {
          pa.classList.add("hidden");
          ph.classList.remove("hidden");
          ph.classList.remove("md:flex");
          ph.classList.add("flex");
          bh.classList.add("active");
          ba.classList.remove("active");
        }
      }

      // AI Helpers
      function startGameLocal(id, o, n) {
        // 1. PUTUS KONEKSI FIREBASE LAMA
        if (gameUnsubscribe) {
          gameUnsubscribe();
          gameUnsubscribe = null;
        }

        // 2. BERSIHKAN DATA LAMA AGAR NAMA TIDAK NYANGKUT
        gameData = null;

        // 3. Setup
        setupGameCommon(id, o, n);

        // --- SET MANUAL WAKTU KHUSUS AI ---
        // Karena setupGameCommon sekarang set waktu ke 0, kita isi manual disini
        const t = selectedTime === -1 ? 999999 : selectedTime * 60;
        whiteTime = t;
        blackTime = t;
        updateTimerDisplay();
        // ----------------------------------

        playSound("start");

        if (o === "black") {
          setTimeout(makeAIMove, 500);
        } else {
          startTimer();
        }
      }
      function makeAIMove() {
        if (chess.game_over()) return;
        document.getElementById("game-status").innerText = "AI Berpikir...";
        if (stockfishWorker) {
          stockfishWorker.postMessage("position fen " + chess.fen());
          stockfishWorker.postMessage(
            "setoption name Skill Level value " + aiLevel
          );
          stockfishWorker.postMessage("go depth " + (aiLevel > 10 ? 10 : 5));
          window.awaitingAI = true;
          if (aiTimeout) clearTimeout(aiTimeout);
          aiTimeout = setTimeout(() => {
            if (window.awaitingAI) {
              window.awaitingAI = false;
              const m = chess.moves();
              chess.move(m[Math.floor(Math.random() * m.length)]);
              finalizeAIMove();
            }
          }, 8000);
        } else {
          const m = chess.moves();
          chess.move(m[Math.floor(Math.random() * m.length)]);
          finalizeAIMove();
        }
      }
      function finalizeAIMove() {
        renderBoard();
        updateMoveHistoryUI();
        if (chess.in_check()) playSound("check");
        else playSound("move");
        checkGameOver(true);
        if (chess.turn() === playerColor.charAt(0)) startTimer();
        document.getElementById("game-status").innerText = "";
        setTimeout(processPremoves, 200);
      }
      function handleStockfishMessage(e) {
        if (window.awaitingAI && e.data.startsWith("bestmove")) {
          window.awaitingAI = false;
          if (aiTimeout) clearTimeout(aiTimeout);
          chess.move(e.data.split(" ")[1], { sloppy: true });
          finalizeAIMove();
        }
        if (
          isAnalysisMode &&
          e.data.startsWith("info") &&
          e.data.includes("score cp")
        ) {
          const m = e.data.match(/score cp (-?\d+)/);
          if (m) {
            let cp = parseInt(m[1]);
            if (chess.turn() === "b") cp = -cp;
            const f = document.getElementById("eval-fill"),
              s = document.getElementById("eval-score");
            if (f)
              f.style.width = Math.max(5, Math.min(95, 50 + cp / 10)) + "%";
            if (s) s.innerText = (cp / 100).toFixed(2);
          }
        }
        if (isAnalysisMode && e.data.startsWith("bestmove")) {
          const el = document.getElementById("best-move-text");
          if (el) el.innerText = "Saran: " + e.data.split(" ")[1];
        }
      }

      // Standard Helpers
      function checkGameOver(l) {
        if (chess.game_over()) {
          let r = "draw";
          if (chess.in_checkmate())
            r = chess.turn() === playerColor.charAt(0) ? "loss" : "win";
          handleGameOver(r);
          if (l && !isAI)
            db.collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                status: "finished",
                winner:
                  r === "win"
                    ? localStorage.getItem("chess_username")
                    : document.getElementById("opponent-name").innerText,
              });
        }
      }
      function handleGameOver(res) {
        clearInterval(timerInterval);
        document.getElementById("go-title").innerText =
          res === "win"
            ? "KEMENANGAN!"
            : res === "loss"
            ? "KEKALAHAN"
            : "REMIS";
        document.getElementById("go-message").innerText =
          res === "win" ? "Musuh tumbang." : "Istana runtuh.";
        document.getElementById("modal-gameover").classList.remove("hidden");
        playSound("end");
        const h = JSON.parse(localStorage.getItem("chess_history") || "[]");
        const o = document.getElementById("opponent-name").innerText;
        if (
          !h.length ||
          Date.now() - new Date(h[h.length - 1].date).getTime() > 5000
        ) {
          h.push({
            date: new Date().toISOString(),
            opponent: o,
            result: res,
            pgn: chess.pgn(),
          });
          localStorage.setItem("chess_history", JSON.stringify(h));
        }
      }
      function startAnalysisFromModal() {
        closeModal("modal-gameover");
        document.getElementById("play-controls").classList.add("hidden");
        document.getElementById("analysis-controls").classList.remove("hidden");
        isAnalysisMode = true;
        if (stockfishWorker)
          stockfishWorker.postMessage("position fen " + chess.fen());
      }
      function exitGame() {
        if (gameUnsubscribe) gameUnsubscribe();
        clearInterval(timerInterval);
        chess.reset();
        isReplayMode = false;
        showScreen("lobby");
        switchLobbyTab("arena");
        listenToLobby();
        loadHistory();
      }
      function updateMoveHistoryUI() {
        const t = document.getElementById("move-history");
        if (!t) return;
        t.innerHTML = "";
        const h = chess.history();
        for (let i = 0; i < h.length; i += 2)
          t.innerHTML += `<tr class="border-b border-[#3e2723] hover:bg-[#2b1d0e]"><td class="px-3 py-2 text-stone-500 w-10 border-r border-[#3e2723]">${
            i / 2 + 1
          }.</td><td class="px-3 py-2 cursor-pointer hover:text-white">${
            h[i]
          }</td><td class="px-3 py-2 cursor-pointer hover:text-white">${
            h[i + 1] || ""
          }</td></tr>`;
        if (viewHistoryIndex === -1)
          document.getElementById("pgn-container").scrollTop = 99999;
      }
      function playSound(t) {
        if (soundEnabled && audioFiles[t]) {
          const s = new Audio(audioFiles[t]);
          s.volume = 1;
          s.play().catch(() => {});
        }
      }

      // Modal & Request
      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }
      function showModalConfirm(t, m, y) {
        document.getElementById("modal-title").innerText = t;
        document.getElementById("modal-message").innerText = m;
        document.getElementById("modal-yes-btn").onclick = () => {
          y();
          closeModal("modal-confirm");
        };
        document.getElementById("modal-no-btn").onclick = () => {
          closeModal("modal-confirm");
        };
        document.getElementById("modal-confirm").classList.remove("hidden");
      }
      function showRequestModal(t) {
        document.getElementById("req-title").innerText =
          t === "takeback" ? "Minta Mundur" : "Tawaran Remis";
        document.getElementById("req-message").innerText =
          "Lawan meminta persetujuan.";
        document.getElementById("modal-request").classList.remove("hidden");
      }
      async function reqTakeback() {
        if (isAI) {
          chess.undo();
          chess.undo();
          renderBoard();
          updateMoveHistoryUI();
          playSound("notify");
          return;
        }
        showModalConfirm("MUNDUR?", "Minta mundur ke lawan?", async () => {
          await db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .update({
              requests: {
                type: "takeback",
                sender: currentUser.uid,
                status: "pending",
              },
            });
        });
      }
      async function reqDraw() {
        showModalConfirm("REMIS?", "Ajukan remis?", async () => {
          await db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .update({
              requests: {
                type: "draw",
                sender: currentUser.uid,
                status: "pending",
              },
            });
        });
      }
      function confirmResign() {
        if (
          document.getElementById("game-status").innerText === "Menunggu..."
        ) {
          db.collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .delete();
          exitGame();
          return;
        }
        showModalConfirm("MENYERAH?", "YAKIN?", () => {
          handleGameOver("loss");
          if (!isAI)
            db.collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                status: "finished",
                winner: document.getElementById("opponent-name").innerText,
              });
        });
      }
      async function respondRequest(acc) {
        document.getElementById("modal-request").classList.add("hidden");
        if (acc) {
          if (gameData.requests.type === "takeback") {
            const t = new Chess();
            t.load_pgn(chess.pgn());
            t.undo();
            if (
              t.turn() !==
              (gameData.requests.sender === gameData.white.id ? "w" : "b")
            )
              t.undo();
            await db
              .collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                fen: t.fen(),
                pgn: t.pgn(),
                requests: { status: "accepted" },
              });
          } else if (gameData.requests.type === "draw") {
            await db
              .collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                status: "finished",
                winner: "draw",
                requests: { status: "accepted" },
              });
          }
        } else {
          await db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .update({ requests: { status: "rejected" } });
        }
      }

      // Right Click & Arrows
      function handleRightClickDown(e, s) {
        if (!s) return;
        isRightClicking = true;
        rightClickStart = s;
      }
      function handleRightClickMove(e, s) {
        if (isRightClicking && s) {
          rightClickCurrent = s; // Simpan posisi sekarang
          if (s !== rightClickStart) {
            // Gambar ulang
            const svg = document.getElementById("arrow-layer");
            if (svg) {
              // Clear dulu agar tidak numpuk
              // (Tapi idealnya panggil drawArrows() full,
              //  hanya saja drawArrows perlu akses ke rightClickCurrent)
              drawArrows();

              // Gambar panah preview (kuning transparan/beda warna dikit)
              const getC = (str) => {
                const c = str.charCodeAt(0) - 97;
                const r = 8 - parseInt(str[1]);
                const x =
                  (boardOrientation === "white" ? c : 7 - c) * 12.5 + 6.25;
                const y =
                  (boardOrientation === "white" ? r : 7 - r) * 12.5 + 6.25;
                return { x, y };
              };
              renderArrowSvg(
                svg,
                getC(rightClickStart),
                getC(rightClickCurrent),
                "#f57c00",
                0.5
              );
            }
          }
        }
      }
      function handleRightClickUp(e, s) {
        if (!isRightClicking) return;
        isRightClicking = false;
        rightClickCurrent = null; // Reset

        if (rightClickStart === s) {
          const i = circleHighlights.indexOf(s);
          if (i > -1) circleHighlights.splice(i, 1);
          else circleHighlights.push(s);
        } else if (s) {
          // Cek apakah panah sudah ada (hapus jika ada)
          const i = arrows.findIndex(
            (a) => a.from === rightClickStart && a.to === s
          );
          if (i > -1) arrows.splice(i, 1);
          else arrows.push({ from: rightClickStart, to: s });
        }
        rightClickStart = null;
        renderBoard();
      }
      function clearArrowsAndHighlights() {
        arrows = [];
        circleHighlights = [];
        renderBoard();
      }
      // GANTI FUNGSI drawArrows INI
      function drawArrows() {
        const svg = document.getElementById("arrow-layer");
        if (!svg) return;
        svg.innerHTML = ""; // Reset

        const getC = (s) => {
          const c = s.charCodeAt(0) - 97;
          const r = 8 - parseInt(s[1]);
          // Konversi koordinat papan (0-7) ke koordinat SVG (0-100)
          // Tiap kotak 12.5 unit (100 / 8)
          // Titik tengah ada di +6.25
          const x = (boardOrientation === "white" ? c : 7 - c) * 12.5 + 6.25;
          const y = (boardOrientation === "white" ? r : 7 - r) * 12.5 + 6.25;
          return { x, y };
        };

        // Render Panah (Warna Oranye ala Chess.com)
        // Opacity 0.8 agar terlihat transparan sedikit
        arrows.forEach((a) =>
          renderArrowSvg(svg, getC(a.from), getC(a.to), "#f57c00", 0.8)
        );

        // Panah sementara saat drag klik kanan (Preview)
        if (
          isRightClicking &&
          rightClickStart &&
          rightClickStart !== rightClickStartCurrent
        ) {
          // rightClickStartCurrent perlu kita track di event handler mousemove
          // (Lihat perbaikan kecil di bawah untuk tracking mouse move arrow)
        }
      }

      function renderArrowSvg(svg, s, e, c, o = 0.8) {
        // Hitung sudut dan jarak
        const angle = Math.atan2(e.y - s.y, e.x - s.x);
        const dist = Math.hypot(e.x - s.x, e.y - s.y);

        if (dist < 5) return;

        // --- UKURAN BARU (LEBIH KECIL & ELEGAN) ---
        const lineWidth = 2; // Sebelumnya 2.8 (Terlalu tebal)
        const headLen = 4; // Ukuran kepala panah
        const headWidth = 3.5;

        // Titik akhir garis (mundur sedikit agar tidak menabrak ujung kepala)
        const endX = e.x - headLen * 0.1 * Math.cos(angle);
        const endY = e.y - headLen * 0.1 * Math.sin(angle);

        const id = `arrowhead-${Math.random().toString(36).substr(2, 9)}`;

        // Definisi Marker (Kepala)
        const defs = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "defs"
        );
        const marker = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "marker"
        );
        marker.setAttribute("id", id);
        marker.setAttribute("markerWidth", headLen);
        marker.setAttribute("markerHeight", headWidth);
        marker.setAttribute("refX", headLen);
        marker.setAttribute("refY", headWidth / 2);
        marker.setAttribute("orient", "auto");

        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path"
        );
        path.setAttribute(
          "d",
          `M0,0 L${headLen},${headWidth / 2} L0,${headWidth} Z`
        );
        path.setAttribute("fill", c);
        path.setAttribute("fill-opacity", o);

        marker.appendChild(path);
        defs.appendChild(marker);
        svg.appendChild(defs);

        // Garis Badan
        const line = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "line"
        );
        line.setAttribute("x1", s.x);
        line.setAttribute("y1", s.y);
        line.setAttribute("x2", endX);
        line.setAttribute("y2", endY);
        line.setAttribute("stroke", c);
        line.setAttribute("stroke-width", lineWidth);
        line.setAttribute("stroke-opacity", o);
        line.setAttribute("marker-end", `url(#${id})`);

        svg.appendChild(line);
      }
      function updateStatusText() {
        const el = document.getElementById("turn-indicator");
        if (!el) return;
        if (viewHistoryIndex !== -1) {
          el.innerText = "REPLAY";
          el.className = "text-xs font-bold text-yellow-500";
          return;
        }
        if (chess.turn() === boardOrientation.charAt(0)) {
          el.innerText = "GILIRAN ANDA";
          el.className = "text-xs font-bold text-green-400 animate-pulse";
        } else {
          el.innerText = "GILIRAN LAWAN";
          el.className = "text-xs font-bold text-slate-500";
        }
        const statusEl = document.getElementById("game-status");
        if (statusEl) statusEl.innerText = chess.in_check() ? "SKAK!" : "";
      }

      // Lobby & Create
      function openCreateGameModal(t) {
        windowPendingGameType = t;
        document.getElementById("modal-create").classList.remove("hidden");
        document
          .getElementById("ai-settings")
          .classList.toggle("hidden", t !== "ai");
        selectTime(10);
        selectColor("random");
      }
      function selectColor(c) {
        selectedColor = c;
        ["white", "random", "black"].forEach((x) =>
          document
            .getElementById(`btn-color-${x}`)
            .classList.toggle("selected", x === c)
        );
      }
      function selectTime(t) {
        selectedTime = t;
        [1, 3, 5, 10, 30, -1].forEach((x) =>
          document
            .getElementById(`btn-time-${x}`)
            .classList.toggle("selected", x === t)
        );
      }
      function confirmCreateGame() {
        if (windowPendingGameType === "ai")
          aiLevel = document.getElementById("ai-elo").value;
        document.getElementById("modal-create").classList.add("hidden");
        createGameExec(windowPendingGameType);
      }
      async function createGameExec(type) {
        if (!currentUser) return alert("Koneksi terputus!");
        try {
          const gameId = currentUser.uid + "_" + Date.now();
          const myName = localStorage.getItem("chess_username");
          let white = null,
            black = null,
            orient = "white";
          if (selectedColor === "random")
            selectedColor = Math.random() < 0.5 ? "white" : "black";
          if (selectedColor === "white") {
            white = { name: myName, id: currentUser.uid };
            orient = "white";
          } else {
            black = { name: myName, id: currentUser.uid };
            orient = "black";
          }
          if (type === "ai") {
            isAI = true;
            const aiName = `Stockfish (Lv.${aiLevel})`;
            if (orient === "white") black = { name: aiName, id: "ai" };
            else white = { name: aiName, id: "ai" };
            startGameLocal(gameId, orient, aiName);
          } else {
            isAI = false;
            await db
              .collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(gameId)
              .set({
                white,
                black,
                fen: "start",
                pgn: "",
                status: "waiting",
                timeControl: selectedTime,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                requests: {},
              });
            startGameFirestore(gameId, orient);
          }
        } catch (e) {
          alert(e.message);
        }
      }
      function listenToLobby() {
        db.collection("artifacts")
          .doc(appId)
          .collection("public")
          .doc("data")
          .collection("games")
          .where("status", "==", "waiting")
          .limit(50)
          .onSnapshot((snap) => {
            const listEl = document.getElementById("room-list");
            if (!listEl) return;
            listEl.innerHTML = "";
            if (snap.empty) {
              listEl.innerHTML =
                '<div class="text-center text-stone-500 py-4 text-xs italic">Belum ada tantangan.</div>';
              return;
            }
            let games = [];
            const now = Date.now();
            snap.forEach((doc) => {
              const d = doc.data();
              if (!d.createdAt) return;
              if (
                now - d.createdAt.toMillis() > 3600000 ||
                (d.white && d.black)
              ) {
                db.collection("artifacts")
                  .doc(appId)
                  .collection("public")
                  .doc("data")
                  .collection("games")
                  .doc(doc.id)
                  .delete()
                  .catch(() => {});
                return;
              }
              games.push({ id: doc.id, ...d });
            });
            games.sort(
              (a, b) =>
                (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)
            );
            games.forEach((g) => {
              if (
                g.white?.id === currentUser?.uid ||
                g.black?.id === currentUser?.uid
              )
                return;
              const hostName = g.white
                ? g.white.name
                : g.black
                ? g.black.name
                : "Unknown";
              const time = g.timeControl === -1 ? "âˆž" : g.timeControl;
              const div = document.createElement("div");
              div.className =
                "bg-[#2b1d0e] p-3 rounded flex justify-between items-center border border-[#5d4037] mb-2 hover:border-yellow-600 transition";
              div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-[#1a0f00] flex items-center justify-center border border-[#5d4037]"><i class="fas ${
                g.white
                  ? "fa-chess-king text-[#e6d2b5]"
                  : "fa-chess-king text-black"
              }"></i></div><div><span class="block text-sm font-bold text-[#c5a059] font-medieval">${hostName}</span><span class="text-[10px] text-stone-500">${time} Menit</span></div></div><button onclick="joinGame('${
                g.id
              }', this)" class="medieval-btn px-4 py-1.5 rounded text-xs shadow-lg"><i class="fas fa-swords mr-1"></i> LAWAN</button>`;
              listEl.appendChild(div);
            });
          });
      }
      function loadHistory() {
        const histList = document.getElementById("history-list");
        if (!histList) return;
        const history = JSON.parse(
          localStorage.getItem("chess_history") || "[]"
        );
        histList.innerHTML = "";
        if (history.length === 0) {
          histList.innerHTML =
            '<div class="text-center text-stone-500 py-4 text-xs italic">Belum ada jejak pertempuran.</div>';
          return;
        }
        history
          .reverse()
          .slice(0, 10)
          .forEach((game) => {
            const el = document.createElement("div");
            const color =
              game.result === "win"
                ? "text-green-500"
                : game.result === "loss"
                ? "text-red-500"
                : "text-yellow-500";
            el.className =
              "bg-[#2b1d0e] p-3 rounded text-xs mb-2 border border-[#5d4037] flex justify-between items-center cursor-pointer hover:border-yellow-600 transition";
            el.innerHTML = `<div class="flex flex-col"><span class="text-[#c5a059] font-bold">vs ${
              game.opponent
            }</span><span class="text-[10px] text-stone-500">${new Date(
              game.date
            ).toLocaleDateString()}</span></div><span class="${color} font-bold uppercase border border-stone-600 px-2 py-1 rounded bg-black/30">${
              game.result
            }</span>`;
            el.onclick = () => loadReplayGame(game);
            histList.appendChild(el);
          });
      }
      function loadReplayGame(game) {
        currentGameId = null;
        isReplayMode = true;
        isAnalysisMode = true;
        boardOrientation = "white";
        if (!game.pgn) return alert("Arsip rusak.");
        chess.load_pgn(game.pgn);
        viewHistoryIndex = -1;
        document.getElementById("opponent-name").innerText = game.opponent;
        showScreen("game");
        document.getElementById("play-controls").classList.add("hidden");
        document.getElementById("analysis-controls").classList.remove("hidden");
        renderBoard();
        updateMoveHistoryUI();
        if (stockfishWorker) {
          stockfishWorker.postMessage("position fen " + chess.fen());
          stockfishWorker.postMessage("go depth 15");
        }
      }
      // GANTI FUNGSI joinGame INI
      async function joinGame(id) {
        isAI = false;
        try {
          const gameRef = db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(id);
          const doc = await gameRef.get();

          if (!doc.exists) return alert("Room hilang!");

          const d = doc.data();
          const myName = localStorage.getItem("chess_username");
          const myId = currentUser.uid;

          // Data update dasar
          let updateData = {
            status: "playing",
            // --- FIX PENTING: Set waktu mulai agar timer jalan ---
            lastMove: { t: Date.now() },
          };
          let myColor = "";

          // Tentukan warna
          if (!d.white) {
            updateData.white = { name: myName, id: myId };
            myColor = "white";
          } else if (!d.black) {
            updateData.black = { name: myName, id: myId };
            myColor = "black";
          } else {
            return alert("Penuh!");
          }

          // Update DB dan Masuk
          await gameRef.update(updateData);
          startGameFirestore(id, myColor);
        } catch (e) {
          alert(e.message);
        }
      }

      initApp();
    </script>
  </body>
</html>
