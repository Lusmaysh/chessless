<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catur Master Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Chess Logic & Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; }
        
        /* --- BOARD STYLING (HIGH CONTRAST) --- */
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 90vw;
            height: 90vw;
            max-width: 65vh;
            max-height: 65vh;
            margin: 0 auto;
            border: 3px solid #334155;
            user-select: none;
            touch-action: none; /* Mencegah scroll saat drag di HP */
            position: relative;
        }

        .square {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Warna High Contrast (Blue Theme) */
        .square.white { background-color: #ebecd0; }
        .square.black { background-color: #739552; }
        
        /* Highlights */
        .square.selected { background-color: #f5f682 !important; } /* Kuning terang */
        .square.last-move { background-color: #baca44 !important; } /* Hijau stabilo */
        .square.premove { background-color: #f43f5e !important; opacity: 0.8; } /* Merah untuk premove */
        .square.viewing-history { background-color: #64748b !important; opacity: 0.7; }

        /* Dot Langkah Valid */
        .square.possible-move::after {
            content: '';
            width: 30%;
            height: 30%;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            position: absolute;
            pointer-events: none;
        }
        
        /* Bidak */
        .piece {
            width: 100%;
            height: 100%;
            background-size: 85%; /* Sedikit lebih kecil agar rapi */
            background-repeat: no-repeat;
            background-position: center;
            cursor: grab;
            z-index: 10;
        }
        .piece.dragging { opacity: 0.5; }

        /* Ghost Piece saat Drag */
        #drag-ghost {
            position: fixed;
            width: 60px;
            height: 60px;
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            z-index: 9999;
            display: none;
            transform: translate(-50%, -50%);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* Modal Overlay */
        .modal-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8); 
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        
        .active-history { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col bg-slate-900">

    <!-- Ghost Element for Dragging -->
    <div id="drag-ghost"></div>

    <!-- MODALS -->
    <!-- Modal Konfirmasi Umum (Resign/Draw) -->
    <div id="modal-confirm" class="modal-overlay hidden">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-2">Konfirmasi</h3>
            <p id="modal-message" class="text-slate-300 mb-6">Yakin?</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal()" class="bg-slate-600 px-4 py-2 rounded text-white font-bold">Batal</button>
                <button id="modal-yes-btn" class="bg-red-600 px-4 py-2 rounded text-white font-bold">Ya</button>
            </div>
        </div>
    </div>

    <!-- Modal Terima Permintaan (Takeback/Draw Offer) -->
    <div id="modal-request" class="modal-overlay hidden">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 max-w-sm w-full text-center animate-bounce">
            <i class="fas fa-bell text-yellow-400 text-3xl mb-3"></i>
            <h3 id="req-title" class="text-xl font-bold text-white mb-2">Permintaan</h3>
            <p id="req-message" class="text-slate-300 mb-6">Lawan meminta...</p>
            <div class="flex gap-3 justify-center">
                <button onclick="respondRequest(false)" class="bg-red-600 px-4 py-2 rounded text-white font-bold">Tolak</button>
                <button onclick="respondRequest(true)" class="bg-green-600 px-4 py-2 rounded text-white font-bold">Terima</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-slate-800 px-4 py-3 shadow-lg flex justify-between items-center h-[60px] shrink-0 border-b border-slate-700 relative z-50">
        <div class="flex items-center gap-2">
            <i class="fas fa-chess-queen text-yellow-500 text-2xl"></i>
            <h1 class="text-lg font-bold text-white tracking-wide hidden sm:block">Catur Master Pro</h1>
        </div>
        <div class="flex items-center gap-3">
            <div id="connection-status" class="text-[10px] px-2 py-1 rounded bg-red-900 text-red-200 animate-pulse font-mono">...</div>
            <span id="user-display" class="text-sm text-slate-300 font-semibold truncate max-w-[100px]"></span>
            <button onclick="logout()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white border border-slate-600">Keluar</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 relative w-full h-full overflow-hidden flex flex-col md:flex-row">
        
        <!-- 1. LOGIN SCREEN -->
        <div id="screen-login" class="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center p-4 z-[60]">
            <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-sm w-full border border-slate-700 text-center">
                <i class="fas fa-chess text-5xl text-yellow-500 mb-6"></i>
                <h2 class="text-2xl font-bold mb-2 text-white">Selamat Datang</h2>
                <input type="text" id="username-input" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Nama Panggilan...">
                <button onclick="handleLogin()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-3 rounded-lg shadow-lg">
                    Masuk
                </button>
            </div>
        </div>

        <!-- 2. LOBBY SCREEN -->
        <div id="screen-lobby" class="absolute inset-0 bg-slate-900 hidden flex flex-col z-[50]">
            <div class="w-full max-w-6xl mx-auto flex flex-col h-full p-4">
                <div class="flex justify-between items-center mb-4 bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <h2 class="text-xl font-bold text-white"><i class="fas fa-server text-blue-400"></i> Lobby</h2>
                    <div class="flex gap-2">
                        <button onclick="createGame('ai', this)" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold text-sm shadow"><i class="fas fa-robot"></i> VS AI</button>
                        <button onclick="createGame('human', this)" class="bg-yellow-500 hover:bg-yellow-400 text-slate-900 px-4 py-2 rounded font-bold text-sm shadow"><i class="fas fa-user-friends"></i> Buat Room</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1 overflow-hidden">
                    <div class="bg-slate-800 rounded-lg border border-slate-700 flex flex-col overflow-hidden">
                        <div class="p-3 bg-slate-900 font-bold text-slate-300 border-b border-slate-700">Room Tersedia</div>
                        <div id="room-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
                    </div>
                    <div class="bg-slate-800 rounded-lg border border-slate-700 flex flex-col overflow-hidden">
                        <div class="p-3 bg-slate-900 font-bold text-slate-300 border-b border-slate-700">Riwayat Lokal</div>
                        <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. GAME SCREEN -->
        <div id="screen-game" class="absolute inset-0 bg-slate-900 hidden flex flex-col md:flex-row z-[40]">
            
            <!-- BOARD AREA (LEFT/TOP) -->
            <div class="flex-1 flex flex-col items-center justify-center p-2 relative bg-slate-900">
                <!-- Info Lawan -->
                <div class="w-[90vw] max-w-[65vh] flex justify-between items-end mb-2 px-1">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-slate-700 border border-slate-500 flex items-center justify-center"><i class="fas fa-user text-slate-400"></i></div>
                        <div>
                            <span id="opponent-name" class="font-bold text-sm text-slate-200 block">Lawan</span>
                            <span id="game-status" class="text-xs text-yellow-400 font-mono"></span>
                        </div>
                    </div>
                    <div id="opponent-timer" class="bg-slate-800 px-2 py-1 rounded text-white font-mono text-sm border border-slate-700">--:--</div>
                </div>

                <!-- CHESS BOARD -->
                <div id="chess-board" class="chess-board rounded shadow-2xl"></div>

                <!-- Info Kita -->
                <div class="w-[90vw] max-w-[65vh] flex justify-between items-start mt-2 px-1">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-indigo-900 border border-indigo-500 flex items-center justify-center"><i class="fas fa-user text-indigo-300"></i></div>
                        <div>
                            <span id="player-name-display" class="font-bold text-sm text-slate-200 block">Anda</span>
                            <span id="turn-indicator" class="text-[10px] text-slate-500">Giliran...</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="flipBoard()" class="text-slate-400 hover:text-white"><i class="fas fa-sync-alt"></i></button>
                        <div id="my-timer" class="bg-slate-800 px-2 py-1 rounded text-white font-mono text-sm border border-slate-700">--:--</div>
                    </div>
                </div>
            </div>

            <!-- CONTROLS AREA (RIGHT/BOTTOM) -->
            <div class="w-full md:w-[350px] bg-slate-800 border-l border-slate-700 flex flex-col h-[40vh] md:h-full shrink-0 shadow-xl z-20">
                
                <!-- Tab Langkah -->
                <div class="flex bg-slate-900 border-b border-slate-700">
                    <button class="flex-1 py-2 text-xs font-bold text-blue-400 border-b-2 border-blue-500 uppercase">Langkah</button>
                    <button class="flex-1 py-2 text-xs font-bold text-slate-500 hover:text-slate-300 uppercase" onclick="alert('Chat segera hadir!')">Chat</button>
                </div>

                <!-- Move List -->
                <div class="flex-1 overflow-y-auto bg-slate-800 p-0" id="pgn-container">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-slate-850 text-slate-500 text-[10px] uppercase sticky top-0">
                            <tr><th class="px-2 py-1 w-8">#</th><th class="px-2 py-1">Putih</th><th class="px-2 py-1">Hitam</th></tr>
                        </thead>
                        <tbody id="move-history" class="text-slate-300 font-mono">
                            <!-- Moves Injected Here -->
                        </tbody>
                    </table>
                </div>

                <!-- Action Buttons -->
                <div class="bg-slate-850 p-3 border-t border-slate-700">
                    
                    <!-- Game Controls (Play Mode) -->
                    <div id="play-controls" class="grid grid-cols-4 gap-2 mb-2">
                        <button onclick="reqTakeback()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded" title="Mundur Langkah">
                            <i class="fas fa-undo-alt"></i>
                        </button>
                        <button onclick="reqDraw()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded" title="Ajukan Remis">
                            <i class="fas fa-handshake"></i>
                        </button>
                        <button onclick="confirmResign()" class="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-800 py-2 rounded col-span-2 text-xs font-bold">
                            <i class="fas fa-flag"></i> MENYERAH
                        </button>
                    </div>

                    <!-- Analysis Controls (Post Game / Spectate) -->
                    <div id="analysis-controls" class="hidden flex-col gap-2">
                        <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700">
                             <span class="text-xs font-bold text-blue-400">STOCKFISH EVAL</span>
                             <span id="eval-score" class="text-xs font-mono text-white">0.0</span>
                        </div>
                        <div class="eval-bar-container"><div id="eval-fill" class="eval-bar-fill"></div></div>
                        <p id="best-move-text" class="text-[10px] text-slate-400 italic text-center min-h-[16px] mt-1"></p>
                        <button onclick="exitGame()" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-2 rounded font-bold text-sm">
                            <i class="fas fa-arrow-left"></i> KEMBALI
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- KONFIGURASI FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyDmer19KTaijOz3bTdknEEs5dqwKNt6HQg",
            authDomain: "masjid-pekalongan.firebaseapp.com",
            projectId: "masjid-pekalongan",
            storageBucket: "masjid-pekalongan.firebasestorage.app",
            messagingSenderId: "619031365600",
            appId: "1:619031365600:web:35061354a11cf3f72e4d85",
            measurementId: "G-R511G99W8R"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'chess-v3-final';

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentGameId = null;
        let gameData = null; 
        let chess = new Chess();
        let boardOrientation = 'white';
        
        // Interaction State
        let selectedSquare = null;
        let premove = null; // {from, to}
        let draggedPiece = null;
        let isDragging = false;
        let dragStartSquare = null;
        
        // View State
        let isAI = false;
        let isAnalysisMode = false;
        let viewHistoryIndex = -1; // -1 = Live
        let moveHistoryArray = []; // Full history for navigation
        
        // Stockfish
        let stockfishWorker = null;

        // Assets
        function getPieceUrl(color, type) {
            const baseUrl = "https://images.chesscomfiles.com/chess-themes/pieces/neo/150/";
            return `${baseUrl}${color}${type}.png`;
        }

        // --- INIT ---
        async function initApp() {
            try {
                const blob = await fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js').then(r => r.blob());
                stockfishWorker = new Worker(URL.createObjectURL(blob));
                stockfishWorker.onmessage = handleStockfishMessage;
            } catch (e) { console.warn("SF Error", e); }

            const savedName = localStorage.getItem('chess_username');
            if (savedName) document.getElementById('username-input').value = savedName;

            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    updateConnectionStatus(true);
                    if (localStorage.getItem('chess_username') && !document.getElementById('screen-login').classList.contains('hidden')) {
                        handleLogin();
                    }
                } else {
                    updateConnectionStatus(false);
                    auth.signInAnonymously();
                }
            });

            // Global Mouse Up for Drag Drop safety
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function updateConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            el.innerText = connected ? "Online" : "Connecting...";
            el.className = connected ? "text-[10px] px-2 py-1 rounded bg-green-900 text-green-200" : "text-[10px] px-2 py-1 rounded bg-red-900 text-red-200 animate-pulse";
        }

        async function handleLogin() {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return;
            localStorage.setItem('chess_username', name);
            document.getElementById('user-display').innerText = name;
            showScreen('lobby');
            listenToLobby();
            loadHistory();
        }

        function logout() {
            localStorage.removeItem('chess_username');
            location.reload();
        }

        // --- LOBBY ---
        function listenToLobby() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games')
                .where('status', '==', 'waiting')
                .limit(20)
                .onSnapshot((snapshot) => {
                    const listEl = document.getElementById('room-list');
                    listEl.innerHTML = '';
                    if (snapshot.empty) {
                        listEl.innerHTML = '<div class="text-center text-slate-500 py-4 text-xs">Tidak ada room. Buat baru!</div>';
                        return;
                    }
                    
                    let games = [];
                    snapshot.forEach(doc => games.push({id: doc.id, ...doc.data()}));
                    games.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    games.forEach(g => {
                        if (g.white.id === currentUser?.uid) return;
                        const div = document.createElement('div');
                        div.className = "bg-slate-700 p-2 rounded flex justify-between items-center border border-slate-600";
                        div.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-green-500"></span>
                                <span class="font-bold text-white text-sm">${g.white.name}</span>
                            </div>
                            <button onclick="joinGame('${g.id}')" class="bg-blue-600 px-3 py-1 rounded text-xs font-bold text-white">MAIN</button>
                        `;
                        listEl.appendChild(div);
                    });
                });
        }

        async function createGame(type, btn) {
            if(!currentUser) return alert("Belum konek!");
            btn.disabled = true;
            try {
                const name = localStorage.getItem('chess_username');
                const gameId = currentUser.uid + '_' + Date.now();
                
                if (type === 'ai') {
                    isAI = true;
                    startGameLocal(gameId, 'white', 'Stockfish AI');
                } else {
                    isAI = false;
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(gameId).set({
                        white: { name: name, id: currentUser.uid },
                        black: null,
                        fen: 'start',
                        pgn: '',
                        status: 'waiting',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        requests: {} // For takeback/draw
                    });
                    startGameFirestore(gameId, 'white');
                }
            } catch(e) { 
                alert("Error: " + e.message); 
            } finally { btn.disabled = false; }
        }

        async function joinGame(id) {
            const name = localStorage.getItem('chess_username');
            isAI = false;
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id).update({
                    black: { name: name, id: currentUser.uid },
                    status: 'playing'
                });
                startGameFirestore(id, 'black');
            } catch(e) { alert("Room penuh/hilang"); }
        }

        // --- GAME LOGIC ---
        let gameUnsubscribe = null;

        function startGameLocal(id, orientation, oppName) {
            setupGameCommon(id, orientation, oppName);
            if(orientation==='black') setTimeout(makeAIMove, 500);
        }

        function startGameFirestore(id, orientation) {
            setupGameCommon(id, orientation, "Menunggu...");
            
            if(gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id)
                .onSnapshot(doc => {
                    if(!doc.exists) return;
                    gameData = doc.data();
                    
                    // Update Info
                    const opp = orientation === 'white' ? gameData.black : gameData.white;
                    document.getElementById('opponent-name').innerText = opp ? opp.name : "Menunggu...";
                    
                    // Check Requests (Takeback/Draw)
                    checkRequests(gameData.requests, orientation);

                    // Sync Board (Only if live)
                    if (viewHistoryIndex === -1 && gameData.fen && gameData.fen !== 'start' && chess.fen() !== gameData.fen) {
                        chess.load(gameData.fen);
                        
                        // Check Premove Logic
                        if (premove) {
                            const move = chess.move({ from: premove.from, to: premove.to, promotion: 'q' });
                            if (move) {
                                premove = null;
                                pushMoveToFirestore(); // Execute premove
                            } else {
                                premove = null; // Illegal now
                            }
                        }
                        
                        renderBoard();
                        updateMoveHistoryUI();
                        checkGameOver(false);
                        playSound('move');
                    }
                    
                    if (gameData.status === 'finished' && !isAnalysisMode) {
                        const myName = localStorage.getItem('chess_username');
                        let result = 'draw';
                        if(gameData.winner && gameData.winner !== 'draw') {
                            result = gameData.winner === myName ? 'win' : 'loss';
                        }
                        handleGameOver(result, true);
                    }
                });
        }

        function setupGameCommon(id, orientation, oppName) {
            currentGameId = id;
            boardOrientation = orientation;
            chess.reset();
            isAnalysisMode = false;
            premove = null;
            viewHistoryIndex = -1;
            selectedSquare = null;
            
            document.getElementById('opponent-name').innerText = oppName;
            document.getElementById('player-name-display').innerText = localStorage.getItem('chess_username');
            
            showScreen('game');
            document.getElementById('play-controls').classList.remove('hidden');
            document.getElementById('analysis-controls').classList.add('hidden');
            
            renderBoard();
            updateMoveHistoryUI();
        }

        // --- BOARD RENDERING & INTERACTION ---
        function renderBoard() {
            const boardEl = document.getElementById('chess-board');
            boardEl.innerHTML = '';
            
            // Determine board state to show (Live vs History)
            let boardState = chess.board();
            let currentTurn = chess.turn();
            
            // If viewing history
            if (viewHistoryIndex !== -1) {
                // Use a temporary chess instance to recreate state
                const tempChess = new Chess();
                const moves = chess.history();
                for(let i=0; i<=viewHistoryIndex; i++) tempChess.move(moves[i]);
                boardState = tempChess.board();
                currentTurn = tempChess.turn();
            }

            const isWhite = boardOrientation === 'white';
            const rows = isWhite ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            const cols = isWhite ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            
            const lastMove = chess.history({verbose:true}).pop();

            rows.forEach(r => {
                cols.forEach(c => {
                    const square = String.fromCharCode(97+c) + (8-r);
                    const piece = boardState[r][c];
                    
                    const div = document.createElement('div');
                    div.className = `square ${(r+c)%2===0 ? 'white' : 'black'}`;
                    div.dataset.square = square;

                    // Classes for colors/highlights
                    if (viewHistoryIndex !== -1) div.classList.add('viewing-history');
                    if (selectedSquare === square) div.classList.add('selected');
                    if (viewHistoryIndex === -1 && lastMove && (lastMove.from === square || lastMove.to === square)) div.classList.add('last-move');
                    if (premove && (premove.from === square || premove.to === square)) div.classList.add('premove');

                    // Highlight Valid Moves
                    if (selectedSquare && viewHistoryIndex === -1) {
                        const moves = chess.moves({square: selectedSquare, verbose: true});
                        if (moves.find(m => m.to === square)) div.classList.add('possible-move');
                    }

                    // Render Piece
                    if (piece) {
                        const img = document.createElement('div');
                        img.className = 'piece';
                        img.style.backgroundImage = `url('${getPieceUrl(piece.color, piece.type)}')`;
                        
                        // Drag Events (Only if my turn or premove allowed, and playing live)
                        if (viewHistoryIndex === -1) {
                            const isMyPiece = piece.color === boardOrientation.charAt(0);
                            if (isMyPiece) {
                                img.addEventListener('mousedown', (e) => startDrag(e, square, img));
                                img.addEventListener('touchstart', (e) => startDrag(e, square, img), {passive:false});
                            }
                        }
                        div.appendChild(img);
                    }
                    
                    // Click Event (Fallback for tap)
                    div.onclick = () => onSquareClick(square);
                    
                    boardEl.appendChild(div);
                });
            });
            
            updateStatusText();
        }

        // --- DRAG & DROP LOGIC ---
        function startDrag(e, square, el) {
            if (isAnalysisMode || viewHistoryIndex !== -1) return;
            e.preventDefault(); // Stop selection
            
            isDragging = true;
            dragStartSquare = square;
            draggedPiece = el;
            
            // Select square first (shows highlights)
            onSquareClick(square); 
            
            // Setup Ghost
            const ghost = document.getElementById('drag-ghost');
            ghost.style.backgroundImage = el.style.backgroundImage;
            ghost.style.display = 'block';
            
            el.classList.add('dragging');
            moveGhost(e);
            
            document.addEventListener('mousemove', moveGhost);
            document.addEventListener('touchmove', moveGhost, {passive:false});
        }

        function moveGhost(e) {
            if(!isDragging) return;
            const ghost = document.getElementById('drag-ghost');
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            ghost.style.left = clientX + 'px';
            ghost.style.top = clientY + 'px';
        }

        function endDrag(e) {
            if(!isDragging) return;
            isDragging = false;
            
            const ghost = document.getElementById('drag-ghost');
            ghost.style.display = 'none';
            if(draggedPiece) draggedPiece.classList.remove('dragging');
            
            document.removeEventListener('mousemove', moveGhost);
            document.removeEventListener('touchmove', moveGhost);

            // Calculate dropped square
            const clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            
            // Find element below cursor
            const elements = document.elementsFromPoint(clientX, clientY);
            const squareEl = elements.find(el => el.classList.contains('square'));
            
            if (squareEl) {
                const targetSquare = squareEl.dataset.square;
                if (targetSquare && targetSquare !== dragStartSquare) {
                    handleMoveAttempt(dragStartSquare, targetSquare);
                }
            }
        }

        // --- MOVE LOGIC ---
        function onSquareClick(square) {
            if (isAnalysisMode || viewHistoryIndex !== -1 || isDragging) return;

            // If clicking own piece, select it
            const piece = chess.get(square);
            const myColor = boardOrientation.charAt(0);
            
            if (selectedSquare === null) {
                if (piece && piece.color === myColor) {
                    selectedSquare = square;
                    renderBoard();
                }
            } else {
                // If clicking same square, deselect
                if (selectedSquare === square) {
                    selectedSquare = null;
                    renderBoard();
                    return;
                }
                
                // If clicking another own piece, switch selection
                if (piece && piece.color === myColor) {
                    selectedSquare = square;
                    renderBoard();
                    return;
                }
                
                // Attempt move
                handleMoveAttempt(selectedSquare, square);
            }
        }

        function handleMoveAttempt(from, to) {
            // 1. Is it my turn?
            const myTurn = chess.turn() === boardOrientation.charAt(0);
            
            if (myTurn) {
                // Normal Move
                const move = chess.move({ from: from, to: to, promotion: 'q' });
                selectedSquare = null;
                premove = null;
                
                if (move) {
                    renderBoard();
                    updateMoveHistoryUI();
                    playSound('move');
                    if (isAI) {
                        checkGameOver(true);
                        setTimeout(makeAIMove, 500);
                    } else {
                        pushMoveToFirestore();
                    }
                } else {
                    renderBoard(); // Invalid move, redraw to clear selection
                }
            } else {
                // Premove Logic
                // Simple validation: is it a vaguely plausible move? (own piece to somewhere)
                const piece = chess.get(from);
                if (piece && piece.color === boardOrientation.charAt(0)) {
                    premove = { from: from, to: to };
                    selectedSquare = null;
                    renderBoard(); // Will highlight red
                }
            }
        }

        async function pushMoveToFirestore() {
            if (!currentGameId) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                fen: chess.fen(),
                pgn: chess.pgn(),
                lastMove: { t: Date.now() }
            });
            checkGameOver(true);
        }

        // --- AI LOGIC ---
        function makeAIMove() {
            if (chess.game_over()) return;
            if (stockfishWorker) {
                stockfishWorker.postMessage('position fen ' + chess.fen());
                stockfishWorker.postMessage('go depth 6'); 
                window.awaitingAI = true;
            } else {
                // Fallback
                const moves = chess.moves();
                const randomMove = moves[Math.floor(Math.random() * moves.length)];
                chess.move(randomMove);
                renderBoard();
                updateMoveHistoryUI();
                checkGameOver(true);
            }
        }

        function handleStockfishMessage(e) {
            if(window.awaitingAI && e.data.startsWith('bestmove')) {
                window.awaitingAI = false;
                const move = e.data.split(' ')[1];
                chess.move(move, {sloppy:true});
                renderBoard();
                updateMoveHistoryUI();
                checkGameOver(true);
                playSound('move');
            }
            // Analysis
            if(isAnalysisMode && e.data.startsWith('info') && e.data.includes('score cp')) {
                const match = e.data.match(/score cp (-?\d+)/);
                if(match) {
                    let cp = parseInt(match[1]);
                    if(chess.turn()==='b') cp = -cp;
                    const pct = Math.max(5, Math.min(95, 50 + (cp/10)));
                    document.getElementById('eval-fill').style.width = pct + '%';
                    document.getElementById('eval-score').innerText = (cp/100).toFixed(1);
                }
            }
        }

        // --- MULTIPLAYER ACTIONS (Takeback, Draw, Resign) ---
        async function reqTakeback() {
            if(isAI) { chess.undo(); chess.undo(); renderBoard(); updateMoveHistoryUI(); return; }
            if(!confirm("Minta ijin mundur langkah ke lawan?")) return;
            sendRequest('takeback');
        }

        async function reqDraw() {
            if(!confirm("Ajukan penawaran remis (draw)?")) return;
            sendRequest('draw');
        }

        function confirmResign() {
            showModalConfirm("Menyerah?", "Anda akan kalah dalam permainan ini.", () => {
                handleGameOver('loss');
                if(!isAI) {
                    const opp = document.getElementById('opponent-name').innerText;
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                        status: 'finished', winner: opp
                    });
                }
            });
        }

        async function sendRequest(type) {
            const reqData = { type: type, sender: currentUser.uid, status: 'pending' };
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                requests: reqData
            });
            alert("Permintaan dikirim.");
        }

        function checkRequests(req, myColor) {
            if(!req || req.status !== 'pending') {
                document.getElementById('modal-request').classList.add('hidden');
                return;
            }
            if(req.sender === currentUser.uid) return; // Wait my own req

            // Show Modal
            const modal = document.getElementById('modal-request');
            const title = document.getElementById('req-title');
            const msg = document.getElementById('req-message');
            
            modal.classList.remove('hidden');
            if(req.type === 'takeback') {
                title.innerText = "Minta Mundur";
                msg.innerText = "Lawan ingin membatalkan langkah terakhir.";
            } else if (req.type === 'draw') {
                title.innerText = "Tawaran Remis";
                msg.innerText = "Lawan menawarkan hasil seri.";
            }
        }

        async function respondRequest(accepted) {
            document.getElementById('modal-request').classList.add('hidden');
            if(!gameData.requests) return;
            
            const reqType = gameData.requests.type;
            
            if (accepted) {
                if (reqType === 'takeback') {
                    // Logic Undo in Firestore: Load PGN, undo last move, save
                    // Complex, simplified: Just notify accepted, manual undo logic needed server side ideally
                    // Client side dirty fix:
                    const temp = new Chess();
                    temp.load_pgn(chess.pgn());
                    temp.undo(); // Undo opponent
                    // If playing online, usually need to undo 2 moves (my last and his last) to get back to my turn?
                    // Simplified: just Undo once (back to previous turn)
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                        fen: temp.fen(), pgn: temp.pgn(), requests: { status: 'accepted' }
                    });
                } else if (reqType === 'draw') {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                        status: 'finished', winner: 'draw', requests: { status: 'accepted' }
                    });
                }
            } else {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                    requests: { status: 'rejected' }
                });
            }
        }

        // --- HISTORY & UTILS ---
        function updateMoveHistoryUI() {
            const hist = chess.history();
            const tbody = document.getElementById('move-history');
            tbody.innerHTML = '';
            
            // Correct Move Counter Logic
            for (let i = 0; i < hist.length; i += 2) {
                const moveNum = (i / 2) + 1;
                const whiteMove = hist[i];
                const blackMove = hist[i+1] || '';
                
                const row = document.createElement('tr');
                row.className = "border-b border-slate-800 hover:bg-slate-800 transition";
                
                row.innerHTML = `
                    <td class="px-2 py-1 text-slate-500 w-8 border-r border-slate-700">${moveNum}.</td>
                    <td class="px-2 py-1 cursor-pointer hover:text-white ${i === viewHistoryIndex ? 'active-history rounded' : ''}" onclick="viewHistory(${i})">${whiteMove}</td>
                    <td class="px-2 py-1 cursor-pointer hover:text-white ${i+1 === viewHistoryIndex ? 'active-history rounded' : ''}" onclick="viewHistory(${i+1})">${blackMove}</td>
                `;
                tbody.appendChild(row);
            }
            
            // Scroll to bottom if live
            if(viewHistoryIndex === -1) {
                const container = document.getElementById('pgn-container');
                container.scrollTop = container.scrollHeight;
            }
        }

        function viewHistory(index) {
            const historyLength = chess.history().length;
            if (index >= historyLength - 1) {
                viewHistoryIndex = -1; // Back to live
            } else {
                viewHistoryIndex = index;
            }
            renderBoard();
            updateMoveHistoryUI(); // Update active highlights
        }

        function updateStatusText() {
            const statusEl = document.getElementById('game-status');
            const turnEl = document.getElementById('turn-indicator');
            
            if(viewHistoryIndex !== -1) {
                turnEl.innerText = "MODE REPLAY";
                turnEl.className = "text-xs font-bold text-yellow-500 bg-yellow-900/30 px-2 rounded";
                return;
            }

            const myTurn = chess.turn() === boardOrientation.charAt(0);
            
            if (myTurn) {
                turnEl.innerText = "GILIRAN ANDA";
                turnEl.className = "text-xs font-bold text-green-400 animate-pulse bg-green-900/30 px-2 rounded";
            } else {
                turnEl.innerText = "GILIRAN LAWAN";
                turnEl.className = "text-xs font-bold text-slate-500 bg-slate-800 px-2 rounded";
            }

            if(chess.in_check()) statusEl.innerText = "SKAK!";
            else statusEl.innerText = "";
        }

        function checkGameOver(localTrigger) {
            if (chess.game_over()) {
                let res = 'draw';
                let winnerName = 'draw';
                const myName = localStorage.getItem('chess_username');
                const oppName = document.getElementById('opponent-name').innerText;

                if (chess.in_checkmate()) {
                    const winnerColor = chess.turn() === 'w' ? 'black' : 'white';
                    if (boardOrientation === winnerColor) { res = 'win'; winnerName = myName; }
                    else { res = 'loss'; winnerName = oppName; }
                }
                
                if (localTrigger && !isAI) {
                    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                        status: 'finished', winner: winnerName
                    });
                }
                handleGameOver(res);
            }
        }

        function handleGameOver(res, remote) {
            const titles = { 'win': 'MENANG!', 'loss': 'KALAH', 'draw': 'REMIS' };
            const colors = { 'win': 'text-green-500', 'loss': 'text-red-500', 'draw': 'text-yellow-500' };
            
            document.getElementById('game-status').innerHTML = `<span class="${colors[res]} font-bold text-base">${titles[res]}</span>`;
            
            // Simpan Histori
            const hist = JSON.parse(localStorage.getItem('chess_history') || '[]');
            const oppName = document.getElementById('opponent-name').innerText;
            // Prevent duplicate save
            const last = hist[hist.length-1];
            if(!last || (Date.now() - new Date(last.date).getTime() > 5000)) {
                hist.push({ date: new Date().toISOString(), opponent: oppName, result: res });
                localStorage.setItem('chess_history', JSON.stringify(hist));
            }

            // Switch UI
            document.getElementById('play-controls').classList.add('hidden');
            document.getElementById('analysis-controls').classList.remove('hidden');
            
            isAnalysisMode = true;
            if(stockfishWorker) stockfishWorker.postMessage('position fen ' + chess.fen());
        }

        function exitGame() {
            if (gameUnsubscribe) gameUnsubscribe();
            chess.reset();
            showScreen('lobby');
            listenToLobby();
        }

        function playSound(type) {
            // Placeholder for sound (Browser often blocks auto audio)
        }

        // Modal Utils
        function showModalConfirm(title, msg, onYes) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = msg;
            const yesBtn = document.getElementById('modal-yes-btn');
            yesBtn.onclick = () => { onYes(); closeModal(); };
            document.getElementById('modal-confirm').classList.remove('hidden');
        }
        function closeModal() {
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.add('hidden'));
        }
        function showScreen(id) {
            ['screen-login', 'screen-lobby', 'screen-game'].forEach(sid => document.getElementById(sid).classList.add('hidden'));
            document.getElementById('screen-'+id).classList.remove('hidden');
        }

        initApp();
    </script>
</body>
</html>