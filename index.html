<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kingdom Chess</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <!-- Chess Logic -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Medieval Font -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">

    <style>
        :root { --wood-dark: #2b1d0e; --wood-light: #5d4037; --gold: #c5a059; --gold-dim: #8a6e3e; --parchment: #e6d2b5; }
        body { font-family: 'Cinzel', serif; background-color: #1a120b; background-image: radial-gradient(circle at center, #2c1e14 0%, #0f0a06 100%); color: var(--parchment); overflow: hidden; touch-action: none; }
        
        .medieval-panel { background: var(--wood-dark); border: 2px solid var(--gold-dim); box-shadow: 0 0 15px rgba(0,0,0,0.8), inset 0 0 20px rgba(0,0,0,0.5); position: relative; }
        .medieval-btn { background: linear-gradient(to bottom, #5d4037, #3e2723); border: 2px solid var(--gold-dim); color: var(--parchment); text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s; box-shadow: 0 4px 0 #271914; display: inline-flex; align-items: center; justify-content: center; }
        .medieval-btn:active { transform: translateY(4px); box-shadow: 0 0 0 #271914; }
        .medieval-btn.primary { background: linear-gradient(to bottom, #b8860b, #8b6508); color: #1a0f00; border-color: #ffd700; }
        .medieval-btn.danger { background: linear-gradient(to bottom, #8b0000, #500000); border-color: #ff4444; }
        .medieval-btn.selected { border-color: #ffd700; background: #8b6508; box-shadow: inset 0 0 10px #000; color: #fff; }
        .medieval-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }
        .medieval-input { background: #1a120b; border: 2px solid var(--gold-dim); color: var(--gold); font-family: 'MedievalSharp', cursive; }

        .board-container { display: flex; justify-content: center; align-items: center; width: 100%; height: calc(100vh - 160px); padding: 5px; }
        @media (min-width: 768px) { .board-container { height: 80vh; padding: 10px; } }

        .chess-board { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); aspect-ratio: 1/1; height: 100%; max-height: 100%; margin: 0 auto; border: 8px solid #3e2723; border-image: linear-gradient(#5d4037, #2b1d0e) 1; box-shadow: 0 20px 50px rgba(0,0,0,0.9); user-select: none; position: relative; touch-action: none; background-color: #334155; }
        #arrow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        .square { display: flex; justify-content: center; align-items: center; position: relative; width: 100%; height: 100%; z-index: 1; }
        .square.white { background-color: #e3c193; }
        .square.black { background-color: #8b5a2b; }
        .square.selected { box-shadow: inset 0 0 0 4px #ffd700; }
        .square.last-move { box-shadow: inset 0 0 0 4px rgba(100, 255, 100, 0.6); }
        .square.premove-source { background-color: rgba(220, 38, 38, 0.5) !important; }
        .square.premove-dest { background-color: rgba(220, 38, 38, 0.5) !important; box-shadow: inset 0 0 0 2px #ffaaaa; }
        .square.in-check { background: radial-gradient(ellipse at center, #8b0000 0%, transparent 70%) !important; }
        .square.possible-move::after { content: ''; width: 25%; height: 25%; background-color: rgba(0,0,0,0.4); border-radius: 50%; position: absolute; pointer-events: none; z-index: 2; }
        .piece { width: 100%; height: 100%; background-size: 90%; background-repeat: no-repeat; background-position: center; cursor: grab; z-index: 10; }
        .piece.dragging { opacity: 0.5; }
        #drag-ghost { position: fixed; width: 60px; height: 60px; background-size: contain; background-repeat: no-repeat; pointer-events: none; z-index: 9999; display: none; transform: translate(-50%, -50%); }
        .modal-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .timer-box { font-family: monospace; font-size: 1.2rem; font-weight: bold; padding: 4px 8px; border-radius: 4px; background: #1a0f00; border: 1px solid #5d4037; width: 70px; text-align: center; }
        .timer-active { background: #3e2723; border-color: #ffd700; color: #ffd700; box-shadow: 0 0 5px #ffd700; }
        .active-history { background-color: var(--gold-dim); color: #fff; }
        .lobby-tab { opacity: 0.5; border-bottom: 4px solid transparent; transition: all 0.3s; }
        .lobby-tab.active { opacity: 1; border-bottom: 4px solid var(--gold); background: rgba(197, 160, 89, 0.1); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col" oncontextmenu="return false;"> 

    <div id="drag-ghost"></div>

    <!-- MODALS -->
    <div id="modal-create" class="modal-overlay hidden">
        <div class="medieval-panel p-6 max-w-md w-full text-center rounded-lg m-4">
            <h2 class="text-xl mb-4 border-b border-yellow-900/50 pb-2">Buat Pertempuran</h2>
            <div class="grid grid-cols-2 gap-4 text-left">
                <div>
                    <label class="block text-[10px] text-yellow-600 mb-1 font-bold">PASUKAN</label>
                    <div class="flex gap-1 mb-4">
                        <button onclick="selectColor('white')" id="btn-color-white" class="flex-1 medieval-btn p-2"><i class="fas fa-chess-king text-white"></i></button>
                        <button onclick="selectColor('random')" id="btn-color-random" class="flex-1 medieval-btn p-2 selected"><i class="fas fa-random"></i></button>
                        <button onclick="selectColor('black')" id="btn-color-black" class="flex-1 medieval-btn p-2"><i class="fas fa-chess-king text-black"></i></button>
                    </div>
                    <div id="ai-settings" class="hidden">
                        <label class="block text-[10px] text-yellow-600 mb-1 font-bold">KEKUATAN MUSUH</label>
                        <select id="ai-elo" class="w-full medieval-input p-2 rounded text-xs text-center mb-4">
                            <option value="0">Pemula</option>
                            <option value="5">Menengah</option>
                            <option value="10">Ahli</option>
                            <option value="15">Master</option>
                            <option value="20">Grandmaster</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-yellow-600 mb-1 font-bold">WAKTU (MENIT)</label>
                    <div class="grid grid-cols-2 gap-1 mb-2">
                        <button onclick="selectTime(1)" id="btn-time-1" class="medieval-btn p-2 text-xs">1</button>
                        <button onclick="selectTime(3)" id="btn-time-3" class="medieval-btn p-2 text-xs">3</button>
                        <button onclick="selectTime(5)" id="btn-time-5" class="medieval-btn p-2 text-xs">5</button>
                        <button onclick="selectTime(10)" id="btn-time-10" class="medieval-btn p-2 text-xs selected">10</button>
                        <button onclick="selectTime(30)" id="btn-time-30" class="medieval-btn p-2 text-xs">30</button>
                        <button onclick="selectTime(-1)" id="btn-time--1" class="medieval-btn p-2 text-xs">∞</button>
                    </div>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <button onclick="closeModal('modal-create')" class="flex-1 medieval-btn py-2">Batal</button>
                <button id="btn-create-start" onclick="confirmCreateGame()" class="flex-1 medieval-btn primary py-2">Mulai</button>
            </div>
        </div>
    </div>

    <div id="modal-gameover" class="modal-overlay hidden">
        <div class="medieval-panel p-8 max-w-sm w-full text-center rounded-lg">
            <h2 id="go-title" class="text-2xl mb-2">Selesai</h2>
            <p id="go-message" class="text-slate-300 mb-6 font-medieval">...</p>
            <div class="flex flex-col gap-3">
                <button onclick="startAnalysisFromModal()" class="medieval-btn primary py-3 rounded">Analisis</button>
                <button onclick="closeModal('modal-gameover'); exitGame();" class="medieval-btn py-3 rounded">Kembali</button>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="modal-overlay hidden">
        <div class="medieval-panel p-6 max-w-sm w-full text-center rounded-lg">
            <h3 id="modal-title" class="text-lg mb-2">Konfirmasi</h3>
            <p id="modal-message" class="text-slate-300 mb-6 font-medieval">...</p>
            <div class="flex gap-3 justify-center">
                <button id="modal-no-btn" class="medieval-btn px-4 py-2 rounded">Batal</button>
                <button id="modal-yes-btn" class="medieval-btn danger px-4 py-2 rounded">Ya</button>
            </div>
        </div>
    </div>
    
    <div id="modal-request" class="modal-overlay hidden">
        <div class="medieval-panel p-6 max-w-sm w-full text-center rounded-lg">
            <h3 id="req-title" class="text-xl mb-2">Permintaan</h3>
            <p id="req-message" class="text-slate-300 mb-6 font-medieval">...</p>
            <div class="flex gap-3 justify-center">
                <button onclick="respondRequest(false)" class="medieval-btn danger px-4 py-2 rounded">Tolak</button>
                <button onclick="respondRequest(true)" class="medieval-btn primary px-4 py-2 rounded">Terima</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-[#1a0f00] px-3 py-2 shadow-lg flex justify-between items-center h-[50px] shrink-0 border-b-2 border-[#3e2723] z-50">
        <div class="flex items-center gap-2">
            <i class="fas fa-chess-knight text-yellow-600 text-lg"></i>
            <h1 class="text-base tracking-widest text-[#c5a059] hidden sm:block">Kingdom Chess</h1>
        </div>
        <div class="flex items-center gap-2">
            <button id="sound-toggle" onclick="toggleSound()" class="text-[#8a6e3e] hover:text-[#c5a059] px-2"><i class="fas fa-volume-up"></i></button>
            <div id="connection-status" class="text-[9px] px-2 py-0.5 rounded bg-black/50 text-green-500 border border-green-900">...</div>
            <span id="user-display" class="text-xs text-[#e6d2b5] font-bold truncate max-w-[80px]"></span>
            <button onclick="logout()" class="text-[10px] bg-[#3e2723] px-2 py-1 rounded text-[#e6d2b5] border border-[#5d4037]">Keluar</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 relative w-full h-full overflow-hidden flex flex-col md:flex-row">
        <!-- LOGIN -->
        <div id="screen-login" class="absolute inset-0 z-[60] flex flex-col items-center justify-center p-4 bg-black/90">
            <div class="medieval-panel p-8 max-w-xs w-full text-center rounded-lg">
                <i class="fas fa-shield-alt text-5xl text-yellow-600 mb-4"></i>
                <h2 class="text-2xl mb-1">Kingdom Chess</h2>
                <input type="text" id="username-input" class="w-full medieval-input rounded p-2 mb-4 text-center mt-4 outline-none" placeholder="Nama Anda...">
                <button onclick="handleLogin()" class="w-full medieval-btn primary py-2 rounded font-bold shadow-lg">Masuk</button>
            </div>
        </div>

        <!-- LOBBY -->
        <div id="screen-lobby" class="absolute inset-0 hidden flex flex-col z-[50] p-4">
            <div class="w-full max-w-6xl mx-auto flex flex-col h-full">
                <div class="medieval-panel p-3 rounded-lg mb-4 flex justify-between items-center shrink-0">
                    <span class="text-yellow-600 font-bold text-sm">Aula Utama</span>
                    <div class="flex gap-2">
                        <button onclick="openCreateGameModal('ai')" class="medieval-btn px-3 py-1.5 rounded text-xs shadow"><i class="fas fa-robot mr-1"></i>VS AI</button>
                        <button onclick="openCreateGameModal('human')" class="medieval-btn primary px-3 py-1.5 rounded text-xs shadow"><i class="fas fa-users mr-1"></i>Buat</button>
                    </div>
                </div>
                <div class="flex mb-2 gap-2 shrink-0 md:hidden">
                    <button onclick="switchLobbyTab('arena')" id="tab-btn-arena" class="lobby-tab active flex-1 medieval-btn p-2 rounded font-bold text-center text-xs"><i class="fas fa-chess-board mr-1"></i> ARENA</button>
                    <button onclick="switchLobbyTab('history')" id="tab-btn-history" class="lobby-tab flex-1 medieval-btn p-2 rounded font-bold text-center text-xs"><i class="fas fa-history mr-1"></i> RIWAYAT</button>
                </div>
                <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
                    <div id="lobby-panel-arena" class="flex-1 flex flex-col medieval-panel rounded-lg overflow-hidden">
                        <div class="p-3 bg-[#1a0f00] border-b border-[#5d4037] flex justify-between items-center"><span class="text-yellow-600 font-bold text-sm">Daftar Room</span><span class="text-[10px] text-stone-500">Auto-refresh</span></div>
                        <div id="room-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-[#23170f]"></div>
                    </div>
                    <div id="lobby-panel-history" class="hidden md:flex flex-1 flex-col medieval-panel rounded-lg overflow-hidden">
                        <div class="p-3 bg-[#1a0f00] border-b border-[#5d4037] text-yellow-600 font-bold text-sm">Jejak Pertempuran</div>
                        <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-2 bg-[#23170f]"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME -->
        <div id="screen-game" class="absolute inset-0 hidden flex flex-col md:flex-row z-[40]">
            <div class="flex-1 flex flex-col items-center justify-center relative min-h-0 bg-[#15100d]">
                <div class="w-full max-w-[80vh] flex justify-between items-end mb-1 px-2 mt-2">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-[#2b1d0e] border border-[#5d4037] flex items-center justify-center text-yellow-600"><i class="fas fa-user"></i></div>
                        <div><span id="opponent-name" class="font-bold text-xs block text-[#e6d2b5] truncate max-w-[100px]">Lawan</span><span id="game-status" class="text-[10px] text-yellow-500 font-mono"></span></div>
                    </div>
                    <div id="timer-opponent" class="timer-box text-white">--:--</div>
                </div>
                <div class="board-container">
                    <div id="chess-board" class="chess-board rounded-sm"></div>
                </div>
                <div class="w-full max-w-[80vh] flex justify-between items-start mt-1 px-2 mb-2">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-[#2b1d0e] border border-[#c5a059] flex items-center justify-center text-yellow-400"><i class="fas fa-user"></i></div>
                        <div><span id="player-name-display" class="font-bold text-xs block text-[#c5a059] truncate max-w-[100px]">Anda</span><span id="turn-indicator" class="text-[10px] text-stone-400">...</span></div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="flipBoard()" class="text-[#8a6e3e]"><i class="fas fa-sync-alt"></i></button>
                        <div id="timer-self" class="timer-box text-white">--:--</div>
                    </div>
                </div>
                <div class="md:hidden w-full flex justify-around p-2 bg-[#2b1d0e] border-t border-[#5d4037]">
                    <button onclick="reqTakeback()" class="text-stone-400 hover:text-white"><i class="fas fa-undo"></i></button>
                    <button onclick="reqDraw()" class="text-stone-400 hover:text-white"><i class="fas fa-handshake"></i></button>
                    <button onclick="confirmResign()" class="text-red-500 hover:text-red-400"><i class="fas fa-flag"></i></button>
                </div>
            </div>
            <div class="hidden md:flex w-[320px] medieval-panel border-l-4 border-[#2b1d0e] flex-col h-full shrink-0 z-20">
                <div class="flex bg-[#1a0f00] border-b border-[#5d4037] shrink-0">
                    <div class="flex-1 py-2 text-center text-xs font-bold text-[#c5a059] uppercase">Langkah</div>
                </div>
                <div class="flex-1 overflow-y-auto bg-[#23170f] p-0 custom-scroll" id="pgn-container">
                    <table class="w-full text-sm text-left border-collapse"><tbody id="move-history" class="text-[#e6d2b5] font-mono"></tbody></table>
                </div>
                <div class="bg-[#1a0f00] p-4 border-t border-[#5d4037] shrink-0">
                    <div id="play-controls" class="grid grid-cols-2 gap-2">
                        <button onclick="reqTakeback()" class="medieval-btn py-2 rounded text-xs">Mundur</button>
                        <button onclick="reqDraw()" class="medieval-btn py-2 rounded text-xs">Remis</button>
                        <button onclick="confirmResign()" class="medieval-btn danger col-span-2 py-2 rounded text-xs font-bold">MENYERAH / BATAL</button>
                    </div>
                    <div id="analysis-controls" class="hidden flex-col gap-2">
                        <div class="bg-[#2b1d0e] p-2 rounded border border-[#5d4037]">
                             <div class="flex justify-between mb-1"><span class="text-[10px] text-blue-400">EVAL</span><span id="eval-score" class="text-[10px]">0.0</span></div>
                             <div class="h-1 bg-black rounded-full overflow-hidden"><div id="eval-fill" class="h-full bg-white" style="width: 50%"></div></div>
                             <p id="best-move-text" class="text-[10px] text-center mt-1 text-[#c5a059]">...</p>
                        </div>
                        <button onclick="exitGame()" class="w-full medieval-btn py-2 rounded text-xs">KEMBALI</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const firebaseConfig={apiKey:"AIzaSyDmer19KTaijOz3bTdknEEs5dqwKNt6HQg",authDomain:"masjid-pekalongan.firebaseapp.com",projectId:"masjid-pekalongan",storageBucket:"masjid-pekalongan.firebasestorage.app",messagingSenderId:"619031365600",appId:"1:619031365600:web:35061354a11cf3f72e4d85",measurementId:"G-R511G99W8R"};
        try{firebase.initializeApp(firebaseConfig);}catch(e){}
        const auth=firebase.auth(), db=firebase.firestore(), appId='chess-v3-final';

        let currentUser=null, currentGameId=null, gameData=null;
        let chess=new Chess(), boardOrientation='white', playerColor='white', stockfishWorker=null, gameUnsubscribe=null;
        let soundEnabled=true, selectedSquare=null, premoveQueue=[], draggedPiece=null, isDragging=false, dragStartSquare=null, hasMoved=false;
        let arrows=[], circleHighlights=[], isRightClicking=false, rightClickStart=null, rightClickCurrent=null;
        let isAI=false, isAnalysisMode=false, viewHistoryIndex=-1, isReplayMode=false;
        let aiLevel=5, whiteTime=600, blackTime=600, timerInterval=null, selectedTime=10, selectedColor='random', windowPendingGameType='human', aiTimeout=null;
        
        // DEVICE DETECTION
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        const audioFiles = {
            move: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3',
            capture: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3',
            check: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/notify.mp3',
            start: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-start.mp3', 
            end: 'https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3'
        };
        function getPieceUrl(c, t) { return `https://images.chesscomfiles.com/chess-themes/pieces/neo/150/${c}${t}.png`; }

        async function initApp() {
            try { const b = await fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js').then(r => r.blob()); stockfishWorker = new Worker(URL.createObjectURL(b)); stockfishWorker.onmessage = handleStockfishMessage; } catch (e) {}
            const s = localStorage.getItem('chess_username'); if (s) document.getElementById('username-input').value = s;
            auth.onAuthStateChanged((u) => { if (u) { currentUser = u; updateConnectionStatus(true); if (s && !document.getElementById('screen-login').classList.contains('hidden')) handleLogin(); } else { updateConnectionStatus(false); auth.signInAnonymously(); } });
            
            // Interaction Event Listeners based on Device
            if (isMobile) {
                // Mobile: Only clicks
                // We don't attach drag listeners to pieces
            } else {
                // Desktop: Drag & Drop (and right click)
                document.addEventListener('mousemove', moveGhost); 
                document.addEventListener('mouseup', endDrag);
                document.addEventListener('contextmenu', e => e.preventDefault());
            }
        }

        // --- INTERACTION LOGIC (SPLIT) ---
        
        // COMMON: Square Click Handler
        function onSquareClick(square) {
            if (arrows.length > 0 || circleHighlights.length > 0) clearArrowsAndHighlights();
            if (viewHistoryIndex !== -1) return;

            const piece = chess.get(square);
            const myColor = playerColor.charAt(0);
            
            // Premove Cancellation (Any click outside valid move flow)
            if (premoveQueue.length > 0) {
                if (chess.turn() === myColor) {
                    // My turn now, clear queue
                    premoveQueue = []; renderBoard();
                } else {
                    // Opponent turn
                    // Mobile: Click empty or invalid -> Cancel
                    if (!piece || piece.color !== myColor) {
                        // Is this a destination click for current selection?
                        if (selectedSquare) {
                            handleMoveAttempt(selectedSquare, square);
                            return;
                        }
                        premoveQueue = []; renderBoard();
                    }
                }
            }

            if (selectedSquare === null) {
                if (piece) { selectedSquare = square; renderBoard(); }
            } else {
                if (selectedSquare === square) { selectedSquare = null; renderBoard(); return; }
                
                // Allow switching selection to own piece (unless specific premove capture logic)
                if (piece && piece.color === myColor && !isAnalysisMode) { 
                    // Mobile Premove Exception: If it's opponent turn, and I click Piece A then Piece B (both mine), 
                    // and Piece B is a valid target for A (capture own piece logic for coordinates), treat as move.
                    // But standard chess, you can't capture own piece.
                    // So switching is fine.
                    selectedSquare = square; renderBoard(); return; 
                }

                handleMoveAttempt(selectedSquare, square);
            }
        }

        // DESKTOP: Drag Start
        function startDrag(e, square, el) {
            if (isMobile) return; // Disable drag on mobile
            if (!isAnalysisMode && viewHistoryIndex !== -1) return;
            e.preventDefault(); 
            isDragging = true; dragStartSquare = square; draggedPiece = el;
            selectedSquare = square; renderBoard(); 
            const ghost = document.getElementById('drag-ghost');
            if(ghost) { ghost.style.backgroundImage = el.style.backgroundImage; ghost.style.display = 'block'; moveGhost(e); }
        }
        
        function moveGhost(e) {
            if(!isDragging) return;
            const ghost = document.getElementById('drag-ghost');
            if(ghost) { ghost.style.left = e.clientX + 'px'; ghost.style.top = e.clientY + 'px'; }
        }
        
        function endDrag(e) {
            if(!isDragging) return;
            isDragging = false;
            const ghost = document.getElementById('drag-ghost');
            if(ghost) ghost.style.display = 'none'; 
            
            const el = document.elementsFromPoint(e.clientX, e.clientY).find(el => el.classList.contains('square'));
            if (el) {
                const target = el.dataset.square;
                if (target !== dragStartSquare) handleMoveAttempt(dragStartSquare, target);
                else onSquareClick(target); // Click on same square
            }
        }

        function handleMoveAttempt(from, to) {
            if (isAnalysisMode) {
                if(chess.move({ from, to, promotion: 'q' })) {
                    renderBoard(); updateMoveHistoryUI(); playSound('move');
                    if(stockfishWorker) { stockfishWorker.postMessage('position fen '+chess.fen()); stockfishWorker.postMessage('go depth 15'); }
                } else { selectedSquare = null; renderBoard(); }
                return;
            }

            const myColor = playerColor.charAt(0);
            
            if (chess.turn() === myColor) {
                const move = chess.move({ from, to, promotion: 'q' });
                selectedSquare = null;
                if (move) {
                    clearArrowsAndHighlights();
                    renderBoard(); updateMoveHistoryUI();
                    if(chess.in_check()) playSound('check'); else if(move.flags.includes('c')) playSound('capture'); else playSound('move');
                    startTimer(); 
                    if (isAI) { checkGameOver(true); setTimeout(makeAIMove, 500); } else { pushMoveToFirestore(); }
                } else { renderBoard(); }
            } 
            else {
                // PREMOVE LOGIC
                // Prevent impossible geometry (e.g. Knight moving like Rook)
                // Use temp board with swapped turn to validate geometry
                const temp = new Chess(chess.fen());
                const tokens = temp.fen().split(' ');
                tokens[1] = myColor; // Force turn
                const fenForce = tokens.join(' ');
                if(temp.load(fenForce)) {
                    if (temp.move({ from, to, promotion: 'q' })) {
                        premoveQueue.push({ from, to });
                        selectedSquare = null;
                        renderBoard();
                    } else { selectedSquare = null; renderBoard(); } // Invalid geometry
                } else { selectedSquare = null; renderBoard(); }
            }
        }

        // --- FIREBASE & TIMER SYNC ---
        async function pushMoveToFirestore() {
            if (!currentGameId) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                fen: chess.fen(), pgn: chess.pgn(), lastMove: { t: Date.now() }, whiteTime: whiteTime, blackTime: blackTime
            });
            checkGameOver(true);
        }

        function startGameFirestore(id, o) {
            setupGameCommon(id, o, "Menunggu...");
            if(gameUnsubscribe) gameUnsubscribe();
            
            gameUnsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id).onSnapshot(doc => {
                if(!doc.exists) return;
                gameData = doc.data();
                
                const opp = o==='white'?gameData.black:gameData.white;
                const el=document.getElementById('opponent-name');
                if(el)el.innerText=opp?opp.name:"Menunggu...";
                
                if (gameData.whiteTime !== undefined) whiteTime = gameData.whiteTime;
                if (gameData.blackTime !== undefined) blackTime = gameData.blackTime;
                updateTimerDisplay();

                if(gameData.status==='playing'&&document.getElementById('timer-self').innerText==="--:--"){ 
                    selectedTime=gameData.timeControl||10; 
                    const t=selectedTime===-1?999999:selectedTime*60; 
                    if(whiteTime === 600 && blackTime === 600) { whiteTime=t; blackTime=t; }
                    updateTimerDisplay(); startTimer(); playSound('start'); 
                } 
                
                if(gameData.requests?.status==='pending'&&gameData.requests.sender!==currentUser.uid) showRequestModal(gameData.requests.type); 
                
                if(viewHistoryIndex===-1 && gameData.fen && gameData.fen!=='start' && chess.fen()!==gameData.fen){ 
                    if(gameData.pgn)chess.load_pgn(gameData.pgn); else chess.load(gameData.fen); 
                    processPremoves(); 
                    const last=chess.history({verbose:true}).pop(); 
                    if(chess.in_check())playSound('check'); else if(last&&last.flags.includes('c'))playSound('capture'); else playSound('move'); 
                    renderBoard(); updateMoveHistoryUI(); checkGameOver(false); startTimer(); 
                } 
                
                if(gameData.status==='finished'&&!isAnalysisMode){ 
                    clearInterval(timerInterval); 
                    let r='draw'; 
                    if(gameData.winner!=='draw') r=gameData.winner===localStorage.getItem('chess_username')?'win':'loss'; 
                    handleGameOver(r); 
                } 
            });
        }

        function processPremoves() {
            if (premoveQueue.length === 0) return;
            const moveData = premoveQueue.shift();
            const move = chess.move({ from: moveData.from, to: moveData.to, promotion: 'q' });
            if (move) {
                clearArrowsAndHighlights();
                playSound('move');
                if (!isAI) pushMoveToFirestore();
                if (premoveQueue.length > 0) setTimeout(processPremoves, 200);
            } else { premoveQueue = []; playSound('check'); }
        }

        // --- RENDER ---
        function renderBoard() {
            const boardEl = document.getElementById('chess-board'); if(!boardEl) return;
            boardEl.innerHTML = '<svg id="arrow-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>';

            let boardState = chess.board();
            if (viewHistoryIndex !== -1) { const t = new Chess(); const h = chess.history(); for(let i=0; i<=viewHistoryIndex; i++) t.move(h[i]); boardState = t.board(); }
            else if (premoveQueue.length > 0) {
                premoveQueue.forEach(pm => {
                    const fC = pm.from.charCodeAt(0)-97, fR = 8-parseInt(pm.from[1]);
                    const tC = pm.to.charCodeAt(0)-97, tR = 8-parseInt(pm.to[1]);
                    if(boardState[fR][fC]) { boardState[tR][tC] = boardState[fR][fC]; boardState[fR][fC] = null; }
                });
            }

            const rows = boardOrientation === 'white' ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            const cols = boardOrientation === 'white' ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            const lastMove = chess.history({verbose:true}).pop();

            rows.forEach(r => {
                cols.forEach(c => {
                    const square = String.fromCharCode(97+c) + (8-r);
                    const piece = boardState[r][c];
                    const div = document.createElement('div');
                    div.className = `square ${(r+c)%2===0 ? 'white' : 'black'}`;
                    div.dataset.square = square;

                    if (selectedSquare === square) div.classList.add('selected');
                    if (viewHistoryIndex === -1 && lastMove && (lastMove.from === square || lastMove.to === square)) div.classList.add('last-move');
                    const pmIndex = premoveQueue.findIndex(pm => pm.from === square || pm.to === square);
                    if (pmIndex !== -1) { const pm = premoveQueue[pmIndex]; if (pm.from === square) div.classList.add('premove-source'); if (pm.to === square) div.classList.add('premove-dest'); }
                    if (piece && piece.type === 'k' && chess.in_check() && piece.color === chess.turn() && viewHistoryIndex === -1 && premoveQueue.length===0) div.classList.add('in-check');
                    if (circleHighlights.includes(square)) div.classList.add('circle-highlight');
                    if (selectedSquare && viewHistoryIndex === -1) { if (chess.turn() === playerColor.charAt(0) || isAnalysisMode) { const moves = chess.moves({square: selectedSquare, verbose: true}); if (moves.find(m => m.to === square)) div.classList.add('possible-move'); } }
                    if (piece) {
                        const img = document.createElement('div'); img.className = 'piece'; 
                        if (premoveQueue.length > 0 && premoveQueue.some(pm => pm.to === square)) img.classList.add('premove-piece');
                        img.style.backgroundImage = `url('${getPieceUrl(piece.color, piece.type)}')`;
                        
                        // DESKTOP DRAG ONLY
                        if (!isMobile && viewHistoryIndex === -1 && (isAnalysisMode || piece.color === playerColor.charAt(0))) {
                            img.addEventListener('mousedown', (e) => { if(e.button===0) startDrag(e, square, img); });
                        }
                        // MOBILE: NO DRAG LISTENERS ATTACHED
                        
                        div.appendChild(img);
                    }
                    
                    // Click Listener (Both)
                    div.onclick = () => onSquareClick(square);
                    
                    // Right Click (Desktop)
                    if(!isMobile) {
                        div.addEventListener('mousedown', (e) => { if(e.button===2) handleRightClickDown(e, square); });
                        div.addEventListener('mouseup', (e) => { if(e.button===2) handleRightClickUp(e, square); });
                        div.addEventListener('mouseenter', (e) => handleRightClickMove(e, square)); 
                    }
                    boardEl.appendChild(div);
                });
            });
            drawArrows(); updateStatusText();
        }

        // --- Standard Logic & Utils ---
        function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('sound-toggle').innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute text-red-500"></i>'; }
        function updateConnectionStatus(c) { document.getElementById('connection-status').innerText = c ? "Online" : "Offline"; }
        async function handleLogin() { const n = document.getElementById('username-input').value.trim(); if(n) { localStorage.setItem('chess_username', n); document.getElementById('user-display').innerText = n; showScreen('lobby'); listenToLobby(); loadHistory(); } }
        function logout() { localStorage.removeItem('chess_username'); location.reload(); }
        function showScreen(id) { ['screen-login','screen-lobby','screen-game'].forEach(s=>document.getElementById(s).classList.add('hidden')); document.getElementById('screen-'+id).classList.remove('hidden'); }
        function flipBoard() { boardOrientation=boardOrientation==='white'?'black':'white'; renderBoard(); }
        function switchLobbyTab(tab) {
            const pa = document.getElementById('lobby-panel-arena'), ph = document.getElementById('lobby-panel-history'), ba = document.getElementById('tab-btn-arena'), bh = document.getElementById('tab-btn-history');
            if (tab === 'arena') { pa.classList.remove('hidden'); ph.classList.add('hidden'); ba.classList.add('active'); bh.classList.remove('active'); } 
            else { pa.classList.add('hidden'); ph.classList.remove('hidden'); ph.classList.remove('md:flex'); ph.classList.add('flex'); bh.classList.add('active'); ba.classList.remove('active'); }
        }
        function startTimer() { if (timerInterval) clearInterval(timerInterval); if (isAnalysisMode || (gameData && gameData.status !== 'playing') || selectedTime === -1) return; timerInterval = setInterval(() => { if (chess.turn() === 'w') { whiteTime--; if (whiteTime <= 0) handleFlagFall('white'); } else { blackTime--; if (blackTime <= 0) handleFlagFall('black'); } updateTimerDisplay(); }, 1000); }
        function updateTimerDisplay() { if (selectedTime === -1) { const w=document.getElementById('timer-self'), b=document.getElementById('timer-opponent'); if(w)w.innerText="∞"; if(b)b.innerText="∞"; return; } const fmt=t=>{ const m=Math.floor(t/60), s=t%60; return `${m}:${s<10?'0'+s:s}`; }; const elSelf=document.getElementById('timer-self'), elOpp=document.getElementById('timer-opponent'); if(playerColor==='white'){elSelf.innerText=fmt(whiteTime);elOpp.innerText=fmt(blackTime);if(chess.turn()==='w'){elSelf.classList.add('timer-active');elOpp.classList.remove('timer-active');}else{elOpp.classList.add('timer-active');elSelf.classList.remove('timer-active');}}else{elSelf.innerText=fmt(blackTime);elOpp.innerText=fmt(whiteTime);if(chess.turn()==='b'){elSelf.classList.add('timer-active');elOpp.classList.remove('timer-active');}else{elOpp.classList.add('timer-active');elSelf.classList.remove('timer-active');}} }
        function handleFlagFall(c) { clearInterval(timerInterval); let r = c==='white'?'loss':'win'; handleGameOver(r); if(!isAI&&currentGameId){ const w=c==='white'?(gameData.black?.name||'Black'):(gameData.white?.name||'White'); db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({status:'finished',winner:w,reason:'timeout'}).catch(()=>{}); } }
        function startGameLocal(id, o, n) { setupGameCommon(id, o, n); whiteTime = selectedTime===-1?999999:selectedTime*60; blackTime = whiteTime; updateTimerDisplay(); playSound('start'); if(o==='black') setTimeout(makeAIMove, 500); else startTimer(); }
        
        function setupGameCommon(id, o, n) { currentGameId=id; boardOrientation=o; playerColor=o; chess.reset(); isAnalysisMode=false; premoveQueue=[]; viewHistoryIndex=-1; selectedSquare=null; const elO=document.getElementById('opponent-name'), elM=document.getElementById('player-name-display'); if(elO)elO.innerText=n; if(elM)elM.innerText=localStorage.getItem('chess_username'); showScreen('game'); document.getElementById('play-controls').classList.remove('hidden'); document.getElementById('analysis-controls').classList.add('hidden'); renderBoard(); updateMoveHistoryUI(); }
        function makeAIMove(){ if(chess.game_over())return; document.getElementById('game-status').innerText="AI Berpikir..."; if(stockfishWorker){ stockfishWorker.postMessage('position fen '+chess.fen()); stockfishWorker.postMessage('setoption name Skill Level value '+aiLevel); const d=[1,3,6,10,14][Math.floor(aiLevel/5)]||5; stockfishWorker.postMessage('go depth '+d); window.awaitingAI=true; if(aiTimeout)clearTimeout(aiTimeout); aiTimeout=setTimeout(()=>{if(window.awaitingAI){window.awaitingAI=false;const m=chess.moves();chess.move(m[Math.floor(Math.random()*m.length)]);finalizeAIMove();}},3000); } else { const m=chess.moves(); chess.move(m[Math.floor(Math.random()*m.length)]); finalizeAIMove(); } }
        function finalizeAIMove() { renderBoard(); updateMoveHistoryUI(); if(chess.in_check())playSound('check'); else playSound('move'); checkGameOver(true); startTimer(); document.getElementById('game-status').innerText=""; setTimeout(processPremoves, 200); }
        function handleStockfishMessage(e){ if(window.awaitingAI && e.data.startsWith('bestmove')){ window.awaitingAI=false; if(aiTimeout) clearTimeout(aiTimeout); chess.move(e.data.split(' ')[1],{sloppy:true}); finalizeAIMove(); } if(isAnalysisMode && e.data.startsWith('info') && e.data.includes('score cp')){ const m=e.data.match(/score cp (-?\d+)/); if(m){ let cp=parseInt(m[1]); if(chess.turn()==='b')cp=-cp; const f=document.getElementById('eval-fill'), s=document.getElementById('eval-score'); if(f)f.style.width=Math.max(5,Math.min(95,50+(cp/10)))+'%'; if(s)s.innerText=(cp/100).toFixed(2); } } if(isAnalysisMode && e.data.startsWith('bestmove')){ const el=document.getElementById('best-move-text'); if(el)el.innerText="Saran: "+e.data.split(' ')[1]; } }
        function checkGameOver(l){ if(chess.game_over()){ let r='draw'; if(chess.in_checkmate()) r=chess.turn()===playerColor.charAt(0)?'loss':'win'; handleGameOver(r); if(l&&!isAI) db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({status:'finished',winner:r==='win'?localStorage.getItem('chess_username'):document.getElementById('opponent-name').innerText}); } }
        function handleGameOver(res){ clearInterval(timerInterval); document.getElementById('go-title').innerText=res==='win'?"KEMENANGAN!":(res==='loss'?"KEKALAHAN":"REMIS"); document.getElementById('go-message').innerText=res==='win'?"Musuh tumbang.":"Istana runtuh."; document.getElementById('modal-gameover').classList.remove('hidden'); playSound('end'); const h=JSON.parse(localStorage.getItem('chess_history')||'[]'); const o=document.getElementById('opponent-name').innerText; if(!h.length || (Date.now()-new Date(h[h.length-1].date).getTime()>5000)) { h.push({date:new Date().toISOString(),opponent:o,result:res,pgn:chess.pgn()}); localStorage.setItem('chess_history',JSON.stringify(h)); } }
        function startAnalysisFromModal(){ closeModal('modal-gameover'); document.getElementById('play-controls').classList.add('hidden'); document.getElementById('analysis-controls').classList.remove('hidden'); isAnalysisMode=true; if(stockfishWorker) stockfishWorker.postMessage('position fen '+chess.fen()); }
        function exitGame(){ if(gameUnsubscribe) gameUnsubscribe(); clearInterval(timerInterval); chess.reset(); isReplayMode=false; showScreen('lobby'); switchLobbyTab('arena'); listenToLobby(); loadHistory(); }
        function updateMoveHistoryUI(){ const t=document.getElementById('move-history'); if(!t)return; t.innerHTML=''; const h=chess.history(); for(let i=0;i<h.length;i+=2) t.innerHTML+=`<tr class="border-b border-[#3e2723] hover:bg-[#2b1d0e]"><td class="px-3 py-2 text-stone-500 w-10 border-r border-[#3e2723]">${(i/2)+1}.</td><td class="px-3 py-2 cursor-pointer hover:text-white">${h[i]}</td><td class="px-3 py-2 cursor-pointer hover:text-white">${h[i+1]||''}</td></tr>`; if(viewHistoryIndex===-1) document.getElementById('pgn-container').scrollTop=99999; }
        function playSound(t){ if(soundEnabled && audioFiles[t]){ const s=new Audio(audioFiles[t]); s.volume=1; s.play().catch(()=>{}); } }
        async function pushMoveToFirestore(){ if(currentGameId) await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({fen:chess.fen(),pgn:chess.pgn(),lastMove:{t:Date.now()},whiteTime:whiteTime,blackTime:blackTime}); checkGameOver(true); }
        async function reqTakeback(){ if(isAI){ chess.undo(); chess.undo(); renderBoard(); updateMoveHistoryUI(); playSound('notify'); return; } showModalConfirm("MUNDUR?", "Minta mundur ke lawan?", async ()=>{ await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({requests:{type:'takeback',sender:currentUser.uid,status:'pending'}}); }); }
        async function reqDraw(){ showModalConfirm("REMIS?", "Ajukan remis?", async ()=>{ await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({requests:{type:'draw',sender:currentUser.uid,status:'pending'}}); }); }
        function confirmResign(){ if(document.getElementById('game-status').innerText==="Menunggu..."){ db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).delete(); exitGame(); return; } showModalConfirm("MENYERAH?","YAKIN?",()=>{ handleGameOver('loss'); if(!isAI) db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({status:'finished', winner:document.getElementById('opponent-name').innerText}); }); }
        async function respondRequest(acc){ document.getElementById('modal-request').classList.add('hidden'); if(acc){ if(gameData.requests.type==='takeback'){ const t=new Chess(); t.load_pgn(chess.pgn()); t.undo(); if(t.turn()!==(gameData.requests.sender===gameData.white.id?'w':'b')) t.undo(); await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({fen:t.fen(),pgn:t.pgn(),requests:{status:'accepted'}}); } else if(gameData.requests.type==='draw'){ await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({status:'finished', winner:'draw', requests:{status:'accepted'}}); } } else { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({requests:{status:'rejected'}}); } }
        function handleRightClickDown(e,s){if(!s)return;isRightClicking=true;rightClickStart=s;rightClickCurrent=s;}
        function handleRightClickMove(e,s){if(isRightClicking&&s&&rightClickCurrent!==s){rightClickCurrent=s;drawArrows();}}
        function handleRightClickUp(e,s){ if(!isRightClicking)return; isRightClicking=false; if(rightClickStart===s){const i=circleHighlights.indexOf(s);if(i>-1)circleHighlights.splice(i,1);else circleHighlights.push(s);}else if(s){const i=arrows.findIndex(a=>a.from===rightClickStart&&a.to===s);if(i>-1)arrows.splice(i,1);else arrows.push({from:rightClickStart,to:s});} rightClickStart=null;rightClickCurrent=null;renderBoard();}
        function clearArrowsAndHighlights(){arrows=[];circleHighlights=[];renderBoard();}
        function drawArrows(){ const svg=document.getElementById('arrow-layer');if(!svg)return;svg.innerHTML=''; const getC=s=>{const c=s.charCodeAt(0)-97,r=8-parseInt(s[1]);return{x:((boardOrientation==='white'?c:7-c)*12.5)+6.25,y:((boardOrientation==='white'?r:7-r)*12.5)+6.25};}; arrows.forEach(a=>renderArrowSvg(svg,getC(a.from),getC(a.to),'#10b981')); if(isRightClicking&&rightClickStart&&rightClickCurrent&&rightClickStart!==rightClickCurrent)renderArrowSvg(svg,getC(rightClickStart),getC(rightClickCurrent),'#fbbf24',0.6); }
        function renderArrowSvg(svg,s,e,c,o=0.9){ const ang=Math.atan2(e.y-s.y,e.x-s.x), end={x:e.x-3*Math.cos(ang),y:e.y-3*Math.sin(ang)}, id=`a-${Math.random().toString(36).substr(2)}`; const d=document.createElementNS("http://www.w3.org/2000/svg","defs"), m=document.createElementNS("http://www.w3.org/2000/svg","marker"); m.setAttribute("id",id);m.setAttribute("markerWidth",4);m.setAttribute("markerHeight",4);m.setAttribute("refX",2);m.setAttribute("refY",2);m.setAttribute("orient","auto"); const p=document.createElementNS("http://www.w3.org/2000/svg","path"); p.setAttribute("d","M0,0 L4,2 L0,4 Z");p.setAttribute("fill",c);p.setAttribute("fill-opacity",o); m.appendChild(p);d.appendChild(m);svg.appendChild(d); const l=document.createElementNS("http://www.w3.org/2000/svg","line"); l.setAttribute("x1",s.x);l.setAttribute("y1",s.y);l.setAttribute("x2",end.x);l.setAttribute("y2",end.y); l.setAttribute("stroke",c);l.setAttribute("stroke-width",2.5);l.setAttribute("stroke-opacity",o);l.setAttribute("marker-end",`url(#${id})`); svg.appendChild(l); }
        function updateStatusText() { const el = document.getElementById('turn-indicator'); if(!el) return; if(viewHistoryIndex!==-1) { el.innerText="REPLAY"; el.className="text-xs font-bold text-yellow-500"; return; } if(chess.turn()===boardOrientation.charAt(0)) { el.innerText="GILIRAN ANDA"; el.className="text-xs font-bold text-green-400 animate-pulse"; } else { el.innerText="GILIRAN LAWAN"; el.className="text-xs font-bold text-slate-500"; } const statusEl = document.getElementById('game-status'); if(statusEl) statusEl.innerText = chess.in_check() ? "SKAK!" : ""; }
        function openCreateGameModal(t) { windowPendingGameType=t; document.getElementById('modal-create').classList.remove('hidden'); document.getElementById('ai-settings').classList.toggle('hidden', t!=='ai'); selectTime(10); selectColor('random'); }
        function selectColor(c) { selectedColor=c; ['white','random','black'].forEach(x=>document.getElementById(`btn-color-${x}`).classList.toggle('selected', x===c)); }
        function selectTime(t) { selectedTime=t; [1,3,5,10,30,-1].forEach(x=>document.getElementById(`btn-time-${x}`).classList.toggle('selected', x===t)); }
        function confirmCreateGame() { if(windowPendingGameType==='ai') aiLevel=document.getElementById('ai-elo').value; document.getElementById('modal-create').classList.add('hidden'); createGameExec(windowPendingGameType); }
        
        // FIXED MODAL CANCEL
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function showModalConfirm(t,m,y) { 
            document.getElementById('modal-title').innerText=t; 
            document.getElementById('modal-message').innerText=m; 
            document.getElementById('modal-yes-btn').onclick=()=>{y();closeModal('modal-confirm');}; 
            document.getElementById('modal-no-btn').onclick=()=>{closeModal('modal-confirm');};
            document.getElementById('modal-confirm').classList.remove('hidden'); 
        }
        function showRequestModal(t) { document.getElementById('req-title').innerText = t==='takeback'?'Minta Mundur':'Tawaran Remis'; document.getElementById('req-message').innerText = "Lawan meminta persetujuan."; document.getElementById('modal-request').classList.remove('hidden'); }
        async function createGameExec(type) { if(!currentUser) return alert("Koneksi terputus!"); try { const gameId = currentUser.uid + '_' + Date.now(); const myName = localStorage.getItem('chess_username'); let white = null, black = null, orient = 'white'; if (selectedColor === 'random') selectedColor = Math.random() < 0.5 ? 'white' : 'black'; if (selectedColor === 'white') { white = { name: myName, id: currentUser.uid }; orient = 'white'; } else { black = { name: myName, id: currentUser.uid }; orient = 'black'; } if (type === 'ai') { isAI = true; const aiName = `Stockfish (Lv.${aiLevel})`; if(orient==='white') black = {name: aiName, id:'ai'}; else white = {name: aiName, id:'ai'}; startGameLocal(gameId, orient, aiName); } else { isAI = false; await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(gameId).set({ white, black, fen: 'start', pgn: '', status: 'waiting', timeControl: selectedTime, createdAt: firebase.firestore.FieldValue.serverTimestamp(), requests: {} }); startGameFirestore(gameId, orient); } } catch(e) { alert(e.message); } }
        function listenToLobby() { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').where('status', '==', 'waiting').limit(50).onSnapshot((snap) => { const listEl = document.getElementById('room-list'); if(!listEl) return; listEl.innerHTML = ''; if (snap.empty) { listEl.innerHTML = '<div class="text-center text-stone-500 py-4 text-xs italic">Belum ada tantangan.</div>'; return; } let games = []; const now = Date.now(); snap.forEach(doc => { const d = doc.data(); if (!d.createdAt) return; if ((now - d.createdAt.toMillis() > 3600000) || (d.white && d.black)) { db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(doc.id).delete().catch(()=>{}); return; } games.push({id: doc.id, ...d}); }); games.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); games.forEach(g => { if (g.white?.id === currentUser?.uid || g.black?.id === currentUser?.uid) return; const hostName = g.white ? g.white.name : (g.black ? g.black.name : "Unknown"); const time = g.timeControl === -1 ? "∞" : g.timeControl; const div = document.createElement('div'); div.className = "bg-[#2b1d0e] p-3 rounded flex justify-between items-center border border-[#5d4037] mb-2 hover:border-yellow-600 transition"; div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-[#1a0f00] flex items-center justify-center border border-[#5d4037]"><i class="fas ${g.white ? 'fa-chess-king text-[#e6d2b5]' : 'fa-chess-king text-black'}"></i></div><div><span class="block text-sm font-bold text-[#c5a059] font-medieval">${hostName}</span><span class="text-[10px] text-stone-500">${time} Menit</span></div></div><button onclick="joinGame('${g.id}', this)" class="medieval-btn px-4 py-1.5 rounded text-xs shadow-lg"><i class="fas fa-swords mr-1"></i> LAWAN</button>`; listEl.appendChild(div); }); }); }
        function loadHistory() { const histList = document.getElementById('history-list'); if(!histList) return; const history = JSON.parse(localStorage.getItem('chess_history') || '[]'); histList.innerHTML = ''; if (history.length === 0) { histList.innerHTML = '<div class="text-center text-stone-500 py-4 text-xs italic">Belum ada jejak pertempuran.</div>'; return; } history.reverse().slice(0, 10).forEach(game => { const el = document.createElement('div'); const color = game.result === 'win' ? 'text-green-500' : (game.result === 'loss' ? 'text-red-500' : 'text-yellow-500'); el.className = "bg-[#2b1d0e] p-3 rounded text-xs mb-2 border border-[#5d4037] flex justify-between items-center cursor-pointer hover:border-yellow-600 transition"; el.innerHTML = `<div class="flex flex-col"><span class="text-[#c5a059] font-bold">vs ${game.opponent}</span><span class="text-[10px] text-stone-500">${new Date(game.date).toLocaleDateString()}</span></div><span class="${color} font-bold uppercase border border-stone-600 px-2 py-1 rounded bg-black/30">${game.result}</span>`; el.onclick = () => loadReplayGame(game); histList.appendChild(el); }); }
        function loadReplayGame(game) { currentGameId = null; isReplayMode = true; isAnalysisMode = true; boardOrientation = 'white'; if (!game.pgn) return alert("Arsip rusak."); chess.load_pgn(game.pgn); viewHistoryIndex = -1; document.getElementById('opponent-name').innerText = game.opponent; showScreen('game'); document.getElementById('play-controls').classList.add('hidden'); document.getElementById('analysis-controls').classList.remove('hidden'); renderBoard(); updateMoveHistoryUI(); if(stockfishWorker) { stockfishWorker.postMessage('position fen '+chess.fen()); stockfishWorker.postMessage('go depth 15'); } }
        async function joinGame(id) { isAI = false; try { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id).update({ black: { name: localStorage.getItem('chess_username'), id: currentUser.uid }, status: 'playing' }); startGameFirestore(id, 'black'); } catch(e) { alert("Penuh/Hilang"); } }

        initApp();
    </script>
</body>
</html>