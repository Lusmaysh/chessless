<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catur Master Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <!-- Chess Logic & Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; }
        
        .chess-board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            
            /* MOBILE DEFAULT SIZE (Agar muat dengan tombol) */
            width: 90vw;
            height: 90vw;
            max-width: 48vh; 
            max-height: 48vh;
            
            margin: 0 auto;
            border: 3px solid #334155;
            user-select: none;
            touch-action: none; 
            position: relative;
            background-color: #334155;
        }

        /* DESKTOP/TABLET SIZE */
        @media (min-width: 768px) {
            .chess-board {
                max-width: 75vh;
                max-height: 75vh;
            }
        }

        #arrow-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;
        }

        .square {
            display: flex; justify-content: center; align-items: center;
            position: relative; width: 100%; height: 100%; z-index: 1;
        }

        .square.white { background-color: #ebecd0; }
        .square.black { background-color: #739552; }
        
        .square.selected { background-color: #f5f682 !important; } 
        .square.last-move { background-color: #baca44 !important; } 
        .square.premove { background-color: #f43f5e !important; opacity: 0.8; }
        .square.viewing-history { background-color: #64748b !important; opacity: 0.8; }
        .square.in-check { background: radial-gradient(ellipse at center, #ef4444 0%, #ef4444 40%, transparent 80%) !important; }

        .square.possible-move::after {
            content: ''; width: 30%; height: 30%;
            background-color: rgba(0, 0, 0, 0.3); border-radius: 50%;
            position: absolute; pointer-events: none; z-index: 2;
        }
        
        .piece {
            width: 100%; height: 100%;
            background-size: 85%; background-repeat: no-repeat; background-position: center;
            cursor: grab; z-index: 10; 
        }
        .piece.dragging { opacity: 0.5; }

        .circle-highlight::before {
            content: ''; position: absolute; width: 90%; height: 90%;
            border-radius: 50%; background-color: rgba(255, 170, 0, 0.5);
            pointer-events: none; z-index: 4;
        }

        #drag-ghost {
            position: fixed; width: 60px; height: 60px;
            background-size: contain; background-repeat: no-repeat;
            pointer-events: none; z-index: 9999; display: none;
            transform: translate(-50%, -50%);
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        .modal-overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.8); 
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }
        
        .active-history { background-color: #3b82f6; color: white; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col bg-slate-900" oncontextmenu="return false;"> 

    <div id="drag-ghost"></div>

    <!-- MODALS -->
    <div id="modal-confirm" class="modal-overlay hidden">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold text-white mb-2">Konfirmasi</h3>
            <p id="modal-message" class="text-slate-300 mb-6">Yakin?</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeModal()" class="bg-slate-600 px-4 py-2 rounded text-white font-bold">Batal</button>
                <button id="modal-yes-btn" class="bg-red-600 px-4 py-2 rounded text-white font-bold">Ya</button>
            </div>
        </div>
    </div>

    <div id="modal-request" class="modal-overlay hidden">
        <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 max-w-sm w-full text-center animate-bounce">
            <i class="fas fa-bell text-yellow-400 text-3xl mb-3"></i>
            <h3 id="req-title" class="text-xl font-bold text-white mb-2">Permintaan</h3>
            <p id="req-message" class="text-slate-300 mb-6">Lawan meminta...</p>
            <div class="flex gap-3 justify-center">
                <button onclick="respondRequest(false)" class="bg-red-600 px-4 py-2 rounded text-white font-bold">Tolak</button>
                <button onclick="respondRequest(true)" class="bg-green-600 px-4 py-2 rounded text-white font-bold">Terima</button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-slate-800 px-4 py-3 shadow-lg flex justify-between items-center h-[60px] shrink-0 border-b border-slate-700 relative z-50">
        <div class="flex items-center gap-2">
            <i class="fas fa-chess-queen text-yellow-500 text-2xl"></i>
            <h1 class="text-lg font-bold text-white tracking-wide hidden sm:block">Catur Master Pro</h1>
        </div>
        <div class="flex items-center gap-3">
            <button id="sound-toggle" onclick="toggleSound()" class="text-slate-400 hover:text-white px-2">
                <i class="fas fa-volume-up"></i>
            </button>
            <div id="connection-status" class="text-[10px] px-2 py-1 rounded bg-red-900 text-red-200 animate-pulse font-mono">...</div>
            <span id="user-display" class="text-sm text-slate-300 font-semibold truncate max-w-[100px]"></span>
            <button onclick="logout()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-1.5 rounded text-white border border-slate-600">Keluar</button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 relative w-full h-full overflow-hidden flex flex-col md:flex-row">
        
        <!-- 1. LOGIN -->
        <div id="screen-login" class="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center p-4 z-[60]">
            <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-sm w-full border border-slate-700 text-center">
                <i class="fas fa-chess text-5xl text-yellow-500 mb-6"></i>
                <h2 class="text-2xl font-bold mb-2 text-white">Selamat Datang</h2>
                <input type="text" id="username-input" class="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white mb-4 focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Nama Panggilan...">
                <button onclick="handleLogin()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-slate-900 font-bold py-3 rounded-lg shadow-lg">Masuk</button>
            </div>
        </div>

        <!-- 2. LOBBY -->
        <div id="screen-lobby" class="absolute inset-0 bg-slate-900 hidden flex flex-col z-[50]">
            <div class="w-full max-w-6xl mx-auto flex flex-col h-full p-4">
                <div class="flex justify-between items-center mb-4 bg-slate-800 p-4 rounded-lg border border-slate-700">
                    <h2 class="text-xl font-bold text-white"><i class="fas fa-server text-blue-400"></i> Lobby</h2>
                    <div class="flex gap-2">
                        <button onclick="createGame('ai', this)" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold text-sm shadow"><i class="fas fa-robot"></i> VS AI</button>
                        <button onclick="createGame('human', this)" class="bg-yellow-500 hover:bg-yellow-400 text-slate-900 px-4 py-2 rounded font-bold text-sm shadow"><i class="fas fa-user-friends"></i> Buat Room</button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 flex-1 overflow-hidden">
                    <div class="bg-slate-800 rounded-lg border border-slate-700 flex flex-col overflow-hidden">
                        <div class="p-3 bg-slate-900 font-bold text-slate-300 border-b border-slate-700">Room Tersedia</div>
                        <div id="room-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
                    </div>
                    <div class="bg-slate-800 rounded-lg border border-slate-700 flex flex-col overflow-hidden">
                        <div class="p-3 bg-slate-900 font-bold text-slate-300 border-b border-slate-700">Riwayat Lokal (Klik untuk Analisis)</div>
                        <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. GAME -->
        <div id="screen-game" class="absolute inset-0 bg-slate-900 hidden flex flex-col md:flex-row z-[40]">
            <!-- Board Container (Top/Left) -->
            <div class="flex-1 flex flex-col items-center justify-center p-2 relative bg-slate-900 overflow-hidden min-h-0">
                <div class="w-[90vw] md:w-full md:max-w-[75vh] flex justify-between items-end mb-2 px-1">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-slate-700 border border-slate-500 flex items-center justify-center"><i class="fas fa-user text-slate-400"></i></div>
                        <div>
                            <span id="opponent-name" class="font-bold text-sm text-slate-200 block">Lawan</span>
                            <span id="game-status" class="text-xs text-yellow-400 font-mono"></span>
                        </div>
                    </div>
                    <div id="opponent-timer" class="bg-slate-800 px-2 py-1 rounded text-white font-mono text-sm border border-slate-700">--:--</div>
                </div>

                <!-- CHESS BOARD -->
                <div id="chess-board" class="chess-board rounded shadow-2xl">
                    <!-- SVG will be injected -->
                </div>

                <div class="w-[90vw] md:w-full md:max-w-[75vh] flex justify-between items-start mt-2 px-1">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded bg-indigo-900 border border-indigo-500 flex items-center justify-center"><i class="fas fa-user text-indigo-300"></i></div>
                        <div>
                            <span id="player-name-display" class="font-bold text-sm text-slate-200 block">Anda</span>
                            <span id="turn-indicator" class="text-[10px] text-slate-500">Giliran...</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="flipBoard()" class="text-slate-400 hover:text-white"><i class="fas fa-sync-alt"></i></button>
                        <div id="my-timer" class="bg-slate-800 px-2 py-1 rounded text-white font-mono text-sm border border-slate-700">--:--</div>
                    </div>
                </div>
            </div>

            <!-- Controls Container (Bottom/Right) -->
            <div class="w-full md:w-[350px] bg-slate-800 border-l border-slate-700 flex flex-col h-[40vh] md:h-full shrink-0 shadow-xl z-20">
                <div class="flex bg-slate-900 border-b border-slate-700 shrink-0">
                    <button class="flex-1 py-2 text-xs font-bold text-blue-400 border-b-2 border-blue-500 uppercase">Langkah</button>
                    <button class="flex-1 py-2 text-xs font-bold text-slate-500 hover:text-slate-300 uppercase" onclick="alert('Chat segera hadir!')">Chat</button>
                </div>
                <div class="flex-1 overflow-y-auto bg-slate-800 p-0" id="pgn-container">
                    <table class="w-full text-sm text-left border-collapse">
                        <thead class="bg-slate-850 text-slate-500 text-[10px] uppercase sticky top-0">
                            <tr><th class="px-2 py-1 w-8">#</th><th class="px-2 py-1">Putih</th><th class="px-2 py-1">Hitam</th></tr>
                        </thead>
                        <tbody id="move-history" class="text-slate-300 font-mono"></tbody>
                    </table>
                </div>
                <div class="bg-slate-850 p-3 border-t border-slate-700 shrink-0">
                    
                    <!-- Kontrol Main -->
                    <div id="play-controls" class="grid grid-cols-4 gap-2 mb-2">
                        <button onclick="reqTakeback()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded" title="Mundur Langkah"><i class="fas fa-undo-alt"></i></button>
                        <button onclick="reqDraw()" class="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded" title="Ajukan Remis"><i class="fas fa-handshake"></i></button>
                        <button onclick="confirmResign()" class="bg-red-900/50 hover:bg-red-800 text-red-200 border border-red-800 py-2 rounded col-span-2 text-xs font-bold"><i class="fas fa-flag"></i> MENYERAH</button>
                    </div>

                    <!-- Kontrol Analisis -->
                    <div id="analysis-controls" class="hidden flex-col gap-2">
                        <div class="flex justify-between items-center bg-slate-900 p-2 rounded border border-slate-700">
                             <span class="text-xs font-bold text-blue-400">ANALISIS (Gerakkan Bidak)</span>
                             <span id="eval-score" class="text-xs font-mono text-white">0.0</span>
                        </div>
                        <div class="eval-bar-container"><div id="eval-fill" class="eval-bar-fill"></div></div>
                        <p id="best-move-text" class="text-[10px] text-slate-400 italic text-center min-h-[16px] mt-1">...</p>
                        <button onclick="exitGame()" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-2 rounded font-bold text-sm"><i class="fas fa-arrow-left"></i> KEMBALI KE LOBBY</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDmer19KTaijOz3bTdknEEs5dqwKNt6HQg",
            authDomain: "masjid-pekalongan.firebaseapp.com",
            projectId: "masjid-pekalongan",
            storageBucket: "masjid-pekalongan.firebasestorage.app",
            messagingSenderId: "619031365600",
            appId: "1:619031365600:web:35061354a11cf3f72e4d85",
            measurementId: "G-R511G99W8R"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'chess-v3-final';

        // STATE
        let currentUser, currentGameId, gameData;
        let chess = new Chess();
        let boardOrientation = 'white';
        let stockfishWorker = null;
        let gameUnsubscribe = null; 
        let soundEnabled = true;

        // Interaction State
        let selectedSquare = null;
        let premove = null; 
        let draggedPiece = null;
        let isDragging = false;
        let dragStartSquare = null;
        
        // Arrow & Highlights State
        let arrows = [];
        let circleHighlights = []; 
        let isRightClicking = false;
        let rightClickStart = null;
        let rightClickCurrent = null;

        // View State
        let isAI = false;
        let isAnalysisMode = false;
        let viewHistoryIndex = -1;
        let isReplayMode = false;
        
        // Audio (Lichess Assets - Louder)
        const audioFiles = {
            move: 'https://images.chesscomfiles.com/chess-themes/sounds/_Common/standard/move-self.mp3',
            capture: 'https://images.chesscomfiles.com/chess-themes/sounds/_Common/standard/capture.mp3',
            check: 'https://images.chesscomfiles.com/chess-themes/sounds/_Common/standard/move-check.mp3',
            start: 'https://images.chesscomfiles.com/chess-themes/sounds/_Common/standard/game-start.mp3',
            end: 'https://images.chesscomfiles.com/chess-themes/sounds/_Common/standard/game-end.mp3',
            notify: 'https://images.chesscomfiles.com/chess-themes/sounds/_Common/standard/notify.mp3'
        };

        function getPieceUrl(color, type) {
            return `https://images.chesscomfiles.com/chess-themes/pieces/neo/150/${color}${type}.png`;
        }

        // --- INIT ---
        async function initApp() {
            try {
                const blob = await fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js').then(r => r.blob());
                stockfishWorker = new Worker(URL.createObjectURL(blob));
                stockfishWorker.onmessage = handleStockfishMessage;
            } catch (e) { console.warn("SF Error", e); }

            const savedName = localStorage.getItem('chess_username');
            if (savedName) document.getElementById('username-input').value = savedName;

            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    updateConnectionStatus(true);
                    if (localStorage.getItem('chess_username') && !document.getElementById('screen-login').classList.contains('hidden')) handleLogin();
                } else {
                    updateConnectionStatus(false);
                    auth.signInAnonymously();
                }
            });

            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
            document.addEventListener('contextmenu', event => event.preventDefault());
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const btn = document.getElementById('sound-toggle');
            if(soundEnabled) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.remove('text-red-500');
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                btn.classList.add('text-red-500');
            }
        }

        function updateConnectionStatus(connected) {
            const el = document.getElementById('connection-status');
            el.innerText = connected ? "Online" : "Connecting...";
            el.className = connected ? "text-[10px] px-2 py-1 rounded bg-green-900 text-green-200" : "text-[10px] px-2 py-1 rounded bg-red-900 text-red-200 animate-pulse";
        }

        async function handleLogin() {
            const name = document.getElementById('username-input').value.trim();
            if (!name) return;
            localStorage.setItem('chess_username', name);
            document.getElementById('user-display').innerText = name;
            showScreen('lobby');
            listenToLobby();
            loadHistory();
        }

        function logout() { localStorage.removeItem('chess_username'); location.reload(); }

        // --- HISTORY & REPLAY ---
        function loadHistory() {
            const histList = document.getElementById('history-list');
            if(!histList) return;
            const history = JSON.parse(localStorage.getItem('chess_history') || '[]');
            histList.innerHTML = '';
            if (history.length === 0) {
                histList.innerHTML = '<div class="text-center text-slate-500 py-4 text-xs">Belum ada riwayat.</div>';
                return;
            }
            history.reverse().forEach((game, idx) => {
                const el = document.createElement('div');
                const resClass = game.result === 'win' ? 'text-green-400' : (game.result === 'loss' ? 'text-red-400' : 'text-yellow-400');
                el.className = "bg-slate-700/30 p-2 rounded text-xs mb-2 border border-slate-700 flex justify-between items-center cursor-pointer hover:bg-slate-700 transition";
                el.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-slate-300 font-semibold">vs ${game.opponent}</span>
                        <span class="text-[10px] text-slate-500">${new Date(game.date).toLocaleDateString()}</span>
                    </div>
                    <span class="${resClass} font-bold uppercase border border-slate-600 px-1 rounded">${game.result}</span>
                `;
                el.onclick = () => loadReplayGame(game);
                histList.appendChild(el);
            });
        }

        function loadReplayGame(game) {
            currentGameId = null;
            isReplayMode = true;
            isAnalysisMode = true;
            boardOrientation = 'white';
            
            if (!game.pgn) {
                alert("Maaf, riwayat lama tidak memiliki data langkah lengkap (PGN).");
                return;
            }

            chess.load_pgn(game.pgn);
            viewHistoryIndex = -1;
            
            document.getElementById('opponent-name').innerText = game.opponent;
            document.getElementById('player-name-display').innerText = localStorage.getItem('chess_username');
            
            showScreen('game');
            document.getElementById('play-controls').classList.add('hidden');
            document.getElementById('analysis-controls').classList.remove('hidden');
            
            renderBoard();
            updateMoveHistoryUI();
            
            // Trigger analysis
            if(stockfishWorker) {
                stockfishWorker.postMessage('position fen ' + chess.fen());
                stockfishWorker.postMessage('go depth 15');
            }
        }

        // --- ARROWS & BOARD DRAWING ---
        function handleRightClickDown(e, square) { if(!square) return; isRightClicking = true; rightClickStart = square; rightClickCurrent = square; }
        function handleRightClickMove(e, square) { if(isRightClicking && square && rightClickCurrent !== square) { rightClickCurrent = square; drawArrows(); } }
        function handleRightClickUp(e, square) {
            if(!isRightClicking) return; isRightClicking = false;
            if (rightClickStart === square) {
                const index = circleHighlights.indexOf(square);
                if (index > -1) circleHighlights.splice(index, 1); else circleHighlights.push(square);
            } else if (square) {
                const existingIndex = arrows.findIndex(a => a.from === rightClickStart && a.to === square);
                if (existingIndex > -1) arrows.splice(existingIndex, 1); else arrows.push({ from: rightClickStart, to: square });
            }
            rightClickStart = null; rightClickCurrent = null; renderBoard(); 
        }
        function clearArrowsAndHighlights() { arrows = []; circleHighlights = []; renderBoard(); }
        function drawArrows() {
            const svg = document.getElementById('arrow-layer'); if(!svg) return; svg.innerHTML = ''; 
            const getCoords = (sq) => {
                const col = sq.charCodeAt(0) - 97; const row = 8 - parseInt(sq[1]); 
                let x = boardOrientation === 'white' ? col : 7 - col; let y = boardOrientation === 'white' ? row : 7 - row;
                return { x: (x * 12.5) + 6.25, y: (y * 12.5) + 6.25 };
            };
            arrows.forEach(a => renderArrowSvg(svg, getCoords(a.from), getCoords(a.to), '#ffaa00'));
            if (isRightClicking && rightClickStart && rightClickCurrent && rightClickStart !== rightClickCurrent) {
                renderArrowSvg(svg, getCoords(rightClickStart), getCoords(rightClickCurrent), '#ffaa00', 0.6);
            }
        }
        function renderArrowSvg(svg, start, end, color, opacity = 0.8) {
            const angle = Math.atan2(end.y - start.y, end.x - start.x);
            const lineEnd = { x: end.x - 3 * Math.cos(angle), y: end.y - 3 * Math.sin(angle) };
            const id = `arrow-${Math.random().toString(36).substr(2,9)}`;
            
            const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
            const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
            marker.setAttribute("id", id); marker.setAttribute("markerWidth", "4"); marker.setAttribute("markerHeight", "4");
            marker.setAttribute("refX", "2"); marker.setAttribute("refY", "2"); marker.setAttribute("orient", "auto");
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M0,0 L4,2 L0,4 Z"); path.setAttribute("fill", color); path.setAttribute("fill-opacity", opacity);
            marker.appendChild(path); defs.appendChild(marker); svg.appendChild(defs);

            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", start.x); line.setAttribute("y1", start.y); line.setAttribute("x2", lineEnd.x); line.setAttribute("y2", lineEnd.y);
            line.setAttribute("stroke", color); line.setAttribute("stroke-width", "2.5"); line.setAttribute("stroke-opacity", opacity);
            line.setAttribute("marker-end", `url(#${id})`); svg.appendChild(line);
        }

        // --- LOBBY ---
        function listenToLobby() {
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games')
                .where('status', '==', 'waiting').limit(20).onSnapshot((snap) => {
                    const listEl = document.getElementById('room-list'); listEl.innerHTML = '';
                    if (snap.empty) { listEl.innerHTML = '<div class="text-center text-slate-500 py-4 text-xs">Kosong.</div>'; return; }
                    let games = []; snap.forEach(doc => games.push({id: doc.id, ...doc.data()}));
                    games.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
                    games.forEach(g => {
                        if (g.white.id === currentUser?.uid) return;
                        const div = document.createElement('div');
                        div.className = "bg-slate-700 p-2 rounded flex justify-between items-center border border-slate-600 mb-2";
                        div.innerHTML = `<span class="text-sm font-bold text-white">${g.white.name}</span><button onclick="joinGame('${g.id}')" class="bg-blue-600 px-3 py-1 rounded text-xs text-white">MAIN</button>`;
                        listEl.appendChild(div);
                    });
                });
        }

        async function createGame(type, btn) {
            if(!currentUser) return alert("Belum konek!");
            btn.disabled = true;
            try {
                const gameId = currentUser.uid + '_' + Date.now();
                if (type === 'ai') { isAI = true; startGameLocal(gameId, 'white', 'Stockfish AI'); } 
                else {
                    isAI = false;
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(gameId).set({
                        white: { name: currentUser.displayName || localStorage.getItem('chess_username'), id: currentUser.uid },
                        black: null, fen: 'start', pgn: '', status: 'waiting', createdAt: firebase.firestore.FieldValue.serverTimestamp(), requests: {}
                    });
                    startGameFirestore(gameId, 'white');
                }
            } catch(e) { alert(e.message); } finally { btn.disabled = false; }
        }

        async function joinGame(id) {
            isAI = false;
            try {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id).update({
                    black: { name: localStorage.getItem('chess_username'), id: currentUser.uid }, status: 'playing'
                });
                startGameFirestore(id, 'black');
            } catch(e) { alert("Penuh/Hilang"); }
        }

        // --- GAME LOGIC ---
        function startGameLocal(id, orientation, oppName) { setupGameCommon(id, orientation, oppName); playSound('start'); if(orientation==='black') setTimeout(makeAIMove, 500); }
        function startGameFirestore(id, orientation) {
            setupGameCommon(id, orientation, "Menunggu...");
            if(gameUnsubscribe) gameUnsubscribe();
            gameUnsubscribe = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(id).onSnapshot(doc => {
                if(!doc.exists) return;
                gameData = doc.data();
                const opp = orientation === 'white' ? gameData.black : gameData.white;
                document.getElementById('opponent-name').innerText = opp ? opp.name : "Menunggu...";
                if (gameData.status === 'playing' && document.getElementById('opponent-name').innerText === "Menunggu...") playSound('start');
                
                checkRequests(gameData.requests, orientation);

                if (viewHistoryIndex === -1 && gameData.fen && gameData.fen !== 'start' && chess.fen() !== gameData.fen) {
                    if(gameData.pgn) chess.load_pgn(gameData.pgn); else chess.load(gameData.fen);
                    
                    if (premove) {
                        const move = chess.move({ from: premove.from, to: premove.to, promotion: 'q' });
                        if (move) { premove = null; pushMoveToFirestore(); } else { premove = null; } 
                    }

                    const lastMove = chess.history({verbose:true}).pop();
                    if(chess.in_check()) playSound('check');
                    else if (lastMove && lastMove.flags.includes('c')) playSound('capture');
                    else playSound('move');
                    
                    renderBoard(); updateMoveHistoryUI(); checkGameOver(false);
                }
                
                if (gameData.status === 'finished' && !isAnalysisMode) {
                    let result = gameData.winner === localStorage.getItem('chess_username') ? 'win' : (gameData.winner === 'draw' ? 'draw' : 'loss');
                    handleGameOver(result, true);
                }
            });
        }

        function setupGameCommon(id, orientation, oppName) {
            currentGameId = id; boardOrientation = orientation; chess.reset(); isAnalysisMode = false; isReplayMode = false; premove = null; viewHistoryIndex = -1; selectedSquare = null;
            clearArrowsAndHighlights();
            document.getElementById('opponent-name').innerText = oppName;
            document.getElementById('player-name-display').innerText = localStorage.getItem('chess_username');
            showScreen('game');
            document.getElementById('play-controls').classList.remove('hidden');
            document.getElementById('analysis-controls').classList.add('hidden');
            renderBoard(); updateMoveHistoryUI();
        }

        // --- RENDER ---
        function renderBoard() {
            const boardEl = document.getElementById('chess-board');
            if(!boardEl) return;
            boardEl.innerHTML = '<svg id="arrow-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>';

            let boardState = chess.board();
            let currentTurn = chess.turn();
            
            if (viewHistoryIndex !== -1) {
                try {
                    const tempChess = new Chess();
                    if(isReplayMode || chess.pgn().length > 0) {
                        const history = chess.history();
                        for(let i=0; i<=viewHistoryIndex; i++) tempChess.move(history[i]);
                        boardState = tempChess.board();
                        currentTurn = tempChess.turn();
                    }
                } catch(e) { viewHistoryIndex = -1; }
            }

            const isWhite = boardOrientation === 'white';
            const rows = isWhite ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            const cols = isWhite ? [0,1,2,3,4,5,6,7] : [7,6,5,4,3,2,1,0];
            const lastMove = chess.history({verbose:true}).pop();
            const inCheck = (viewHistoryIndex === -1) ? chess.in_check() : false;

            rows.forEach(r => {
                cols.forEach(c => {
                    const square = String.fromCharCode(97+c) + (8-r);
                    const piece = boardState[r][c];
                    
                    const div = document.createElement('div');
                    div.className = `square ${(r+c)%2===0 ? 'white' : 'black'}`;
                    div.dataset.square = square;

                    if (viewHistoryIndex !== -1) div.classList.add('viewing-history');
                    if (selectedSquare === square) div.classList.add('selected');
                    if (viewHistoryIndex === -1 && lastMove && (lastMove.from === square || lastMove.to === square)) div.classList.add('last-move');
                    if (premove && (premove.from === square || premove.to === square)) div.classList.add('premove');
                    if (inCheck && piece && piece.type === 'k' && piece.color === currentTurn) div.classList.add('in-check');
                    if (circleHighlights.includes(square)) div.classList.add('circle-highlight');

                    if (selectedSquare && viewHistoryIndex === -1) {
                        const moves = chess.moves({square: selectedSquare, verbose: true});
                        if (moves.find(m => m.to === square)) div.classList.add('possible-move');
                    }

                    if (piece) {
                        const img = document.createElement('div');
                        img.className = 'piece';
                        img.style.backgroundImage = `url('${getPieceUrl(piece.color, piece.type)}')`;
                        if (viewHistoryIndex === -1 && (isAnalysisMode || piece.color === boardOrientation.charAt(0))) {
                            img.addEventListener('mousedown', (e) => { if(e.button===0) startDrag(e, square, img); });
                            img.addEventListener('touchstart', (e) => startDrag(e, square, img), {passive:false});
                        }
                        div.appendChild(img);
                    }
                    div.onclick = () => onSquareClick(square);
                    div.addEventListener('mousedown', (e) => { if(e.button===2) handleRightClickDown(e, square); });
                    div.addEventListener('mouseup', (e) => { if(e.button===2) handleRightClickUp(e, square); });
                    div.addEventListener('mouseenter', (e) => handleRightClickMove(e, square)); 
                    boardEl.appendChild(div);
                });
            });
            drawArrows(); updateStatusText();
        }

        // --- INTERACTION ---
        function onSquareClick(square) {
            if (arrows.length > 0 || circleHighlights.length > 0) clearArrowsAndHighlights();
            if (premove) { premove = null; renderBoard(); }
            
            // Allow clicking in analysis mode to move pieces
            if (isAnalysisMode || (!isReplayMode && viewHistoryIndex === -1 && !isDragging)) {
                const piece = chess.get(square);
                // Allow selecting any piece in analysis mode
                const myColor = isAnalysisMode ? (piece ? piece.color : null) : boardOrientation.charAt(0);

                if (selectedSquare === null) {
                    // Logic to select piece
                    if (piece && (isAnalysisMode || piece.color === myColor)) { 
                        selectedSquare = square; renderBoard(); 
                    }
                } else {
                    if (selectedSquare === square) { selectedSquare = null; renderBoard(); return; }
                    // Switch selection if clicking another friendly piece
                    if (piece && (isAnalysisMode ? piece.color === chess.turn() : piece.color === myColor)) { 
                        selectedSquare = square; renderBoard(); return; 
                    }
                    handleMoveAttempt(selectedSquare, square);
                }
            }
        }

        function startDrag(e, square, el) {
            // Allow drag in analysis mode too
            if (!isAnalysisMode && viewHistoryIndex !== -1) return;
            e.preventDefault(); isDragging = true; dragStartSquare = square; draggedPiece = el;
            onSquareClick(square); 
            const ghost = document.getElementById('drag-ghost');
            ghost.style.backgroundImage = el.style.backgroundImage; ghost.style.display = 'block';
            el.classList.add('dragging'); moveGhost(e);
            document.addEventListener('mousemove', moveGhost); document.addEventListener('touchmove', moveGhost, {passive:false});
        }
        function moveGhost(e) {
            if(!isDragging) return;
            const ghost = document.getElementById('drag-ghost');
            const cX = e.touches ? e.touches[0].clientX : e.clientX;
            const cY = e.touches ? e.touches[0].clientY : e.clientY;
            ghost.style.left = cX + 'px'; ghost.style.top = cY + 'px';
        }
        function endDrag(e) {
            if(!isDragging) return;
            isDragging = false;
            const ghost = document.getElementById('drag-ghost');
            ghost.style.display = 'none'; if(draggedPiece) draggedPiece.classList.remove('dragging');
            document.removeEventListener('mousemove', moveGhost); document.removeEventListener('touchmove', moveGhost);
            const cX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
            const cY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
            const el = document.elementsFromPoint(cX, cY).find(el => el.classList.contains('square'));
            if (el) {
                const target = el.dataset.square;
                if (target !== dragStartSquare) handleMoveAttempt(dragStartSquare, target);
            }
        }

        function handleMoveAttempt(from, to) {
            // ANALYSIS MODE MOVE LOGIC
            if (isAnalysisMode) {
                const move = chess.move({ from, to, promotion: 'q' });
                selectedSquare = null;
                if (move) {
                    renderBoard();
                    updateMoveHistoryUI();
                    playSound('move');
                    // Trigger Stockfish evaluation for the new position
                    if(stockfishWorker) {
                        stockfishWorker.postMessage('position fen ' + chess.fen());
                        stockfishWorker.postMessage('go depth 15');
                    }
                } else {
                    renderBoard();
                }
                return; // Stop here, don't send to firestore
            }

            // GAMEPLAY MOVE LOGIC
            const myTurn = chess.turn() === boardOrientation.charAt(0);
            if (myTurn) {
                const move = chess.move({ from, to, promotion: 'q' });
                selectedSquare = null; premove = null;
                if (move) {
                    renderBoard(); updateMoveHistoryUI();
                    if(chess.in_check()) playSound('check'); else if(move.flags.includes('c')) playSound('capture'); else playSound('move');
                    if (isAI) { checkGameOver(true); setTimeout(makeAIMove, 500); } else { pushMoveToFirestore(); }
                } else { renderBoard(); }
            } else {
                const piece = chess.get(from);
                if (piece && piece.color === boardOrientation.charAt(0)) {
                    premove = { from, to }; selectedSquare = null; renderBoard();
                }
            }
        }

        async function pushMoveToFirestore() {
            if (!currentGameId) return;
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                fen: chess.fen(), pgn: chess.pgn(), lastMove: { t: Date.now() }
            });
            checkGameOver(true);
        }

        function makeAIMove() {
            if (chess.game_over()) return;
            if (stockfishWorker) { stockfishWorker.postMessage('position fen ' + chess.fen()); stockfishWorker.postMessage('go depth 6'); window.awaitingAI = true; } 
            else { const moves = chess.moves(); chess.move(moves[Math.floor(Math.random()*moves.length)]); renderBoard(); updateMoveHistoryUI(); checkGameOver(true); }
        }
        function handleStockfishMessage(e) {
            // Handling AI Move
            if(window.awaitingAI && e.data.startsWith('bestmove')) {
                window.awaitingAI = false; 
                chess.move(e.data.split(' ')[1], {sloppy:true}); 
                renderBoard(); updateMoveHistoryUI(); 
                if(chess.in_check()) playSound('check'); else playSound('move'); checkGameOver(true);
            }
            // Handling Analysis Eval
            if(e.data.startsWith('info') && e.data.includes('score cp')) {
                const m = e.data.match(/score cp (-?\d+)/); 
                if(m) { 
                    let cp = parseInt(m[1]); 
                    if(chess.turn()==='b') cp = -cp; 
                    // Update UI
                    const width = Math.max(5, Math.min(95, 50 + (cp/10)));
                    document.getElementById('eval-fill').style.width = width + '%'; 
                    document.getElementById('eval-score').innerText = (cp/100).toFixed(2);
                }
            }
            if(isAnalysisMode && e.data.startsWith('bestmove')) {
                 const best = e.data.split(' ')[1];
                 document.getElementById('best-move-text').innerText = "Saran Terbaik: " + best;
            }
        }

        function checkGameOver(local) { 
            if(chess.game_over()) { 
                let res='draw'; let winner='draw'; 
                if(chess.in_checkmate()) { 
                    res=boardOrientation===(chess.turn()==='w'?'black':'white')?'win':'loss'; 
                    winner=res==='win'?localStorage.getItem('chess_username'):document.getElementById('opponent-name').innerText; 
                } 
                if(local&&!isAI) db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({status:'finished', winner}); 
                handleGameOver(res); 
            } 
        }

        function handleGameOver(res) { 
            document.getElementById('game-status').innerHTML = res; 
            playSound('end'); 
            
            // Simpan PGN ke Local Storage agar bisa di replay
            const hist = JSON.parse(localStorage.getItem('chess_history') || '[]');
            const oppName = document.getElementById('opponent-name').innerText;
            const last = hist[hist.length-1];
            // Simple check to avoid duplicates immediately
            if(!last || (Date.now() - new Date(last.date).getTime() > 5000)) {
                hist.push({ date: new Date().toISOString(), opponent: oppName, result: res, pgn: chess.pgn() });
                localStorage.setItem('chess_history', JSON.stringify(hist));
            }

            // Switch to Analysis Mode UI
            document.getElementById('play-controls').classList.add('hidden'); 
            document.getElementById('analysis-controls').classList.remove('hidden'); 
            
            isAnalysisMode=true; 
            if(stockfishWorker) {
                stockfishWorker.postMessage('position fen '+chess.fen());
                stockfishWorker.postMessage('go depth 15');
            }
        }
        
        async function reqTakeback() { 
            if(isAI) { 
                chess.undo(); chess.undo(); 
                renderBoard(); updateMoveHistoryUI(); playSound('notify'); 
                return; 
            }
            if(confirm("Minta mundur?")) sendRequest('takeback'); 
        }
        
        async function respondRequest(acc) {
            document.getElementById('modal-request').classList.add('hidden');
            if(acc && gameData.requests.type==='takeback') {
                const sender = gameData.requests.sender;
                const requesterColor = (sender === gameData.white.id) ? 'w' : 'b';
                const temp = new Chess();
                temp.load_pgn(chess.pgn());
                temp.undo();
                if (temp.turn() !== requesterColor) temp.undo();
                
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({
                    fen:temp.fen(), pgn:temp.pgn(), requests:{status:'accepted'}
                });
            } else if (acc && gameData.requests.type==='draw') {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({status:'finished', winner:'draw', requests:{status:'accepted'}});
            } else {
                await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({requests:{status:'rejected'}});
            }
        }

        async function reqDraw() { if(confirm("Ajukan remis?")) sendRequest('draw'); }
        function confirmResign() { showModalConfirm("Menyerah?", "Yakin?", () => { handleGameOver('loss'); if(!isAI) db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({status:'finished', winner: document.getElementById('opponent-name').innerText}); }); }
        async function sendRequest(t) { await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('games').doc(currentGameId).update({requests:{type:t, sender:currentUser.uid, status:'pending'}}); alert("Terkirim"); }
        function checkRequests(req) { if(req?.status==='pending' && req.sender!==currentUser.uid) { document.getElementById('modal-request').classList.remove('hidden'); document.getElementById('req-title').innerText = req.type; playSound('notify'); } else document.getElementById('modal-request').classList.add('hidden'); }
        
        function updateStatusText() {
            const el = document.getElementById('turn-indicator');
            if(viewHistoryIndex!==-1) { el.innerText="REPLAY"; el.className="text-xs font-bold text-yellow-500"; return; }
            if(chess.turn()===boardOrientation.charAt(0)) { el.innerText="GILIRAN ANDA"; el.className="text-xs font-bold text-green-400 animate-pulse"; }
            else { el.innerText="GILIRAN LAWAN"; el.className="text-xs font-bold text-slate-500"; }
            document.getElementById('game-status').innerText = chess.in_check() ? "SKAK!" : "";
        }
        function playSound(t) { 
            if(soundEnabled && audioFiles[t]) { 
                // Overlap sound fix: Clone node
                const snd = new Audio(audioFiles[t]);
                snd.volume = 1.0;
                snd.play().catch(()=>{}); 
            } 
        }
        function showModalConfirm(t,m,y) { document.getElementById('modal-title').innerText=t; document.getElementById('modal-message').innerText=m; document.getElementById('modal-yes-btn').onclick=()=>{y();closeModal();}; document.getElementById('modal-confirm').classList.remove('hidden'); }
        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(e=>e.classList.add('hidden')); }
        function showScreen(id) { ['screen-login','screen-lobby','screen-game'].forEach(s=>document.getElementById(s).classList.add('hidden')); document.getElementById('screen-'+id).classList.remove('hidden'); }
        function flipBoard() { boardOrientation=boardOrientation==='white'?'black':'white'; renderBoard(); }
        
        function updateMoveHistoryUI() {
            const tbody = document.getElementById('move-history'); tbody.innerHTML = '';
            const hist = chess.history();
            for(let i=0; i<hist.length; i+=2) {
                tbody.innerHTML += `<tr class="border-b border-slate-800 hover:bg-slate-800"><td class="px-2 py-1 text-slate-500 w-8 border-r border-slate-700">${(i/2)+1}.</td><td class="px-2 py-1 cursor-pointer hover:text-white ${i===viewHistoryIndex?'active-history rounded':''}" onclick="viewHistory(${i})">${hist[i]}</td><td class="px-2 py-1 cursor-pointer hover:text-white ${i+1===viewHistoryIndex?'active-history rounded':''}" onclick="viewHistory(${i+1})">${hist[i+1]||''}</td></tr>`;
            }
            if(viewHistoryIndex===-1 && document.getElementById('pgn-container')) document.getElementById('pgn-container').scrollTop = 99999;
        }
        
        function exitGame() {
            if (gameUnsubscribe) gameUnsubscribe();
            chess.reset();
            isReplayMode = false;
            showScreen('lobby');
            listenToLobby();
            loadHistory(); 
        }

        initApp();
    </script>
</body>
</html>