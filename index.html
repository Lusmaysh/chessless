<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kingdom Chess</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --wood-dark: #2b1d0e;
        --wood-light: #5d4037;
        --gold: #c5a059;
        --gold-dim: #8a6e3e;
        --parchment: #e6d2b5;
      }
      body {
        font-family: "Cinzel", serif;
        background-color: #1a120b;
        background-image: radial-gradient(
          circle at center,
          #2c1e14 0%,
          #0f0a06 100%
        );
        color: var(--parchment);
        overflow: hidden;
        touch-action: none;
      }

      .medieval-panel {
        background: var(--wood-dark);
        border: 2px solid var(--gold-dim);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.8),
          inset 0 0 20px rgba(0, 0, 0, 0.5);
        position: relative;
      }
      .medieval-btn {
        background: linear-gradient(to bottom, #5d4037, #3e2723);
        border: 2px solid var(--gold-dim);
        color: var(--parchment);
        text-transform: uppercase;
        letter-spacing: 1px;
        transition: all 0.2s;
        box-shadow: 0 4px 0 #271914;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .medieval-btn:active {
        transform: translateY(4px);
        box-shadow: 0 0 0 #271914;
      }
      .medieval-btn.primary {
        background: linear-gradient(to bottom, #b8860b, #8b6508);
        color: #1a0f00;
        border-color: #ffd700;
      }
      .medieval-btn.danger {
        background: linear-gradient(to bottom, #8b0000, #500000);
        border-color: #ff4444;
      }
      .medieval-btn.selected {
        border-color: #ffd700;
        background: #8b6508;
        box-shadow: inset 0 0 10px #000;
        color: #fff;
      }
      .medieval-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .medieval-input {
        background: #1a120b;
        border: 2px solid var(--gold-dim);
        color: var(--gold);
        font-family: "MedievalSharp", cursive;
      }

      /* --- BOARD CONTAINER & BOARD (OPTIMIZED UI) --- */
      .board-container {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        padding: 0;
        position: relative;
      }

      .chess-board {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        grid-template-rows: repeat(8, 1fr);
        aspect-ratio: 1/1;
        background-color: #334155;
        user-select: none;
        position: relative;
        touch-action: none;
      }

      /* MOBILE: Edge to Edge */
      @media (max-width: 767px) {
        .board-container {
          width: 100vw;
          height: 100vw;
          margin-top: 4px;
          margin-bottom: 4px;
        }
        .chess-board {
          width: 100%;
          height: 100%;
          border: none;
          border-top: 2px solid #3e2723;
          border-bottom: 2px solid #3e2723;
        }
        .player-info-wrapper {
          padding: 0 12px;
          width: 100%;
        }
      }

      /* DESKTOP: Centered */
      @media (min-width: 768px) {
        .board-container {
          flex-grow: 1;
          height: 100%;
          padding: 20px;
        }
        .chess-board {
          width: min(85vh, 650px);
          height: min(85vh, 650px);
          border: 12px solid #3e2723;
          border-image: linear-gradient(#5d4037, #2b1d0e) 1;
          box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }
        .player-info-wrapper {
          width: min(85vh, 650px);
        }
      }

      #arrow-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 20;
      }
      .square {
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        width: 100%;
        height: 100%;
        z-index: 1;
      }
      .square.white {
        background-color: #e3c193;
      }
      .square.black {
        background-color: #8b5a2b;
      }
      .square.selected {
        box-shadow: inset 0 0 0 4px #ffd700;
      }
      .square.last-move {
        box-shadow: inset 0 0 0 4px rgba(100, 255, 100, 0.6);
      }
      .square.premove-source {
        background-color: rgba(220, 38, 38, 0.5) !important;
      }
      .square.premove-dest {
        background-color: rgba(220, 38, 38, 0.5) !important;
        box-shadow: inset 0 0 0 2px #ffaaaa;
      }
      .square.in-check {
        background: radial-gradient(
          ellipse at center,
          #8b0000 0%,
          transparent 70%
        ) !important;
      }
      .square.possible-move::after {
        content: "";
        width: 25%;
        height: 25%;
        background-color: rgba(0, 0, 0, 0.4);
        border-radius: 50%;
        position: absolute;
        pointer-events: none;
        z-index: 2;
      }
      .piece {
        width: 100%;
        height: 100%;
        background-size: 100%;
        background-repeat: no-repeat;
        background-position: center;
        cursor: grab;
        z-index: 10;
        touch-action: none;
        -webkit-tap-highlight-color: transparent;
      }
      .piece.dragging {
        opacity: 0.5;
      }
      #drag-ghost {
        position: fixed;
        width: 60px;
        height: 60px;
        background-size: contain;
        background-repeat: no-repeat;
        pointer-events: none;
        z-index: 9999;
        display: none;
        transform: translate(-50%, -50%);
      }
      .modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(4px);
      }
      .timer-box {
        font-family: monospace;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 4px;
        background: #1a0f00;
        border: 1px solid #5d4037;
        width: 70px;
        text-align: center;
      }
      .timer-active {
        background: #3e2723;
        border-color: #ffd700;
        color: #ffd700;
        box-shadow: 0 0 5px #ffd700;
      }
      .lobby-tab {
        opacity: 0.5;
        border-bottom: 4px solid transparent;
        transition: all 0.3s;
      }
      .lobby-tab.active {
        opacity: 1;
        border-bottom: 4px solid var(--gold);
        background: rgba(197, 160, 89, 0.1);
      }
      .custom-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .custom-scroll::-webkit-scrollbar-track {
        background: #1a0f00;
      }
      .custom-scroll::-webkit-scrollbar-thumb {
        background: #5d4037;
        border-radius: 3px;
      }
    </style>
  </head>
  <body
    class="fixed inset-0 w-full h-full flex flex-col bg-[#1a120b]"
    oncontextmenu="return false;"
  >
    <div id="drag-ghost"></div>

    <div id="modal-create" class="modal-overlay hidden">
      <div
        class="medieval-panel p-6 max-w-md w-full text-center rounded-lg m-4"
      >
        <h2 class="text-xl mb-4 border-b border-yellow-900/50 pb-2">
          Buat Pertempuran
        </h2>
        <div class="grid grid-cols-2 gap-4 text-left">
          <div>
            <label class="block text-[10px] text-yellow-600 mb-1 font-bold"
              >PASUKAN</label
            >
            <div class="flex gap-1 mb-4">
              <button
                onclick="selectColor('white')"
                id="btn-color-white"
                class="flex-1 medieval-btn p-2"
              >
                <i class="fas fa-chess-king text-white"></i>
              </button>
              <button
                onclick="selectColor('random')"
                id="btn-color-random"
                class="flex-1 medieval-btn p-2 selected"
              >
                <i class="fas fa-random"></i>
              </button>
              <button
                onclick="selectColor('black')"
                id="btn-color-black"
                class="flex-1 medieval-btn p-2"
              >
                <i class="fas fa-chess-king text-black"></i>
              </button>
            </div>
            <div id="ai-settings" class="hidden">
              <label class="block text-[10px] text-yellow-600 mb-1 font-bold"
                >KEKUATAN MUSUH</label
              >
              <select
                id="ai-elo"
                class="w-full medieval-input p-2 rounded text-xs text-center mb-4"
              >
                <option value="0">Pemula</option>
                <option value="5">Menengah</option>
                <option value="10">Ahli</option>
                <option value="15">Master</option>
                <option value="20">Grandmaster</option>
              </select>
            </div>
          </div>
          <div>
            <label class="block text-[10px] text-yellow-600 mb-1 font-bold"
              >WAKTU (MENIT)</label
            >
            <div class="grid grid-cols-2 gap-1 mb-2">
              <button
                onclick="selectTime(1)"
                id="btn-time-1"
                class="medieval-btn p-2 text-xs"
              >
                1
              </button>
              <button
                onclick="selectTime(3)"
                id="btn-time-3"
                class="medieval-btn p-2 text-xs"
              >
                3
              </button>
              <button
                onclick="selectTime(5)"
                id="btn-time-5"
                class="medieval-btn p-2 text-xs"
              >
                5
              </button>
              <button
                onclick="selectTime(10)"
                id="btn-time-10"
                class="medieval-btn p-2 text-xs selected"
              >
                10
              </button>
              <button
                onclick="selectTime(30)"
                id="btn-time-30"
                class="medieval-btn p-2 text-xs"
              >
                30
              </button>
              <button
                onclick="selectTime(-1)"
                id="btn-time--1"
                class="medieval-btn p-2 text-xs"
              >
                âˆž
              </button>
            </div>
          </div>
        </div>
        <div class="flex gap-2 mt-4">
          <button
            onclick="closeModal('modal-create')"
            class="flex-1 medieval-btn py-2"
          >
            Batal
          </button>
          <button
            id="btn-create-start"
            onclick="confirmCreateGame()"
            class="flex-1 medieval-btn primary py-2"
          >
            Mulai
          </button>
        </div>
      </div>
    </div>

    <div id="modal-gameover" class="modal-overlay hidden">
      <div class="medieval-panel p-8 max-w-sm w-full text-center rounded-lg">
        <h2 id="go-title" class="text-2xl mb-2 text-[#ffd700]">Selesai</h2>
        <p id="go-message" class="text-slate-300 mb-6 font-medieval">...</p>
        <button
          onclick="closeModal('modal-gameover')"
          class="medieval-btn py-2 px-6 rounded"
        >
          Lihat Papan
        </button>
      </div>
    </div>

    <div id="modal-confirm" class="modal-overlay hidden">
      <div class="medieval-panel p-6 max-w-sm w-full text-center rounded-lg">
        <h3 id="modal-title" class="text-lg mb-2">Konfirmasi</h3>
        <p id="modal-message" class="text-slate-300 mb-6 font-medieval">...</p>
        <div class="flex gap-3 justify-center">
          <button id="modal-no-btn" class="medieval-btn px-4 py-2 rounded">
            Batal
          </button>
          <button
            id="modal-yes-btn"
            class="medieval-btn danger px-4 py-2 rounded"
          >
            Ya
          </button>
        </div>
      </div>
    </div>

    <div id="modal-request" class="modal-overlay hidden">
      <div class="medieval-panel p-6 max-w-sm w-full text-center rounded-lg">
        <h3 id="req-title" class="text-xl mb-2">Permintaan</h3>
        <p id="req-message" class="text-slate-300 mb-6 font-medieval">...</p>
        <div class="flex gap-3 justify-center">
          <button
            onclick="respondRequest(false)"
            class="medieval-btn danger px-4 py-2 rounded"
          >
            Tolak
          </button>
          <button
            onclick="respondRequest(true)"
            class="medieval-btn primary px-4 py-2 rounded"
          >
            Terima
          </button>
        </div>
      </div>
    </div>

    <nav
      class="bg-[#1a0f00] px-3 py-2 shadow-lg flex justify-between items-center h-[50px] shrink-0 border-b-2 border-[#3e2723] z-50"
    >
      <div class="flex items-center gap-2">
        <i class="fas fa-chess-knight text-yellow-600 text-lg"></i>
        <h1 class="text-base tracking-widest text-[#c5a059] hidden sm:block">
          Kingdom Chess
        </h1>
      </div>
      <div class="flex items-center gap-2">
        <button
          id="sound-toggle"
          onclick="toggleSound()"
          class="text-[#8a6e3e] hover:text-[#c5a059] px-2"
        >
          <i class="fas fa-volume-up"></i>
        </button>
        <div
          id="connection-status"
          class="text-[9px] px-2 py-0.5 rounded bg-black/50 text-green-500 border border-green-900"
        >
          ...
        </div>
        <span
          id="user-display"
          class="text-xs text-[#e6d2b5] font-bold truncate max-w-[80px]"
        ></span>
        <button
          onclick="logout()"
          class="text-[10px] bg-[#3e2723] px-2 py-1 rounded text-[#e6d2b5] border border-[#5d4037]"
        >
          Keluar
        </button>
      </div>
    </nav>

    <main
      class="flex-1 relative w-full h-full overflow-hidden flex flex-col md:flex-row"
    >
      <div
        id="screen-login"
        class="absolute inset-0 z-[60] flex flex-col items-center justify-center p-4 bg-black/90"
      >
        <div class="medieval-panel p-8 max-w-xs w-full text-center rounded-lg">
          <i class="fas fa-shield-alt text-5xl text-yellow-600 mb-4"></i>
          <h2 class="text-2xl mb-1">Kingdom Chess</h2>
          <input
            type="text"
            id="username-input"
            class="w-full medieval-input rounded p-2 mb-4 text-center mt-4 outline-none"
            placeholder="Nama Anda..."
          />
          <button
            onclick="handleLogin()"
            class="w-full medieval-btn primary py-2 rounded font-bold shadow-lg"
          >
            Masuk
          </button>
        </div>
      </div>

      <div
        id="screen-lobby"
        class="absolute inset-0 hidden flex flex-col z-[50] p-4 bg-[#1a120b]"
      >
        <div class="w-full max-w-6xl mx-auto flex flex-col h-full">
          <div
            class="medieval-panel p-3 rounded-lg mb-4 flex justify-between items-center shrink-0"
          >
            <span class="text-yellow-600 font-bold text-sm">Aula Utama</span>
            <div class="flex gap-2">
              <button
                onclick="openCreateGameModal('ai')"
                class="medieval-btn px-3 py-1.5 rounded text-xs shadow"
              >
                <i class="fas fa-robot mr-1"></i>VS AI
              </button>
              <button
                onclick="openCreateGameModal('human')"
                class="medieval-btn primary px-3 py-1.5 rounded text-xs shadow"
              >
                <i class="fas fa-users mr-1"></i>Buat
              </button>
            </div>
          </div>
          <div class="flex mb-2 gap-2 shrink-0 md:hidden">
            <button
              onclick="switchLobbyTab('arena')"
              id="tab-btn-arena"
              class="lobby-tab active flex-1 medieval-btn p-2 rounded font-bold text-center text-xs"
            >
              <i class="fas fa-chess-board mr-1"></i> ARENA
            </button>
            <button
              onclick="switchLobbyTab('history')"
              id="tab-btn-history"
              class="lobby-tab flex-1 medieval-btn p-2 rounded font-bold text-center text-xs"
            >
              <i class="fas fa-history mr-1"></i> RIWAYAT
            </button>
          </div>
          <div class="flex-1 flex flex-col md:flex-row gap-4 overflow-hidden">
            <div
              id="lobby-panel-arena"
              class="flex-1 flex flex-col medieval-panel rounded-lg overflow-hidden"
            >
              <div
                class="p-3 bg-[#1a0f00] border-b border-[#5d4037] flex justify-between items-center"
              >
                <span class="text-yellow-600 font-bold text-sm"
                  >Daftar Room</span
                ><span class="text-[10px] text-stone-500">Auto-refresh</span>
              </div>
              <div
                id="room-list"
                class="flex-1 overflow-y-auto p-3 space-y-2 bg-[#23170f]"
              ></div>
            </div>
            <div
              id="lobby-panel-history"
              class="hidden md:flex flex-1 flex-col medieval-panel rounded-lg overflow-hidden"
            >
              <div
                class="p-3 bg-[#1a0f00] border-b border-[#5d4037] text-yellow-600 font-bold text-sm"
              >
                Jejak Pertempuran
              </div>
              <div
                id="history-list"
                class="flex-1 overflow-y-auto p-3 space-y-2 bg-[#23170f]"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div
        id="screen-game"
        class="absolute inset-0 hidden flex flex-col md:flex-row z-[40]"
      >
        <div
          class="flex-1 flex flex-col items-center justify-center relative min-h-0 bg-[#15100d]"
        >
          <div
            class="player-info-wrapper flex justify-between items-end mb-1 mt-2"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded bg-[#2b1d0e] border border-[#5d4037] flex items-center justify-center text-yellow-600"
              >
                <i class="fas fa-user"></i>
              </div>
              <div>
                <span
                  id="opponent-name"
                  class="font-bold text-xs block text-[#e6d2b5] truncate max-w-[100px]"
                  >Lawan</span
                >
                <span
                  id="game-status"
                  class="text-[10px] text-yellow-500 font-mono"
                ></span>
              </div>
            </div>
            <div id="timer-opponent" class="timer-box text-white">--:--</div>
          </div>

          <div class="board-container">
            <div id="chess-board" class="chess-board rounded-sm"></div>
          </div>

          <div
            class="player-info-wrapper flex justify-between items-start mt-1 mb-2"
          >
            <div class="flex items-center gap-2">
              <div
                class="w-8 h-8 rounded bg-[#2b1d0e] border border-[#c5a059] flex items-center justify-center text-yellow-400"
              >
                <i class="fas fa-user"></i>
              </div>
              <div>
                <span
                  id="player-name-display"
                  class="font-bold text-xs block text-[#c5a059] truncate max-w-[100px]"
                  >Anda</span
                >
                <span id="turn-indicator" class="text-[10px] text-stone-400"
                  >...</span
                >
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="flipBoard()" class="text-[#8a6e3e]">
                <i class="fas fa-sync-alt"></i>
              </button>
              <div id="timer-self" class="timer-box text-white">--:--</div>
            </div>
          </div>

          <div
            class="md:hidden w-full p-2 bg-[#2b1d0e] border-t border-[#5d4037]"
          >
            <div
              id="mobile-play-controls"
              class="flex justify-around items-center h-full"
            >
              <button
                onclick="reqTakeback()"
                class="text-stone-400 hover:text-white flex flex-col items-center"
              >
                <i class="fas fa-undo text-lg mb-1"></i
                ><span class="text-[9px]">Mundur</span>
              </button>
              <button
                onclick="reqDraw()"
                class="text-stone-400 hover:text-white flex flex-col items-center"
              >
                <i class="fas fa-handshake text-lg mb-1"></i
                ><span class="text-[9px]">Remis</span>
              </button>
              <button
                onclick="confirmResign()"
                class="text-red-500 hover:text-red-400 flex flex-col items-center"
              >
                <i class="fas fa-flag text-lg mb-1"></i
                ><span class="text-[9px]">Menyerah</span>
              </button>
            </div>
            <div
              id="mobile-post-game-controls"
              class="hidden flex gap-2 w-full"
            >
              <button
                onclick="startAnalysisFromModal()"
                class="medieval-btn flex-1 py-2 rounded text-xs"
              >
                <i class="fas fa-microscope mr-1"></i> Analisis
              </button>
              <button
                onclick="exitGame()"
                class="medieval-btn primary flex-1 py-2 rounded text-xs"
              >
                <i class="fas fa-sign-out-alt mr-1"></i> Keluar
              </button>
            </div>
          </div>
        </div>

        <div
          class="hidden md:flex w-[320px] medieval-panel border-l-4 border-[#2b1d0e] flex-col h-full shrink-0 z-20"
        >
          <div class="flex bg-[#1a0f00] border-b border-[#5d4037] shrink-0">
            <div
              class="flex-1 py-2 text-center text-xs font-bold text-[#c5a059] uppercase"
            >
              Riwayat Langkah
            </div>
          </div>
          <div
            class="flex-1 overflow-y-auto bg-[#23170f] p-0 custom-scroll"
            id="pgn-container"
          >
            <table class="w-full text-sm text-left border-collapse">
              <tbody id="move-history" class="text-[#e6d2b5] font-mono"></tbody>
            </table>
          </div>
          <div class="bg-[#1a0f00] p-4 border-t border-[#5d4037] shrink-0">
            <div id="desktop-play-controls" class="grid grid-cols-2 gap-2">
              <button
                onclick="reqTakeback()"
                class="medieval-btn py-2 rounded text-xs"
              >
                <i class="fas fa-undo mr-1"></i> Mundur
              </button>
              <button
                onclick="reqDraw()"
                class="medieval-btn py-2 rounded text-xs"
              >
                <i class="fas fa-handshake mr-1"></i> Remis
              </button>
              <button
                onclick="confirmResign()"
                class="medieval-btn danger col-span-2 py-3 rounded text-xs font-bold"
              >
                <i class="fas fa-flag mr-1"></i> MENYERAH
              </button>
            </div>
            <div id="desktop-post-game-controls" class="hidden flex-col gap-2">
              <div class="flex gap-2">
                <button
                  onclick="exitGame()"
                  class="medieval-btn py-2 rounded text-xs flex-1"
                >
                  Keluar
                </button>
                <button
                  onclick="startAnalysisFromModal()"
                  class="medieval-btn py-2 rounded text-xs flex-1"
                >
                  <i class="fas fa-microscope mr-1"></i> Analisis
                </button>
              </div>
            </div>
            <div id="analysis-controls" class="hidden flex-col gap-2 mt-2">
              <div class="bg-[#2b1d0e] p-2 rounded border border-[#5d4037]">
                <div class="flex justify-between mb-1">
                  <span class="text-[10px] text-blue-400">EVAL</span
                  ><span id="eval-score" class="text-[10px]">0.0</span>
                </div>
                <div class="h-1 bg-black rounded-full overflow-hidden">
                  <div
                    id="eval-fill"
                    class="h-full bg-white"
                    style="width: 50%"
                  ></div>
                </div>
                <p
                  id="best-move-text"
                  class="text-[10px] text-center mt-1 text-[#c5a059]"
                >
                  ...
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // ==========================================
      // 1. KONFIGURASI & VARIABEL (JANGAN DIUBAH)
      // ==========================================
      const firebaseConfig = {
        apiKey: "AIzaSyDmer19KTaijOz3bTdknEEs5dqwKNt6HQg",
        authDomain: "masjid-pekalongan.firebaseapp.com",
        projectId: "masjid-pekalongan",
        storageBucket: "masjid-pekalongan.firebasestorage.app",
        messagingSenderId: "619031365600",
        appId: "1:619031365600:web:35061354a11cf3f72e4d85",
        measurementId: "G-R511G99W8R",
      };
      try {
        firebase.initializeApp(firebaseConfig);
      } catch (e) {}
      const auth = firebase.auth(),
        db = firebase.firestore(),
        appId = "chess-v3-final";

      // Global Vars
      let currentUser = null,
        currentGameId = null,
        gameData = null;
      let chess = new Chess(),
        boardOrientation = "white",
        playerColor = "white",
        stockfishWorker = null,
        gameUnsubscribe = null;
      let premoveQueue = [],
        soundEnabled = true,
        selectedSquare = null;
      let whiteTime = 600,
        blackTime = 600,
        timerInterval = null,
        selectedTime = 10,
        lastTimestamp = null;
      let arrows = [],
        circleHighlights = [],
        isRightClicking = false,
        rightClickStart = null,
        rightClickCurrent = null;
      let isDragging = false,
        dragStartSquare = null,
        draggedPieceElement = null;
      let startX = 0,
        startY = 0,
        isClickCandidate = false;
      let isAI = false,
        isAnalysisMode = false,
        viewHistoryIndex = -1,
        aiLevel = 5,
        aiTimeout = null;
      let windowPendingGameType = "human",
        selectedColor = "random";

      const isMobile =
        /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
          navigator.userAgent
        );
      const audioFiles = {
        move: "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/move-self.mp3",
        capture:
          "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/capture.mp3",
        check:
          "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/notify.mp3",
        start:
          "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-start.mp3",
        end: "https://images.chesscomfiles.com/chess-themes/sounds/_MP3_/default/game-end.mp3",
      };

      // ==========================================
      // 2. FUNGSI PENDUKUNG
      // ==========================================

      function updateConnectionStatus(c) {
        const el = document.getElementById("connection-status");
        if (el) el.innerText = c ? "Online" : "Offline";
      }

      function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById("sound-toggle").innerHTML = soundEnabled
          ? '<i class="fas fa-volume-up"></i>'
          : '<i class="fas fa-volume-mute text-red-500"></i>';
      }

      function getPieceUrl(c, t) {
        return `https://images.chesscomfiles.com/chess-themes/pieces/neo/150/${c}${t}.png`;
      }

      function playSound(t) {
        if (soundEnabled && audioFiles[t]) {
          const s = new Audio(audioFiles[t]);
          s.volume = 1;
          s.play().catch(() => {});
        }
      }

      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
      }

      function showModalConfirm(t, m, y) {
        document.getElementById("modal-title").innerText = t;
        document.getElementById("modal-message").innerText = m;
        document.getElementById("modal-yes-btn").onclick = () => {
          y();
          closeModal("modal-confirm");
        };
        document.getElementById("modal-no-btn").onclick = () => {
          closeModal("modal-confirm");
        };
        document.getElementById("modal-confirm").classList.remove("hidden");
      }

      async function handleLogin() {
        const n = document.getElementById("username-input").value.trim();
        if (n) {
          localStorage.setItem("chess_username", n);
          document.getElementById("user-display").innerText = n;
          showScreen("lobby");
          listenToLobby();
          loadHistory();
        }
      }

      function logout() {
        localStorage.removeItem("chess_username");
        location.reload();
      }

      function showScreen(id) {
        ["screen-login", "screen-lobby", "screen-game"].forEach((s) =>
          document.getElementById(s).classList.add("hidden")
        );
        document.getElementById("screen-" + id).classList.remove("hidden");
      }

      function handleStockfishMessage(e) {
        if (window.awaitingAI && e.data.startsWith("bestmove")) {
          window.awaitingAI = false;
          if (aiTimeout) clearTimeout(aiTimeout);
          chess.move(e.data.split(" ")[1], { sloppy: true });
          finalizeAIMove();
        }
        if (
          isAnalysisMode &&
          e.data.startsWith("info") &&
          e.data.includes("score cp")
        ) {
          const m = e.data.match(/score cp (-?\d+)/);
          if (m) {
            let cp = parseInt(m[1]);
            if (chess.turn() === "b") cp = -cp;
            const f = document.getElementById("eval-fill"),
              s = document.getElementById("eval-score");
            if (f)
              f.style.width = Math.max(5, Math.min(95, 50 + cp / 10)) + "%";
            if (s) s.innerText = (cp / 100).toFixed(2);
          }
        }
        if (isAnalysisMode && e.data.startsWith("bestmove")) {
          const el = document.getElementById("best-move-text");
          if (el) el.innerText = "Saran: " + e.data.split(" ")[1];
        }
      }

      // ==========================================
      // 3. CORE LOGIC
      // ==========================================

      function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        if (isAnalysisMode || selectedTime === -1) return;
        if (!isAI && (!gameData || gameData.status !== "playing")) return;

        lastTimestamp = Date.now();

        timerInterval = setInterval(() => {
          if (!isAI && (!gameData || !gameData.lastMove)) {
            if (gameData && gameData.whiteTime) {
              whiteTime = gameData.whiteTime;
              blackTime = gameData.blackTime;
              updateTimerDisplay();
            }
            return;
          }

          const now = Date.now();
          const delta = Math.floor((now - lastTimestamp) / 1000);

          if (delta >= 1) {
            if (chess.turn() === "w") whiteTime -= 1;
            else blackTime -= 1;
            lastTimestamp = now;

            if (!isAI && gameData) {
              const myColor = playerColor.charAt(0);
              if (chess.turn() !== myColor) {
                if (myColor === "w") whiteTime = gameData.whiteTime;
                else blackTime = gameData.blackTime;
              }
            }
            updateTimerDisplay();
          }

          if (whiteTime <= 0) handleFlagFall("white");
          if (blackTime <= 0) handleFlagFall("black");
        }, 1000);
      }

      async function pushMoveToFirestore() {
        if (!currentGameId) return;
        const now = Date.now();
        let sentWhiteTime = whiteTime;
        let sentBlackTime = blackTime;

        if (!gameData.lastMove) {
          const limit = (gameData.timeControl || 10) * 60;
          sentWhiteTime = limit;
          sentBlackTime = limit;
          whiteTime = limit;
          blackTime = limit;
        }

        await db
          .collection("artifacts")
          .doc(appId)
          .collection("public")
          .doc("data")
          .collection("games")
          .doc(currentGameId)
          .update({
            fen: chess.fen(),
            pgn: chess.pgn(),
            lastMove: { t: now },
            whiteTime: sentWhiteTime,
            blackTime: sentBlackTime,
          });
        checkGameOver(true);
      }

      function animateMovePiece(from, to, callback) {
        const fromSquareDiv = document.querySelector(`[data-square="${from}"]`);
        const toSquareDiv = document.querySelector(`[data-square="${to}"]`);
        if (!fromSquareDiv || !toSquareDiv) {
          callback();
          return;
        }
        const pieceDiv = fromSquareDiv.querySelector(".piece");
        if (!pieceDiv) {
          callback();
          return;
        }

        const clone = pieceDiv.cloneNode(true);
        const startRect = fromSquareDiv.getBoundingClientRect();
        const endRect = toSquareDiv.getBoundingClientRect();

        clone.style.position = "fixed";
        clone.style.left = startRect.left + "px";
        clone.style.top = startRect.top + "px";
        clone.style.width = startRect.width + "px";
        clone.style.height = startRect.height + "px";
        clone.style.zIndex = "9999";
        clone.style.pointerEvents = "none";
        clone.style.willChange = "transform";
        clone.style.transition = "transform 0.25s cubic-bezier(0.2, 1, 0.3, 1)";

        document.body.appendChild(clone);
        pieceDiv.style.opacity = "0";

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            const deltaX = endRect.left - startRect.left;
            const deltaY = endRect.top - startRect.top;
            clone.style.transform = `translate3d(${deltaX}px, ${deltaY}px, 0)`;
          });
        });

        setTimeout(() => {
          clone.remove();
          callback();
        }, 260);
      }

      function renderBoard() {
        const boardEl = document.getElementById("chess-board");
        if (!boardEl) return;
        boardEl.innerHTML =
          '<svg id="arrow-layer" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"></svg>';
        let boardState = chess.board();
        if (premoveQueue.length > 0) {
          premoveQueue.forEach((pm) => {
            const fC = pm.from.charCodeAt(0) - 97,
              fR = 8 - parseInt(pm.from[1]);
            const tC = pm.to.charCodeAt(0) - 97,
              tR = 8 - parseInt(pm.to[1]);
            if (boardState[fR][fC]) {
              boardState[tR][tC] = boardState[fR][fC];
              boardState[fR][fC] = null;
            }
          });
        }
        const rows =
          boardOrientation === "white"
            ? [0, 1, 2, 3, 4, 5, 6, 7]
            : [7, 6, 5, 4, 3, 2, 1, 0];
        const cols =
          boardOrientation === "white"
            ? [0, 1, 2, 3, 4, 5, 6, 7]
            : [7, 6, 5, 4, 3, 2, 1, 0];
        const lastMove = chess.history({ verbose: true }).pop();
        rows.forEach((r) => {
          cols.forEach((c) => {
            const square = String.fromCharCode(97 + c) + (8 - r);
            const piece = boardState[r][c];
            const div = document.createElement("div");
            div.className = `square ${(r + c) % 2 === 0 ? "white" : "black"}`;
            div.dataset.square = square;
            if (selectedSquare === square) div.classList.add("selected");
            if (
              lastMove &&
              (lastMove.from === square || lastMove.to === square)
            )
              div.classList.add("last-move");
            const pmIndex = premoveQueue.findIndex(
              (pm) => pm.from === square || pm.to === square
            );
            if (pmIndex !== -1) {
              const pm = premoveQueue[pmIndex];
              if (pm.from === square) div.classList.add("premove-source");
              if (pm.to === square) div.classList.add("premove-dest");
            }
            if (
              piece &&
              piece.type === "k" &&
              chess.in_check() &&
              piece.color === chess.turn() &&
              premoveQueue.length === 0
            )
              div.classList.add("in-check");
            if (circleHighlights.includes(square))
              div.classList.add("circle-highlight");
            if (
              selectedSquare &&
              !premoveQueue.length &&
              chess.turn() === playerColor.charAt(0)
            ) {
              const moves = chess.moves({
                square: selectedSquare,
                verbose: true,
              });
              if (moves.find((m) => m.to === square))
                div.classList.add("possible-move");
            }
            if (piece) {
              const img = document.createElement("div");
              img.className = "piece";
              if (
                premoveQueue.length > 0 &&
                premoveQueue.some((pm) => pm.to === square)
              )
                img.classList.add("premove-piece");
              img.style.backgroundImage = `url('${getPieceUrl(
                piece.color,
                piece.type
              )}')`;
              if (
                viewHistoryIndex === -1 &&
                (isAnalysisMode || piece.color === playerColor.charAt(0))
              )
                attachInputListeners(img, square);
              div.appendChild(img);
            }
            div.onclick = () => onSquareClick(square);
            if (!isMobile) {
              div.addEventListener("mousedown", (e) => {
                if (e.button === 2) handleRightClickDown(e, square);
              });
              div.addEventListener("mouseup", (e) => {
                if (e.button === 2) handleRightClickUp(e, square);
              });
              div.addEventListener("mouseenter", (e) =>
                handleRightClickMove(e, square)
              );
            }
            boardEl.appendChild(div);
          });
        });
        drawArrows();
        updateStatusText();
      }

      function setupGameCommon(id, o, n) {
        currentGameId = id;
        boardOrientation = o;
        playerColor = o;
        if (timerInterval) clearInterval(timerInterval);
        chess.reset();
        isAnalysisMode = false;
        premoveQueue = [];
        viewHistoryIndex = -1;
        selectedSquare = null;
        const elO = document.getElementById("opponent-name");
        const elM = document.getElementById("player-name-display");
        if (elO) elO.innerText = n;
        if (elM) elM.innerText = localStorage.getItem("chess_username");
        whiteTime = 0;
        blackTime = 0;
        updateTimerDisplay();
        showScreen("game");

        toggleGameOverControls(false); // Reset Tombol UI

        document.getElementById("analysis-controls").classList.add("hidden");
        renderBoard();
        updateMoveHistoryUI();
      }

      function startGameFirestore(id, o) {
        setupGameCommon(id, o, "Menunggu...");
        if (gameUnsubscribe) gameUnsubscribe();

        gameUnsubscribe = db
          .collection("artifacts")
          .doc(appId)
          .collection("public")
          .doc("data")
          .collection("games")
          .doc(id)
          .onSnapshot((doc) => {
            if (!doc.exists) return;
            gameData = doc.data();

            const opp = o === "white" ? gameData.black : gameData.white;
            if (document.getElementById("opponent-name"))
              document.getElementById("opponent-name").innerText = opp
                ? opp.name
                : "Menunggu...";
            if (gameData.timeControl) selectedTime = gameData.timeControl;

            const dbW = gameData.whiteTime;
            const dbB = gameData.blackTime;
            if (dbW !== undefined && dbB !== undefined) {
              if (playerColor === "white") blackTime = dbB;
              else whiteTime = dbW;
              if (Math.abs(whiteTime - dbW) > 2) whiteTime = dbW;
              if (Math.abs(blackTime - dbB) > 2) blackTime = dbB;
            }
            updateTimerDisplay();

            if (gameData.status === "playing") {
              if (
                gameData.fen &&
                gameData.fen !== chess.fen() &&
                gameData.fen !== "start"
              ) {
                const tempChess = new Chess();
                if (gameData.pgn) tempChess.load_pgn(gameData.pgn);
                else tempChess.load(gameData.fen);
                const lastMoveHistory = tempChess.history({ verbose: true });
                const lastMove = lastMoveHistory[lastMoveHistory.length - 1];

                if (lastMove) {
                  animateMovePiece(lastMove.from, lastMove.to, () => {
                    if (gameData.pgn) chess.load_pgn(gameData.pgn);
                    else chess.load(gameData.fen);
                    const realLast = chess.history({ verbose: true }).pop();
                    if (chess.in_check()) playSound("check");
                    else if (realLast.flags.includes("c")) playSound("capture");
                    else playSound("move");
                    renderBoard();
                    updateMoveHistoryUI();
                    if (isAI || gameData.lastMove) {
                      setTimeout(processPremoves, 100);
                    }
                  });
                } else {
                  if (gameData.pgn) chess.load_pgn(gameData.pgn);
                  else chess.load(gameData.fen);
                  renderBoard();
                  updateMoveHistoryUI();
                }
              }
              if (!timerInterval) startTimer();
            }

            if (gameData.status === "finished" && !isAnalysisMode) {
              let r = "draw";
              if (gameData.winner !== "draw")
                r =
                  gameData.winner === localStorage.getItem("chess_username")
                    ? "win"
                    : "loss";
              handleGameOver(r);
            }
            if (
              gameData.requests?.status === "pending" &&
              gameData.requests.sender !== currentUser.uid
            )
              showRequestModal(gameData.requests.type);
          });
      }

      function startGameLocal(id, o, n) {
        if (gameUnsubscribe) {
          gameUnsubscribe();
          gameUnsubscribe = null;
        }
        gameData = null;
        setupGameCommon(id, o, n);
        const t = selectedTime === -1 ? 999999 : selectedTime * 60;
        whiteTime = t;
        blackTime = t;
        updateTimerDisplay();
        playSound("start");
        if (o === "black") setTimeout(makeAIMove, 500);
        else startTimer();
      }

      function handleMoveAttempt(from, to) {
        if (isAnalysisMode) {
          if (chess.move({ from, to, promotion: "q" })) {
            renderBoard();
            updateMoveHistoryUI();
            playSound("move");
            if (stockfishWorker)
              stockfishWorker.postMessage("position fen " + chess.fen());
          }
          return;
        }
        const myColor = playerColor.charAt(0);
        const isSyncReady =
          isAI || (gameData && (gameData.lastMove || gameData.fen === "start"));

        if (chess.turn() === myColor && isSyncReady) {
          const move = chess.move({ from, to, promotion: "q" });
          if (move) {
            selectedSquare = null;
            animateMovePiece(from, to, () => {
              clearArrowsAndHighlights();
              renderBoard();
              updateMoveHistoryUI();
              if (chess.in_check()) playSound("check");
              else if (move.flags.includes("c")) playSound("capture");
              else playSound("move");
              if (isAI) {
                checkGameOver(true);
                setTimeout(makeAIMove, 500);
              } else {
                pushMoveToFirestore();
              }
            });
          } else {
            selectedSquare = null;
            renderBoard();
          }
        } else {
          const tempChess = new Chess(chess.fen());
          for (let pm of premoveQueue) {
            forceTurn(tempChess, myColor);
            tempChess.move({ from: pm.from, to: pm.to, promotion: "q" });
          }
          forceTurn(tempChess, myColor);
          if (tempChess.move({ from, to, promotion: "q" })) {
            premoveQueue.push({ from, to });
            selectedSquare = null;
            renderBoard();
            if (isSyncReady) setTimeout(processPremoves, 100);
          } else {
            selectedSquare = null;
            renderBoard();
          }
        }
      }

      function processPremoves() {
        if (premoveQueue.length === 0 || chess.game_over()) return;
        if (chess.turn() !== playerColor.charAt(0)) return;
        const isSyncReady =
          isAI || (gameData && (gameData.lastMove || gameData.fen === "start"));
        if (!isSyncReady) return;
        const moveData = premoveQueue[0];
        const move = chess.move({
          from: moveData.from,
          to: moveData.to,
          promotion: "q",
        });
        if (move) {
          premoveQueue.shift();
          animateMovePiece(moveData.from, moveData.to, () => {
            renderBoard();
            updateMoveHistoryUI();
            playSound("move");
            if (!isAI) {
              pushMoveToFirestore();
              setTimeout(processPremoves, 100);
            } else {
              setTimeout(makeAIMove, 500);
            }
          });
        } else {
          premoveQueue = [];
          playSound("check");
          renderBoard();
        }
      }

      function attachInputListeners(element, square) {
        element.addEventListener("mousedown", (e) => {
          if (e.button !== 0) return;
          e.preventDefault();
          initInput(e.clientX, e.clientY, square, element);
        });
        element.addEventListener(
          "touchstart",
          (e) => {
            const touch = e.touches[0];
            initInput(touch.clientX, touch.clientY, square, element);
          },
          { passive: false }
        );
      }
      function initInput(x, y, square, el) {
        if (!isAnalysisMode && viewHistoryIndex !== -1) return;
        isDragging = false;
        isClickCandidate = true;
        startX = x;
        startY = y;
        dragStartSquare = square;
        draggedPieceElement = el;
        const ghost = document.getElementById("drag-ghost");
        if (ghost) {
          ghost.style.backgroundImage = el.style.backgroundImage;
          ghost.style.left = x + "px";
          ghost.style.top = y + "px";
          ghost.style.display = "none";
        }
      }
      function handleGlobalMove(e) {
        if (!isClickCandidate && !isDragging) return;
        let clientX, clientY;
        if (e.type === "touchmove") {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }
        const diffX = Math.abs(clientX - startX),
          diffY = Math.abs(clientY - startY);
        if (!isDragging && (diffX > 5 || diffY > 5)) {
          isDragging = true;
          isClickCandidate = false;
          const ghost = document.getElementById("drag-ghost");
          if (ghost) ghost.style.display = "block";
        }
        if (isDragging) {
          if (e.cancelable && e.type === "touchmove") e.preventDefault();
          const ghost = document.getElementById("drag-ghost");
          if (ghost) {
            ghost.style.left = clientX + "px";
            ghost.style.top = clientY + "px";
          }
        }
      }
      function handleGlobalEnd(e) {
        const ghost = document.getElementById("drag-ghost");
        if (ghost) ghost.style.display = "none";
        if (isClickCandidate && !isDragging) {
          isClickCandidate = false;
          if (dragStartSquare) onSquareClick(dragStartSquare);
          dragStartSquare = null;
          return;
        }
        if (isDragging) {
          isDragging = false;
          isClickCandidate = false;
          let clientX, clientY;
          if (e.type === "touchend") {
            clientX = e.changedTouches[0].clientX;
            clientY = e.changedTouches[0].clientY;
          } else {
            clientX = e.clientX;
            clientY = e.clientY;
          }
          const elements = document.elementsFromPoint(clientX, clientY);
          const squareEl = elements.find((el) =>
            el.classList.contains("square")
          );
          if (squareEl) {
            const target = squareEl.dataset.square;
            if (target && target !== dragStartSquare)
              handleMoveAttempt(dragStartSquare, target);
            else onSquareClick(target);
          } else {
            selectedSquare = null;
            renderBoard();
          }
        }
        dragStartSquare = null;
      }
      function onSquareClick(square) {
        if (arrows.length > 0 || circleHighlights.length > 0)
          clearArrowsAndHighlights();
        const myColor = playerColor.charAt(0);
        const isMyTurn = chess.turn() === myColor;
        if (!isMyTurn && !isAnalysisMode) {
          if (selectedSquare) handleMoveAttempt(selectedSquare, square);
          else {
            const p = chess.get(square);
            if (p && p.color === myColor) {
              selectedSquare = square;
              renderBoard();
            } else {
              premoveQueue = [];
              selectedSquare = null;
              renderBoard();
            }
          }
          return;
        }
        if (selectedSquare === null) {
          const p = chess.get(square);
          if (p && (p.color === myColor || isAnalysisMode)) {
            selectedSquare = square;
            renderBoard();
          }
        } else {
          if (selectedSquare === square) {
            selectedSquare = null;
            renderBoard();
            return;
          }
          const p = chess.get(square);
          if (p && p.color === myColor && !isAnalysisMode) {
            selectedSquare = square;
            renderBoard();
            return;
          }
          handleMoveAttempt(selectedSquare, square);
        }
      }

      function forceTurn(chessInstance, color) {
        const t = chessInstance.fen().split(" ");
        t[1] = color;
        chessInstance.load(t.join(" "));
      }
      function updateTimerDisplay() {
        const fmt = (t) => {
          if (t < 0) t = 0;
          const m = Math.floor(t / 60),
            s = t % 60;
          return `${m}:${s < 10 ? "0" + s : s}`;
        };
        if (selectedTime === -1) {
          document.getElementById("timer-self").innerText = "âˆž";
          document.getElementById("timer-opponent").innerText = "âˆž";
          return;
        }
        const elS = document.getElementById("timer-self"),
          elO = document.getElementById("timer-opponent");
        if (playerColor === "white") {
          elS.innerText = fmt(whiteTime);
          elO.innerText = fmt(blackTime);
        } else {
          elS.innerText = fmt(blackTime);
          elO.innerText = fmt(whiteTime);
        }
        const turn = chess.turn();
        const selfTurn =
          (playerColor === "white" && turn === "w") ||
          (playerColor === "black" && turn === "b");
        if (selfTurn) {
          elS.classList.add("timer-active");
          elO.classList.remove("timer-active");
        } else {
          elO.classList.add("timer-active");
          elS.classList.remove("timer-active");
        }
      }
      function handleRightClickDown(e, s) {
        if (!s) return;
        isRightClicking = true;
        rightClickStart = s;
        rightClickCurrent = s;
      }
      function handleRightClickMove(e, s) {
        if (isRightClicking && s) {
          rightClickCurrent = s;
          if (s !== rightClickStart) drawArrows();
        }
      }
      function handleRightClickUp(e, s) {
        if (!isRightClicking) return;
        isRightClicking = false;
        rightClickCurrent = null;
        if (rightClickStart === s) {
          const i = circleHighlights.indexOf(s);
          if (i > -1) circleHighlights.splice(i, 1);
          else circleHighlights.push(s);
        } else if (s) {
          const i = arrows.findIndex(
            (a) => a.from === rightClickStart && a.to === s
          );
          if (i > -1) arrows.splice(i, 1);
          else arrows.push({ from: rightClickStart, to: s });
        }
        rightClickStart = null;
        renderBoard();
      }
      function clearArrowsAndHighlights() {
        arrows = [];
        circleHighlights = [];
        renderBoard();
      }
      function drawArrows() {
        const svg = document.getElementById("arrow-layer");
        if (!svg) return;
        svg.innerHTML = "";
        const getC = (s) => {
          const c = s.charCodeAt(0) - 97,
            r = 8 - parseInt(s[1]);
          return {
            x: (boardOrientation === "white" ? c : 7 - c) * 12.5 + 6.25,
            y: (boardOrientation === "white" ? r : 7 - r) * 12.5 + 6.25,
          };
        };
        arrows.forEach((a) =>
          renderArrowSvg(svg, getC(a.from), getC(a.to), "#f57c00", 0.8)
        );
        if (
          isRightClicking &&
          rightClickStart &&
          rightClickCurrent &&
          rightClickStart !== rightClickCurrent
        )
          renderArrowSvg(
            svg,
            getC(rightClickStart),
            getC(rightClickCurrent),
            "#f57c00",
            0.5
          );
      }
      function renderArrowSvg(svg, s, e, c, o = 0.8) {
        const ang = Math.atan2(e.y - s.y, e.x - s.x),
          dist = Math.hypot(e.x - s.x, e.y - s.y);
        if (dist < 5) return;
        const lw = 1.2,
          hl = 3.5,
          hw = 3.5,
          endX = e.x - hl * 0.1 * Math.cos(ang),
          endY = e.y - hl * 0.1 * Math.sin(ang),
          id = `a-${Math.random().toString(36).substr(2)}`;
        const d = document.createElementNS(
            "http://www.w3.org/2000/svg",
            "defs"
          ),
          m = document.createElementNS("http://www.w3.org/2000/svg", "marker");
        m.setAttribute("id", id);
        m.setAttribute("markerWidth", hl);
        m.setAttribute("markerHeight", hw);
        m.setAttribute("refX", hl);
        m.setAttribute("refY", hw / 2);
        m.setAttribute("orient", "auto");
        const p = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path"
        );
        p.setAttribute("d", `M0,0 L${hl},${hw / 2} L0,${hw} Z`);
        p.setAttribute("fill", c);
        p.setAttribute("fill-opacity", o);
        m.appendChild(p);
        d.appendChild(m);
        svg.appendChild(d);
        const l = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "line"
        );
        l.setAttribute("x1", s.x);
        l.setAttribute("y1", s.y);
        l.setAttribute("x2", endX);
        l.setAttribute("y2", endY);
        l.setAttribute("stroke", c);
        l.setAttribute("stroke-width", lw);
        l.setAttribute("stroke-opacity", o);
        l.setAttribute("marker-end", `url(#${id})`);
        svg.appendChild(l);
      }
      function makeAIMove() {
        if (chess.game_over() || chess.in_threefold_repetition()) return;
        document.getElementById("game-status").innerText = "AI Berpikir...";
        if (stockfishWorker) {
          stockfishWorker.postMessage("position fen " + chess.fen());
          stockfishWorker.postMessage(
            "setoption name Skill Level value " + aiLevel
          );
          stockfishWorker.postMessage("go depth " + (aiLevel > 10 ? 10 : 5));
          window.awaitingAI = true;
          if (aiTimeout) clearTimeout(aiTimeout);
          aiTimeout = setTimeout(() => {
            if (window.awaitingAI) {
              window.awaitingAI = false;
              const m = chess.moves();
              chess.move(m[Math.floor(Math.random() * m.length)]);
              finalizeAIMove();
            }
          }, 8000);
        } else {
          const m = chess.moves();
          chess.move(m[Math.floor(Math.random() * m.length)]);
          finalizeAIMove();
        }
      }
      function finalizeAIMove() {
        const lastMove = chess.history({ verbose: true }).pop();
        if (lastMove) {
          chess.undo();
          renderBoard();
          chess.move(lastMove);
          animateMovePiece(lastMove.from, lastMove.to, () => {
            renderBoard();
            updateMoveHistoryUI();
            if (chess.in_check()) playSound("check");
            else playSound("move");
            checkGameOver(true);
            if (chess.turn() === playerColor.charAt(0)) startTimer();
            document.getElementById("game-status").innerText = "";
            setTimeout(processPremoves, 200);
          });
        } else {
          renderBoard();
          updateMoveHistoryUI();
          if (chess.in_check()) playSound("check");
          else playSound("move");
          checkGameOver(true);
          if (chess.turn() === playerColor.charAt(0)) startTimer();
          document.getElementById("game-status").innerText = "";
          setTimeout(processPremoves, 200);
        }
      }
      async function handleFlagFall(c) {
        clearInterval(timerInterval);
        const myColor = playerColor.charAt(0) === "w" ? "white" : "black";
        const res = c === myColor ? "loss" : "win";
        handleGameOver(res);
        if (!isAI && currentGameId) {
          const w =
            c === "white"
              ? gameData.black?.name || "Black"
              : gameData.white?.name || "White";
          await db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .update({ status: "finished", winner: w, reason: "timeout" });
        }
      }
      function openCreateGameModal(t) {
        windowPendingGameType = t;
        document.getElementById("modal-create").classList.remove("hidden");
        document
          .getElementById("ai-settings")
          .classList.toggle("hidden", t !== "ai");
        selectTime(10);
        selectColor("random");
      }
      function selectColor(c) {
        selectedColor = c;
        ["white", "random", "black"].forEach((x) =>
          document
            .getElementById(`btn-color-${x}`)
            .classList.toggle("selected", x === c)
        );
      }
      function selectTime(t) {
        selectedTime = t;
        [1, 3, 5, 10, 30, -1].forEach((x) =>
          document
            .getElementById(`btn-time-${x}`)
            .classList.toggle("selected", x === t)
        );
      }
      function confirmCreateGame() {
        if (windowPendingGameType === "ai")
          aiLevel = document.getElementById("ai-elo").value;
        document.getElementById("modal-create").classList.add("hidden");
        createGameExec(windowPendingGameType);
      }
      function listenToLobby() {
        db.collection("artifacts")
          .doc(appId)
          .collection("public")
          .doc("data")
          .collection("games")
          .where("status", "==", "waiting")
          .limit(50)
          .onSnapshot((snap) => {
            const listEl = document.getElementById("room-list");
            if (!listEl) return;
            listEl.innerHTML = "";
            if (snap.empty) {
              listEl.innerHTML =
                '<div class="text-center text-stone-500 py-4 text-xs italic">Belum ada tantangan.</div>';
              return;
            }
            let games = [];
            const now = Date.now();
            snap.forEach((doc) => {
              const d = doc.data();
              if (!d.createdAt) return;
              if (
                now - d.createdAt.toMillis() > 3600000 ||
                (d.white && d.black)
              ) {
                db.collection("artifacts")
                  .doc(appId)
                  .collection("public")
                  .doc("data")
                  .collection("games")
                  .doc(doc.id)
                  .delete()
                  .catch(() => {});
                return;
              }
              games.push({ id: doc.id, ...d });
            });
            games.sort(
              (a, b) =>
                (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)
            );
            games.forEach((g) => {
              if (
                g.white?.id === currentUser?.uid ||
                g.black?.id === currentUser?.uid
              )
                return;
              const hostName = g.white
                ? g.white.name
                : g.black
                ? g.black.name
                : "Unknown";
              const time = g.timeControl === -1 ? "âˆž" : g.timeControl;
              const div = document.createElement("div");
              div.className =
                "bg-[#2b1d0e] p-3 rounded flex justify-between items-center border border-[#5d4037] mb-2 hover:border-yellow-600 transition";
              div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-[#1a0f00] flex items-center justify-center border border-[#5d4037]"><i class="fas ${
                g.white
                  ? "fa-chess-king text-[#e6d2b5]"
                  : "fa-chess-king text-black"
              }"></i></div><div><span class="block text-sm font-bold text-[#c5a059] font-medieval">${hostName}</span><span class="text-[10px] text-stone-500">${time} Menit</span></div></div><button onclick="joinGame('${
                g.id
              }', this)" class="medieval-btn px-4 py-1.5 rounded text-xs shadow-lg"><i class="fas fa-swords mr-1"></i> LAWAN</button>`;
              listEl.appendChild(div);
            });
          });
      }
      function loadHistory() {
        const histList = document.getElementById("history-list");
        if (!histList) return;
        const history = JSON.parse(
          localStorage.getItem("chess_history") || "[]"
        );
        histList.innerHTML = "";
        if (history.length === 0) {
          histList.innerHTML =
            '<div class="text-center text-stone-500 py-4 text-xs italic">Belum ada jejak pertempuran.</div>';
          return;
        }
        history
          .reverse()
          .slice(0, 10)
          .forEach((game) => {
            const el = document.createElement("div");
            const color =
              game.result === "win"
                ? "text-green-500"
                : game.result === "loss"
                ? "text-red-500"
                : "text-yellow-500";
            el.className =
              "bg-[#2b1d0e] p-3 rounded text-xs mb-2 border border-[#5d4037] flex justify-between items-center cursor-pointer hover:border-yellow-600 transition";
            el.innerHTML = `<div class="flex flex-col"><span class="text-[#c5a059] font-bold">vs ${
              game.opponent
            }</span><span class="text-[10px] text-stone-500">${new Date(
              game.date
            ).toLocaleDateString()}</span></div><span class="${color} font-bold uppercase border border-stone-600 px-2 py-1 rounded bg-black/30">${
              game.result
            }</span>`;
            el.onclick = () => loadReplayGame(game);
            histList.appendChild(el);
          });
      }
      function loadReplayGame(game) {
        currentGameId = null;
        isReplayMode = true;
        isAnalysisMode = true;
        boardOrientation = "white";
        if (!game.pgn) return alert("Arsip rusak.");
        chess.load_pgn(game.pgn);
        viewHistoryIndex = -1;
        document.getElementById("opponent-name").innerText = game.opponent;
        showScreen("game");

        toggleGameOverControls(true); // Tampilkan menu analisis

        document.getElementById("analysis-controls").classList.remove("hidden");
        renderBoard();
        updateMoveHistoryUI();
        if (stockfishWorker) {
          stockfishWorker.postMessage("position fen " + chess.fen());
          stockfishWorker.postMessage("go depth 15");
        }
      }
      async function createGameExec(type) {
        if (!currentUser) return alert("Koneksi terputus!");
        try {
          const gameId = currentUser.uid + "_" + Date.now();
          const myName = localStorage.getItem("chess_username");
          let white = null,
            black = null,
            orient = "white";
          if (selectedColor === "random")
            selectedColor = Math.random() < 0.5 ? "white" : "black";
          if (selectedColor === "white") {
            white = { name: myName, id: currentUser.uid };
            orient = "white";
          } else {
            black = { name: myName, id: currentUser.uid };
            orient = "black";
          }
          const initialSeconds =
            selectedTime === -1 ? 999999 : selectedTime * 60;
          if (type === "ai") {
            isAI = true;
            const aiName = `Stockfish (Lv.${aiLevel})`;
            if (orient === "white") black = { name: aiName, id: "ai" };
            else white = { name: aiName, id: "ai" };
            startGameLocal(gameId, orient, aiName);
          } else {
            isAI = false;
            await db
              .collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(gameId)
              .set({
                white,
                black,
                fen: "start",
                pgn: "",
                status: "waiting",
                timeControl: selectedTime,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                requests: {},
                whiteTime: initialSeconds,
                blackTime: initialSeconds,
                lastMove: null,
              });
            startGameFirestore(gameId, orient);
          }
        } catch (e) {
          alert(e.message);
        }
      }
      async function joinGame(id) {
        isAI = false;
        try {
          const gameRef = db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(id);
          const doc = await gameRef.get();
          if (!doc.exists) return alert("Room hilang!");
          const d = doc.data();
          let updateData = { status: "playing" };
          if (d.whiteTime === undefined) {
            const limit = d.timeControl === -1 ? 999999 : d.timeControl * 60;
            updateData.whiteTime = limit;
            updateData.blackTime = limit;
          }
          const myName = localStorage.getItem("chess_username");
          let myColor = "";
          if (!d.white) {
            updateData.white = { name: myName, id: currentUser.uid };
            myColor = "white";
          } else if (!d.black) {
            updateData.black = { name: myName, id: currentUser.uid };
            myColor = "black";
          } else return alert("Penuh!");
          await gameRef.update(updateData);
          startGameFirestore(id, myColor);
        } catch (e) {
          alert(e.message);
        }
      }
      function checkGameOver(l) {
        if (chess.game_over() || chess.in_threefold_repetition()) {
          let r = "draw";
          if (chess.in_checkmate())
            r = chess.turn() === playerColor.charAt(0) ? "loss" : "win";
          if (chess.in_threefold_repetition()) r = "draw";
          handleGameOver(r);
          if (l && !isAI)
            db.collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                status: "finished",
                winner:
                  r === "win"
                    ? localStorage.getItem("chess_username")
                    : r === "draw"
                    ? "draw"
                    : document.getElementById("opponent-name").innerText,
              });
        }
      }
      function handleGameOver(res) {
        clearInterval(timerInterval);
        document.getElementById("go-title").innerText =
          res === "win"
            ? "KEMENANGAN!"
            : res === "loss"
            ? "KEKALAHAN"
            : "REMIS";
        document.getElementById("go-message").innerText =
          res === "win"
            ? "Musuh tumbang."
            : res === "loss"
            ? "Istana runtuh."
            : "Posisi Seimbang (Draw).";
        document.getElementById("modal-gameover").classList.remove("hidden");

        toggleGameOverControls(true); // Aktifkan tombol analisis/rematch

        playSound("end");
        const h = JSON.parse(localStorage.getItem("chess_history") || "[]");
        const o = document.getElementById("opponent-name").innerText;
        if (
          !h.length ||
          Date.now() - new Date(h[h.length - 1].date).getTime() > 5000
        ) {
          h.push({
            date: new Date().toISOString(),
            opponent: o,
            result: res,
            pgn: chess.pgn(),
          });
          localStorage.setItem("chess_history", JSON.stringify(h));
        }
      }
      function showRequestModal(t) {
        document.getElementById("req-title").innerText =
          t === "takeback" ? "Minta Mundur" : "Tawaran Remis";
        document.getElementById("req-message").innerText =
          "Lawan meminta persetujuan.";
        document.getElementById("modal-request").classList.remove("hidden");
      }
      async function reqTakeback() {
        if (isAI) {
          chess.undo();
          chess.undo();
          renderBoard();
          updateMoveHistoryUI();
          playSound("notify");
          return;
        }
        showModalConfirm("MUNDUR?", "Minta mundur ke lawan?", async () => {
          await db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .update({
              requests: {
                type: "takeback",
                sender: currentUser.uid,
                status: "pending",
              },
            });
        });
      }
      async function reqDraw() {
        showModalConfirm("REMIS?", "Ajukan remis?", async () => {
          await db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .update({
              requests: {
                type: "draw",
                sender: currentUser.uid,
                status: "pending",
              },
            });
        });
      }
      function confirmResign() {
        if (
          document.getElementById("game-status").innerText === "Menunggu..."
        ) {
          db.collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .delete();
          exitGame();
          return;
        }
        showModalConfirm("MENYERAH?", "YAKIN?", () => {
          handleGameOver("loss");
          if (!isAI)
            db.collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                status: "finished",
                winner: document.getElementById("opponent-name").innerText,
              });
        });
      }
      async function respondRequest(acc) {
        document.getElementById("modal-request").classList.add("hidden");
        if (acc) {
          if (gameData.requests.type === "takeback") {
            const t = new Chess();
            t.load_pgn(chess.pgn());
            t.undo();
            if (
              t.turn() !==
              (gameData.requests.sender === gameData.white.id ? "w" : "b")
            )
              t.undo();
            await db
              .collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                fen: t.fen(),
                pgn: t.pgn(),
                requests: { status: "accepted" },
              });
          } else if (gameData.requests.type === "draw") {
            await db
              .collection("artifacts")
              .doc(appId)
              .collection("public")
              .doc("data")
              .collection("games")
              .doc(currentGameId)
              .update({
                status: "finished",
                winner: "draw",
                requests: { status: "accepted" },
              });
          }
        } else {
          await db
            .collection("artifacts")
            .doc(appId)
            .collection("public")
            .doc("data")
            .collection("games")
            .doc(currentGameId)
            .update({ requests: { status: "rejected" } });
        }
      }
      function updateStatusText() {
        const el = document.getElementById("turn-indicator");
        if (!el) return;
        if (viewHistoryIndex !== -1) {
          el.innerText = "REPLAY";
          el.className = "text-xs font-bold text-yellow-500";
          return;
        }
        if (chess.turn() === boardOrientation.charAt(0)) {
          el.innerText = "GILIRAN ANDA";
          el.className = "text-xs font-bold text-green-400 animate-pulse";
        } else {
          el.innerText = "GILIRAN LAWAN";
          el.className = "text-xs font-bold text-slate-500";
        }
        const statusEl = document.getElementById("game-status");
        if (statusEl) statusEl.innerText = chess.in_check() ? "SKAK!" : "";
      }

      // ==========================================
      // 4. MAIN INIT & UI HELPERS
      // ==========================================

      async function initApp() {
        // Load Stockfish Worker
        fetch(
          "https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js"
        )
          .then((r) => r.blob())
          .then((b) => {
            stockfishWorker = new Worker(URL.createObjectURL(b));
            stockfishWorker.onmessage = handleStockfishMessage;
            console.log("AI Ready");
          })
          .catch((e) => console.warn("AI Load Error: " + e.message));

        const s = localStorage.getItem("chess_username");
        if (s) document.getElementById("username-input").value = s;

        auth.onAuthStateChanged((u) => {
          if (u) {
            currentUser = u;
            updateConnectionStatus(true);
            if (
              s &&
              !document
                .getElementById("screen-login")
                .classList.contains("hidden")
            )
              handleLogin();
          } else {
            updateConnectionStatus(false);
            auth
              .signInAnonymously()
              .catch((e) => console.error("Auth Fail", e));
          }
        });

        document.addEventListener("mouseup", handleGlobalEnd);
        document.addEventListener("touchend", handleGlobalEnd);
        document.addEventListener("mousemove", handleGlobalMove);
        document.addEventListener("touchmove", handleGlobalMove, {
          passive: false,
        });

        document.addEventListener("contextmenu", (e) => {
          if (e.target.tagName !== "INPUT") e.preventDefault();
        });
      }

      function updateMoveHistoryUI() {
        const tbody = document.getElementById("move-history");
        if (!tbody) return;

        tbody.innerHTML = "";
        const history = chess.history();
        for (let i = 0; i < history.length; i += 2) {
          const moveWhite = history[i];
          const moveBlack = history[i + 1] || "";
          const moveNumber = i / 2 + 1;
          const tr = document.createElement("tr");
          tr.className = "border-b border-[#3e2723] hover:bg-[#2b1d0e]";
          tr.innerHTML = `
            <td class="px-3 py-2 text-stone-500 w-10 border-r border-[#3e2723] text-center">${moveNumber}.</td>
            <td class="px-3 py-2 cursor-pointer hover:text-white font-bold text-[#e6d2b5]">${moveWhite}</td>
            <td class="px-3 py-2 cursor-pointer hover:text-white font-bold text-[#e6d2b5]">${moveBlack}</td>
        `;
          tbody.appendChild(tr);
        }
        if (viewHistoryIndex === -1) {
          const container = document.getElementById("pgn-container");
          if (container) container.scrollTop = container.scrollHeight;
        }
      }

      // UI Helpers untuk Toggle Tombol Game Over
      function toggleGameOverControls(isGameOver) {
        const mobilePlay = document.getElementById("mobile-play-controls");
        const mobilePost = document.getElementById("mobile-post-game-controls");
        const desktopPlay = document.getElementById("desktop-play-controls");
        const desktopPost = document.getElementById(
          "desktop-post-game-controls"
        );
        if (isGameOver) {
          mobilePlay.classList.add("hidden");
          mobilePost.classList.remove("hidden");
          mobilePost.classList.add("flex");
          desktopPlay.classList.add("hidden");
          desktopPost.classList.remove("hidden");
          desktopPost.classList.add("flex");
        } else {
          mobilePlay.classList.remove("hidden");
          mobilePost.classList.add("hidden");
          mobilePost.classList.remove("flex");
          desktopPlay.classList.remove("hidden");
          desktopPost.classList.add("hidden");
          desktopPost.classList.remove("flex");
        }
      }

      function startAnalysisFromModal() {
        closeModal("modal-gameover");
        isAnalysisMode = true;
        document.getElementById("play-controls")?.classList.add("hidden"); // Hide regular controls if exposed
        document.getElementById("analysis-controls").classList.remove("hidden");
        // Trigger Stockfish analysis on current position
        if (stockfishWorker) {
          stockfishWorker.postMessage("position fen " + chess.fen());
          stockfishWorker.postMessage("go depth 20");
        }
      }

      function exitGame() {
        // Stop timers and AI
        if (timerInterval) clearInterval(timerInterval);
        if (gameUnsubscribe) {
          gameUnsubscribe();
          gameUnsubscribe = null;
        }

        // Return to lobby
        showScreen("lobby");
        currentGameId = null;
        gameData = null;
        chess.reset();
      }

      function switchLobbyTab(tab) {
        document
          .querySelectorAll(".lobby-tab")
          .forEach((t) => t.classList.remove("active"));
        document.getElementById("tab-btn-" + tab).classList.add("active");

        if (tab === "arena") {
          document
            .getElementById("lobby-panel-arena")
            .classList.remove("hidden");
          document
            .getElementById("lobby-panel-history")
            .classList.add("hidden");
          document.getElementById("lobby-panel-arena").classList.add("flex");
        } else {
          document.getElementById("lobby-panel-arena").classList.add("hidden");
          document.getElementById("lobby-panel-arena").classList.remove("flex");
          document
            .getElementById("lobby-panel-history")
            .classList.remove("hidden");
          document.getElementById("lobby-panel-history").classList.add("flex");
        }
      }

      // Flip board visual only
      function flipBoard() {
        const boardEl = document.getElementById("chess-board");
        // Logic handled by re-rendering with different orientation global var?
        // Simple logic for visual flip:
        if (boardOrientation === "white") boardOrientation = "black";
        else boardOrientation = "white";
        renderBoard();
      }

      initApp();
    </script>
  </body>
</html>
